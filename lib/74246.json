{
  "comments": [
    "We are about to go production with AspectJ and Weblogic 8.1 with load time\nweaving. We used the initial AspectJ integration classes released by BEA and\ncleaned up a little bit to work with AspectJ 1.2. During our testing with Java\nSecurity Manager integration I am running into a problem. Initially I made the\nmistake of not giving the property read permission as well as temp file creation\nand once I got through that though I no longer any AccessControlExceptions but a\nsimple \"trouble in:\" messege in the console.\n\nWhat permissions do I need to give for AspectJ Runtime + AspectJ tools in\naddition to all System property read permission as well as temporary file creation?\n\nThanks in advance,\nVenkat.",
    "Could you append the console messages you get?",
    "I simply get a \"trouble in:\" each time the aspect is executed.  This is the\nexact string. There is no exception stack trace.",
    "Can yoiu define the following system property so that we can find out a little \nmore about what\u0027s happening:\n\n-Daj.weaving.verbose\u003dtrue",
    "I found what the problem is. BCEL\u0027s ClassPathManager tries looks at each path in\nthe system classpath for a class to be weaved until it finds the one. The only\nway this code can run under a JSM is to give a read FilePermission \u003c\u003cALL\nFILES\u003e\u003e. This may not be a good idea. Perhaps it can attempt to load this class\nthrough the getResourceAsStream mechanism which will go through the JSM without\nany additional permission.\n\nHere is a section of the stack trace to prove my point.\n\njava.security.AccessControlException: access denied (java.io.FilePermission\nC:\\aspectj-jsm-test\\appconfig\\bali\\appfw\\UserInfo.class read)\n        at\njava.security.AccessControlContext.checkPermission(AccessControlContext.java:269)\n        at java.security.AccessController.checkPermission(AccessController.java:401)\n        at java.lang.SecurityManager.checkPermission(SecurityManager.java:524)\n        at java.lang.SecurityManager.checkRead(SecurityManager.java:863)\n        at java.io.File.isFile(File.java:723)\n        at\norg.aspectj.weaver.bcel.ClassPathManager$DirEntry.find(ClassPathManager.java:136)\n        at org.aspectj.weaver.bcel.ClassPathManager.find(ClassPathManager.java:72)\n        at org.aspectj.weaver.bcel.BcelWorld.lookupJavaClass(BcelWorld.java:211)\n\nI am also attaching the full stack trace as it may help somebody else. Your\nthoughts please.",
    "Created an attachment (id\u003d14770)\nStack trace pointing to the need for \u003c\u003cALL FILES\u003e\u003e permission\n",
    "As you are investigating it ....",
    "I have used the following security policy. The need for \u003c\u003cALL FILES\u003e\u003e as well \nas some of the properties would be avoided by using getResourceAsStream() \nalthough we will also have to fix BCEL to catch security exceptions and use \nreasonable defaults as suggested for bug 74238.\n\nIt\u0027s a shame the supplies Java 2 SecurityManager doesn\u0027t allow a class to read \na property that has the same name as its package e.g. classes in \norg.aspectj.weaver.tools could read properties \"org.aspectj.weaver.tools.*\". \nAs an alternative we could allow users to safely configure the weaver by \nloading a properties file from classpath in the way we load the Xlint defaults.\n\ngrant { \n\n\t// Needed by weaver for bytecode loading\n\tpermission java.io.FilePermission \"\u003c\u003cALL FILES\u003e\u003e\", \"read\";\n\n\t// Needed by BCEL\n\tpermission java.util.PropertyPermission \"java.class.path\", \"read\";\n\tpermission java.util.PropertyPermission \"java.ext.dirs\", \"read\";\n\tpermission java.util.PropertyPermission \"JavaClass.*\", \"read\";\n\n\t// Needed by org.aspectj.weaver.tools.WeavingAdaptor\n\tpermission java.util.PropertyPermission \"sun.boot.class.path\", \"read\";\n\n\t// Needed to configure org.aspectj.weaver.WeavingURLClassLoader\n\tpermission java.util.PropertyPermission \"aj.*\", \"read\";\n\n\t// Needed by weaving class loader\n\tpermission java.lang.RuntimePermission \"createClassLoader\";\n\tpermission java.lang.RuntimePermission \"getClassLoader\";\n};\n\n",
    "We should doc this info !",
    "*** Bug 159856 has been marked as a duplicate of this bug. ***",
    "Using -Djava.security.debug\u003daccess:failure (http://java.sun.com/j2se/1.4.2/docs/guide/plugin/developer_guide/debugger.html) I have identified that \u003c\u003cALL FILES\u003e\u003e also seems to be needed by ClassLoader.getResources() when looking for aop.xml fiels:\n\n     [java] 16:35:40.341 main - org.aspectj.weaver.loadtime.ClassLoaderWeavingAdaptor.parseDefinitions org.aspectj.weaver.loadtime.ClassLoaderWeavingAdaptor@50d89c org/aspectj/weaver/loadtime/aop.xml;META-INF/aop-ajc.xml\n     ...\n     [java] access: access denied (java.io.FilePermission \\C:\\temp\\ajcSandbox\\org.aspectj\\ajcTest47118.tmp\\META-INF\\aop-ajc.xml read)\n     [java] java.lang.Exception: Stack trace\n     [java] \tat java.lang.Thread.dumpStack(Thread.java:1158)\n     [java] \tat java.security.AccessControlContext.checkPermission(AccessControlContext.java:253)\n     [java] \tat java.security.AccessController.checkPermission(AccessController.java:427)\n     [java] \tat java.lang.SecurityManager.checkPermission(SecurityManager.java:532)\n     [java] \tat java.lang.SecurityManager.checkRead(SecurityManager.java:871)\n     [java] \tat sun.misc.URLClassPath.check(URLClassPath.java:407)\n     [java] \tat sun.misc.URLClassPath.checkURL(URLClassPath.java:381)\n     [java] \tat java.net.URLClassLoader$3.next(URLClassLoader.java:400)\n     [java] \tat java.net.URLClassLoader$3.hasMoreElements(URLClassLoader.java:415)\n     [java] \tat sun.misc.CompoundEnumeration.next(CompoundEnumeration.java:27)\n     [java] \tat sun.misc.CompoundEnumeration.hasMoreElements(CompoundEnumeration.java:36)\n     [java] \tat org.aspectj.weaver.loadtime.ClassLoaderWeavingAdaptor.parseDefinitions(ClassLoaderWeavingAdaptor.java:209)\n     [java] \tat org.aspectj.weaver.loadtime.ClassLoaderWeavingAdaptor.initialize(ClassLoaderWeavingAdaptor.java:134)\n     [java] \tat org.aspectj.weaver.loadtime.Aj$ExplicitlyInitializedClassLoaderWeavingAdaptor.initialize(Aj.java:148)\n     [java] \tat org.aspectj.weaver.loadtime.Aj$ExplicitlyInitializedClassLoaderWeavingAdaptor.getWeavingAdaptor(Aj.java:153)\n     [java] \tat org.aspectj.weaver.loadtime.Aj$WeaverContainer.getWeaver(Aj.java:119)\n     [java] \tat org.aspectj.weaver.loadtime.Aj.preProcess(Aj.java:72)\n     [java] \tat org.aspectj.weaver.loadtime.ClassPreProcessorAgentAdapter.transform(ClassPreProcessorAgentAdapter.java:55)\n     [java] \tat sun.instrument.TransformerManager.transform(TransformerManager.java:122)\n     [java] \tat sun.instrument.InstrumentationImpl.transform(InstrumentationImpl.java:155)\n     [java] \tat java.lang.ClassLoader.defineClass1(Native Method)\n     [java] \tat java.lang.ClassLoader.defineClass(ClassLoader.java:620)\n     [java] \tat java.security.SecureClassLoader.defineClass(SecureClassLoader.java:124)\n     [java] \tat java.net.URLClassLoader.defineClass(URLClassLoader.java:260)\n     [java] \tat java.net.URLClassLoader.access$100(URLClassLoader.java:56)\n     [java] \tat java.net.URLClassLoader$1.run(URLClassLoader.java:195)\n     [java] \tat java.security.AccessController.doPrivileged(Native Method)\n     [java] \tat java.net.URLClassLoader.findClass(URLClassLoader.java:188)\n     [java] \tat java.lang.ClassLoader.loadClass(ClassLoader.java:306)\n     [java] \tat sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:268)\n     [java] \tat java.lang.ClassLoader.loadClass(ClassLoader.java:251)\n     [java] \tat java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)\n     ...\n     [java] 16:35:40.622 main I [AppClassLoader@7ced01] info no configuration found. Disabling weaver for class loader sun.misc.Launcher$AppClassLoader@7ced01\n\nEven using org/aspectj/weaver/loadtime/aop.xml fails.\n\nWe also need to grant permissions to support reflection delegates:\n\n     [java] 16:43:30.488 main \u003e org.aspectj.weaver.loadtime.ClassLoaderWeavingAdaptor.registerAspects org.aspectj.weaver.loadtime.ClassLoaderWeavingAdaptor@50d89c org.aspectj.weaver.bcel.BcelWeaver@a4e2e3, sun.misc.Launcher$AppClassLoader@7ced01, java.util.ArrayList(2)\n     [java] 16:43:30.488 main I [AppClassLoader@7ced01] info register aspect Aspect\n     [java] 16:43:30.488 main \u003e org.aspectj.weaver.bcel.BcelWeaver.addLibraryAspect org.aspectj.weaver.bcel.BcelWeaver@a4e2e3 Aspect\n     [java] 16:43:31.329 main - org.aspectj.weaver.bcel.BcelWorld.lookupJavaClass org.aspectj.weaver.ltw.LTWWorld@bd928a Aspect, org.aspectj.apache.bcel.classfile.JavaClass@1c56c60\n     [java] 16:43:33.141 main E register definition failed java.security.AccessControlException: access denied (java.lang.RuntimePermission accessDeclaredMembers)\n     [java] java.security.AccessControlException: access denied (java.lang.RuntimePermission accessDeclaredMembers)\n     [java] \tat java.security.AccessControlContext.checkPermission(AccessControlContext.java:264)\n     [java] \tat java.security.AccessController.checkPermission(AccessController.java:427)\n     [java] \tat java.lang.SecurityManager.checkPermission(SecurityManager.java:532)\n     [java] \tat java.lang.SecurityManager.checkMemberAccess(SecurityManager.java:1662)\n     [java] \tat java.lang.Class.checkMemberAccess(Class.java:2125)\n     [java] \tat java.lang.Class.getDeclaredMethods(Class.java:1762)\n     [java] \tat org.aspectj.internal.lang.reflect.AjTypeImpl.getDeclaredMethods(AjTypeImpl.java:333)\n     [java] \tat org.aspectj.weaver.reflect.Java15ReflectionBasedReferenceTypeDelegate.getDeclaredMethods(Java15ReflectionBasedReferenceTypeDelegate.java:171)\n     [java] \tat org.aspectj.weaver.ReferenceType.getDeclaredMethods(ReferenceType.java:516)\n     [java] \tat org.aspectj.weaver.ResolvedType.getDeclaredAdvice(ResolvedType.java:703)\n     [java] \tat org.aspectj.weaver.ResolvedType.getDeclaredShadowMungers(ResolvedType.java:740)\n     [java] \tat org.aspectj.weaver.ResolvedType.collectShadowMungers(ResolvedType.java:576)\n     [java] \tat org.aspectj.weaver.ResolvedType.collectCrosscuttingMembers(ResolvedType.java:505)\n     [java] \tat org.aspectj.weaver.CrosscuttingMembersSet.addOrReplaceAspect(CrosscuttingMembersSet.java:79)\n     [java] \tat org.aspectj.weaver.CrosscuttingMembersSet.addOrReplaceAspect(CrosscuttingMembersSet.java:66)\n     [java] \tat org.aspectj.weaver.bcel.BcelWeaver.addLibraryAspect(BcelWeaver.java:200)\n     [java] \tat org.aspectj.weaver.loadtime.ClassLoaderWeavingAdaptor.registerAspects(ClassLoaderWeavingAdaptor.java:401)\n     [java] \tat org.aspectj.weaver.loadtime.ClassLoaderWeavingAdaptor.registerDefinitions(ClassLoaderWeavingAdaptor.java:242)\n     [java] \tat org.aspectj.weaver.loadtime.ClassLoaderWeavingAdaptor.initialize(ClassLoaderWeavingAdaptor.java:153)\n     [java] \tat org.aspectj.weaver.loadtime.Aj$ExplicitlyInitializedClassLoaderWeavingAdaptor.initialize(Aj.java:148)\n     [java] \tat org.aspectj.weaver.loadtime.Aj$ExplicitlyInitializedClassLoaderWeavingAdaptor.getWeavingAdaptor(Aj.java:153)\n     [java] \tat org.aspectj.weaver.loadtime.Aj$WeaverContainer.getWeaver(Aj.java:119)\n     [java] \tat org.aspectj.weaver.loadtime.Aj.preProcess(Aj.java:72)\n     [java] \tat org.aspectj.weaver.loadtime.ClassPreProcessorAgentAdapter.transform(ClassPreProcessorAgentAdapter.java:55)\n     [java] \tat sun.instrument.TransformerManager.transform(TransformerManager.java:122)\n     [java] \tat sun.instrument.InstrumentationImpl.transform(InstrumentationImpl.java:155)\n     [java] \tat java.lang.ClassLoader.defineClass1(Native Method)\n     [java] \tat java.lang.ClassLoader.defineClass(ClassLoader.java:620)\n     [java] \tat java.security.SecureClassLoader.defineClass(SecureClassLoader.java:124)\n     [java] \tat java.net.URLClassLoader.defineClass(URLClassLoader.java:260)\n     [java] \tat java.net.URLClassLoader.access$100(URLClassLoader.java:56)\n     [java] \tat java.net.URLClassLoader$1.run(URLClassLoader.java:195)\n     [java] \tat java.security.AccessController.doPrivileged(Native Method)\n     [java] \tat java.net.URLClassLoader.findClass(URLClassLoader.java:188)\n     [java] \tat java.lang.ClassLoader.loadClass(ClassLoader.java:306)\n     [java] \tat sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:268)\n     [java] \tat java.lang.ClassLoader.loadClass(ClassLoader.java:251)\n     [java] \tat java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)\n     [java] 16:43:33.151 main W [AppClassLoader@7ced01] warning register definition failed -- (AccessControlException) access denied (java.lang.RuntimePermission accessDeclaredMembers)\n\nSo a revised policy might look like this:\n\ngrant { \n\n\t// Needed by weaver for bytecode loading\n\tpermission java.io.FilePermission \"\u003c\u003cALL FILES\u003e\u003e\", \"read\";\n\n\t// Needed by BCEL\n\tpermission java.util.PropertyPermission \"java.class.path\", \"read\";\n\tpermission java.util.PropertyPermission \"java.ext.dirs\", \"read\";\n\tpermission java.util.PropertyPermission \"JavaClass.*\", \"read\";\n\n\tpermission java.util.PropertyPermission \"org.aspectj.apache.bcel.useSharedCache\", \"read\";\n\n\t// Needed by org.aspectj.weaver.tools.WeavingAdaptor\n\tpermission java.util.PropertyPermission \"sun.boot.class.path\", \"read\";\n\tpermission java.util.PropertyPermission \"org.aspectj.weaver.*\", \"read\";\n\n\t// Needed to configure org.aspectj.weaver.WeavingURLClassLoader\n\tpermission java.util.PropertyPermission \"aj.*\", \"read\";\n\n\t// Needed to configure org.aspectj.weaver.tools.TraceFactory\n\tpermission java.util.PropertyPermission \"org.aspectj.tracing.*\", \"read\";\n\n\t// Needed by weaving class loader\n\tpermission java.lang.RuntimePermission \"createClassLoader\";\n\tpermission java.lang.RuntimePermission \"getClassLoader\";\n\n\t// Needed by Java15ReflectionBasedReferenceTypeDelegate\n\tpermission java.lang.RuntimePermission \"accessDeclaredMembers\";\n};\n"
  ],
  "commentCreationDates": [
    "2004-09-20T03:02:04+02:00",
    "2004-09-22T18:40:21+02:00",
    "2004-09-22T22:39:21+02:00",
    "2004-09-23T18:39:17+02:00",
    "2004-09-24T19:46:23+02:00",
    "2004-09-24T19:48:32+02:00",
    "2004-09-29T15:29:38+02:00",
    "2004-10-05T16:01:48+02:00",
    "2006-05-30T14:58:26+02:00",
    "2006-10-18T15:49:13+02:00",
    "2006-10-18T17:49:02+02:00"
  ],
  "traces": [
    {
      "exceptionType": "java.security.AccessControlException",
      "message": "access denied (java.io.FilePermission C:\\aspectj-jsm-test\\appconfig\\bali\\appfw\\UserInfo.class read)",
      "elements": [
        {
          "method": "java.security.AccessControlContext.checkPermission",
          "source": "AccessControlContext.java:269"
        },
        {
          "method": "java.security.AccessController.checkPermission",
          "source": "AccessController.java:401"
        },
        {
          "method": "java.lang.SecurityManager.checkPermission",
          "source": "SecurityManager.java:524"
        },
        {
          "method": "java.lang.SecurityManager.checkRead",
          "source": "SecurityManager.java:863"
        },
        {
          "method": "java.io.File.isFile",
          "source": "File.java:723"
        },
        {
          "method": "org.aspectj.weaver.bcel.ClassPathManager$DirEntry.find",
          "source": "ClassPathManager.java:136"
        },
        {
          "method": "org.aspectj.weaver.bcel.ClassPathManager.find",
          "source": "ClassPathManager.java:72"
        },
        {
          "method": "org.aspectj.weaver.bcel.BcelWorld.lookupJavaClass",
          "source": "BcelWorld.java:211"
        }
      ],
      "number": 0,
      "commentIndex": 4,
      "bugId": "74246",
      "date": "2004-09-24T19:46:23+02:00",
      "product": "AspectJ",
      "component": "Docs",
      "severity": "minor"
    },
    {
      "exceptionType": "java.lang.Exception",
      "message": "Stack trace      [java]",
      "elements": [
        {
          "method": "java.lang.Thread.dumpStack",
          "source": "Thread.java:1158"
        }
      ],
      "number": 1,
      "commentIndex": 10,
      "bugId": "74246",
      "date": "2006-10-18T17:49:02+02:00",
      "product": "AspectJ",
      "component": "Docs",
      "severity": "minor"
    },
    {
      "exceptionType": "java.security.AccessControlException",
      "message": "access denied (java.lang.RuntimePermission accessDeclaredMembers)      [java]",
      "elements": [
        {
          "method": "java.security.AccessControlContext.checkPermission",
          "source": "AccessControlContext.java:264"
        }
      ],
      "number": 2,
      "commentIndex": 10,
      "bugId": "74246",
      "date": "2006-10-18T17:49:02+02:00",
      "product": "AspectJ",
      "component": "Docs",
      "severity": "minor"
    }
  ],
  "groupId": "74246",
  "bugId": "74246",
  "date": "2004-09-20T03:02:04+02:00",
  "product": "AspectJ",
  "component": "Docs",
  "severity": "minor"
}