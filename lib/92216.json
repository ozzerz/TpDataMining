{
  "comments": [
    "We have a junit test that programmatically creates an empty .jsp file, opens it\nin an editor, manipulates the contents, and then closes the editor. Sometimes\nwhen closing the editor we are seeing an assertion error. It is coming from an\norg.eclipse.jface class, but this is a webtools structured document, and I\u0027m not\nsure where the problem is exactly.\n\nWe are closing all open editors by calling:\n\nPlatformUI.getWorkbench().getActiveWorkbenchWindow().getActivePage().closeAllEditors(false);\n\n\nI have only seen this happen in the context of a Junit test, we haven\u0027t been\nable to reproduce it manually. Even within the Junit tests it is inconsistent,\nit seems to fail more often on slower machines so it is probably some sort of\ntiming issue.\n\nWe are still running 3.1M5, we are waiting for a stable webtools build to move\nto M6.\n\n\nHere is the stacktrace:\n\norg.eclipse.jface.text.Assert$AssertionFailedException: Assertion failed: at\norg.eclipse.jface.text.Assert.isTrue(Assert.java:189) at\norg.eclipse.jface.text.Assert.isTrue(Assert.java:174) at\norg.eclipse.jface.text.source.AnnotationModel.disconnect(AnnotationModel.java:380)\nat org.eclipse.jface.text.source.SourceViewer.setDocument(SourceViewer.java:465)\nat\norg.eclipse.jface.text.source.projection.ProjectionViewer.setDocument(ProjectionViewer.java:369)\nat\norg.eclipse.wst.sse.ui.StructuredTextViewer.setDocument(StructuredTextViewer.java:1071)\nat org.eclipse.jface.text.source.SourceViewer.setDocument(SourceViewer.java:421)\nat org.eclipse.jface.text.TextViewer$1.widgetDisposed(TextViewer.java:1446) at\norg.eclipse.swt.widgets.TypedListener.handleEvent(TypedListener.java:100) at\norg.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:82) at\norg.eclipse.swt.widgets.Widget.sendEvent(Widget.java:842) at\norg.eclipse.swt.widgets.Widget.sendEvent(Widget.java:866) at\norg.eclipse.swt.widgets.Widget.sendEvent(Widget.java:847) at\norg.eclipse.swt.widgets.Widget.releaseWidget(Widget.java:754) at\norg.eclipse.swt.widgets.Control.releaseWidget(Control.java:1571) at\norg.eclipse.swt.widgets.Scrollable.releaseWidget(Scrollable.java:195) at\norg.eclipse.swt.widgets.Composite.releaseWidget(Composite.java:588) at\norg.eclipse.swt.widgets.Canvas.releaseWidget(Canvas.java:118) at\norg.eclipse.swt.widgets.Widget.releaseResources(Widget.java:719) at\norg.eclipse.swt.widgets.Composite.releaseChildren(Composite.java:582) at\norg.eclipse.swt.widgets.Composite.releaseWidget(Composite.java:587) at\norg.eclipse.swt.widgets.Canvas.releaseWidget(Canvas.java:118) at\norg.eclipse.swt.widgets.Widget.releaseResources(Widget.java:719) at\norg.eclipse.swt.widgets.Composite.releaseChildren(Composite.java:582) at\norg.eclipse.swt.widgets.Composite.releaseWidget(Composite.java:587) at\norg.eclipse.swt.widgets.Widget.releaseResources(Widget.java:719) at\norg.eclipse.swt.widgets.Composite.releaseChildren(Composite.java:582) at\norg.eclipse.swt.widgets.Composite.releaseWidget(Composite.java:587) at\norg.eclipse.swt.widgets.Widget.releaseResources(Widget.java:719) at\norg.eclipse.swt.widgets.Composite.releaseChildren(Composite.java:582) at\norg.eclipse.swt.widgets.Composite.releaseWidget(Composite.java:587) at\norg.eclipse.swt.widgets.Widget.releaseResources(Widget.java:719) at\norg.eclipse.swt.widgets.Composite.releaseChildren(Composite.java:582) at\norg.eclipse.swt.widgets.Composite.releaseWidget(Composite.java:587) at\norg.eclipse.swt.widgets.Widget.dispose(Widget.java:380) at\norg.eclipse.ui.internal.PartPane.dispose(PartPane.java:242) at\norg.eclipse.ui.internal.EditorAreaHelper.closeEditor(EditorAreaHelper.java:124)\nat\norg.eclipse.ui.internal.EditorAreaHelper.closeEditor(EditorAreaHelper.java:111)\nat org.eclipse.ui.internal.EditorManager.closeEditor(EditorManager.java:223) at\norg.eclipse.ui.internal.WorkbenchPage.closeEditors(WorkbenchPage.java:1030) at\norg.eclipse.ui.internal.WorkbenchPage.closeAllEditors(WorkbenchPage.java:971) at\ncom.bea.test.common.core.EditorHelper.closeAll(EditorHelper.java:64) at\ncom.bea.test.common.BaseTest.tearDown(BaseTest.java:178) at\ncom.bea.test.wlw.netui.NetuiBaseTest.tearDown(NetuiBaseTest.java:105) at\ncom.bea.test.common.BaseTest.runBare(BaseTest.java:429) at\norg.eclipse.test.EclipseTestRunner.run(EclipseTestRunner.java:313) at\norg.eclipse.test.EclipseTestRunner.run(EclipseTestRunner.java:199) at\norg.eclipse.test.UITestApplication$3.run(UITestApplication.java:188) at\norg.eclipse.swt.widgets.RunnableLock.run(RunnableLock.java:35) at\norg.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:118) at\norg.eclipse.swt.widgets.Display.runAsyncMessages(Display.java:2885) at\norg.eclipse.swt.widgets.Display.readAndDispatch(Display.java:2544) at\norg.eclipse.ui.internal.Workbench.runEventLoop(Workbench.java:1612) at\norg.eclipse.ui.internal.Workbench.runUI(Workbench.java:1578) at\norg.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:293) at\norg.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:144) at\norg.eclipse.ui.internal.ide.IDEApplication.run(IDEApplication.java:102) at\norg.eclipse.test.UITestApplication.runApplication(UITestApplication.java:131) at\norg.eclipse.test.UITestApplication.run(UITestApplication.java:58) at\norg.eclipse.core.internal.runtime.PlatformActivator$1.run(PlatformActivator.java:228)\nat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:333)\nat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:150)\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) at\nsun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39) at\nsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\nat org.eclipse.core.launcher.Main.invokeFramework(Main.java:268) at\norg.eclipse.core.launcher.Main.basicRun(Main.java:260) at\norg.eclipse.core.launcher.Main.run(Main.java:887) at\norg.eclipse.core.launcher.Main.main(Main.java:871)",
    "Is there anything in .log?\n\nCan you post the code for StructuredTextViewer.setDocument(IDocument)?\n\nThe dispose listener calls setDocument(null). It seems that someone already\ndisconnected the annotation model and hence the assertion failure.\n\nAny pattern for the failure case? e.g. is the result non-deterministic for the\nsame test?",
    "(In reply to comment #1)\nThere isn\u0027t anything in the .log other than the AssertionError that I posted. I\nhaven\u0027t been able to spot any real pattern here, except that it does seem to\nhappen more often on slower machines (we recently moved our automated test suite\nonto slower hardware, and it happens a lot more now).\n\nStructuredTextViewer is webtools code, not ours; it doesn\u0027t implement\nsetDocument(IDocument), but it does implement setDocument(IDocument document,\nIAnnotationModel annotationModel, int modelRangeOffset, int modelRangeLength).\nHere\u0027s the source for the version we are using (webtools M3):\n\n\tpublic void setDocument(IDocument document, IAnnotationModel annotationModel,\nint modelRangeOffset, int modelRangeLength) {\n\n\n\t\t// partial fix for:\n\t\t// https://w3.opensource.ibm.com/bugzilla/show_bug.cgi?id\u003d1970\n\t\t// when our document is set, especially to null during close,\n\t\t// immediately uninstall the reconciler.\n\t\t// this is to avoid an unnecessary final \"reconcile\"\n\t\t// that blocks display thread\n\t\tif (document \u003d\u003d null) {\n\t\t\tif (fReconciler !\u003d null) {\n\t\t\t\tfReconciler.uninstall();\n\t\t\t}\n\t\t}\n\n\t\tsuper.setDocument(document, annotationModel, modelRangeOffset, modelRangeLength);\n\n\t\tif (document instanceof IStructuredDocument) {\n\t\t\tIStructuredDocument structuredDocument \u003d (IStructuredDocument) document;\n\n\t\t\t// notify highlighter\n\t\t\tif (fHighlighter !\u003d null) {\n\t\t\t\tfHighlighter.setDocument(structuredDocument);\n\t\t\t\t// fHighlighter.setModel(model);\n\t\t\t}\n\n\t\t\t// set document in the viewer-based undo manager\n\t\t\tif (fUndoManager instanceof StructuredTextViewerUndoManager) {\n\t\t\t\t((StructuredTextViewerUndoManager)\nfUndoManager).setDocument(structuredDocument);\n\t\t\t}\n\n\t\t}\n\t}\n\n\nStructuredTextViewer extends ProjectionViewer, so when it calls\nsuper.setDocument(), here\u0027s that code:\n\n\tpublic void setDocument(IDocument document, IAnnotationModel annotationModel,\nint modelRangeOffset, int modelRangeLength) {\n\t\tboolean wasProjectionEnabled\u003d false;\n\n\t\tsynchronized (fLock) {\n\t\t\tfPendingRequests.clear();\n\t\t}\n\t\t\n\t\tif (fProjectionAnnotationModel !\u003d null) {\n\t\t\twasProjectionEnabled\u003d\nremoveProjectionAnnotationModel(getVisualAnnotationModel()) !\u003d null;\n\t\t\tfProjectionAnnotationModel\u003d null;\n\t\t}\n\t\t\n\t\tsuper.setDocument(document, annotationModel, modelRangeOffset, modelRangeLength);\n\t\t\n\t\tif (wasProjectionEnabled)\n\t\t\tenableProjection();\n\t}\n\n\nProjectionViewer extends org.eclipse.jface.text.source.SourceViewer directly.\n\n",
    "I don\u0027t know if this is related, but I\u0027m also seeing an intermittant case where\nI connect to a file buffer (also of a .jsp file), and then when I try to get the\nbuffer it returns null. So this code fails:\n\n            ITextFileBufferManager bufferManager \u003d\nFileBuffers.getTextFileBufferManager();\n            bufferManager.connect( file.getFullPath(), null );\n            ITextFileBuffer buffer \u003d bufferManager.getTextFileBuffer(\nfile.getFullPath() );\n            assert buffer !\u003d null : \"Got back a null file buffer for: \" +\nfile.getFullPath() + \"; file.exists(): \" + file.exists();\n\n\nThe assert fires, even though the file is shown to currently exist. It doesn\u0027t\nhappen consistently, it seems to also be a timing issue. I\u0027ve seen this cause a\nNullPointerException when opening an editor, as the TextFileDocumentProvider (in\norg.eclipse.ui.editors.text) tried to execute similar code to get a buffer, and\nthe buffer came back null.",
    "\u003eit seems to also be a timing issue\nOr a JIT bug. Please run your tests without disabled JIT and see if this is\nstill occurs.\n\nCan you check (e.g. by running the tests in the Debugger) who actually connects\nand disconnects the file buffer and whether the number of connects and\ndisconnects is identical?",
    "I should add, if I understand that this problem is seen on WTP M3 (Eclipse M5a),\nthat there\u0027s been some other bugs opened, and some discussion on our newsgroups\nabout this assertion failure. We confirmed we could reproduce on that \"old\"\nbuild, but not on our current I builds, using M6. So ... I\u0027d guess no longer a\nproblem, or at least not as large. \n\nIf I might suggest, Tom, some useful unit tests in this area would be to \nconnect\nget\ndisconnet\n\nover and over and over, from several 5 or 10 Jobs. You could probably come up\nwith 101 cominations of factors (contents modified or not, saved or not,\ncontained annotations or not, text, xml, jsp, java, etc. ... that would really\nhelp flush out the sturdiness of this code, and to verify if there\u0027s a problem\nwith one particular type, that would help narrow it down, if there is a problem,\nand would make a great set of units tests for WTP! \n\nThanks very much. \n",
    "Get rid of deprecated state.",
    "."
  ],
  "commentCreationDates": [
    "2005-04-21T16:00:38+02:00",
    "2005-04-21T16:22:21+02:00",
    "2005-04-21T16:29:46+02:00",
    "2005-04-21T22:39:03+02:00",
    "2005-04-22T08:55:30+02:00",
    "2005-04-22T09:08:39+02:00",
    "2007-06-22T15:59:21+02:00",
    "2007-06-22T16:04:36+02:00"
  ],
  "traces": [
    {
      "exceptionType": "org.eclipse.jface.text.Assert$AssertionFailedException",
      "message": "Assertion failed:",
      "elements": [
        {
          "method": "org.eclipse.jface.text.Assert.isTrue",
          "source": "Assert.java:189"
        },
        {
          "method": "org.eclipse.jface.text.Assert.isTrue",
          "source": "Assert.java:174"
        },
        {
          "method": "org.eclipse.jface.text.source.AnnotationModel.disconnect",
          "source": "AnnotationModel.java:380"
        },
        {
          "method": "org.eclipse.jface.text.source.SourceViewer.setDocument",
          "source": "SourceViewer.java:465"
        },
        {
          "method": "org.eclipse.jface.text.source.projection.ProjectionViewer.setDocument",
          "source": "ProjectionViewer.java:369"
        },
        {
          "method": "org.eclipse.wst.sse.ui.StructuredTextViewer.setDocument",
          "source": "StructuredTextViewer.java:1071"
        },
        {
          "method": "org.eclipse.jface.text.source.SourceViewer.setDocument",
          "source": "SourceViewer.java:421"
        },
        {
          "method": "org.eclipse.jface.text.TextViewer$1.widgetDisposed",
          "source": "TextViewer.java:1446"
        },
        {
          "method": "org.eclipse.swt.widgets.TypedListener.handleEvent",
          "source": "TypedListener.java:100"
        },
        {
          "method": "org.eclipse.swt.widgets.EventTable.sendEvent",
          "source": "EventTable.java:82"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:842"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:866"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:847"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.releaseWidget",
          "source": "Widget.java:754"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.releaseWidget",
          "source": "Control.java:1571"
        },
        {
          "method": "org.eclipse.swt.widgets.Scrollable.releaseWidget",
          "source": "Scrollable.java:195"
        },
        {
          "method": "org.eclipse.swt.widgets.Composite.releaseWidget",
          "source": "Composite.java:588"
        },
        {
          "method": "org.eclipse.swt.widgets.Canvas.releaseWidget",
          "source": "Canvas.java:118"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.releaseResources",
          "source": "Widget.java:719"
        },
        {
          "method": "org.eclipse.swt.widgets.Composite.releaseChildren",
          "source": "Composite.java:582"
        },
        {
          "method": "org.eclipse.swt.widgets.Composite.releaseWidget",
          "source": "Composite.java:587"
        },
        {
          "method": "org.eclipse.swt.widgets.Canvas.releaseWidget",
          "source": "Canvas.java:118"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.releaseResources",
          "source": "Widget.java:719"
        },
        {
          "method": "org.eclipse.swt.widgets.Composite.releaseChildren",
          "source": "Composite.java:582"
        },
        {
          "method": "org.eclipse.swt.widgets.Composite.releaseWidget",
          "source": "Composite.java:587"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.releaseResources",
          "source": "Widget.java:719"
        },
        {
          "method": "org.eclipse.swt.widgets.Composite.releaseChildren",
          "source": "Composite.java:582"
        },
        {
          "method": "org.eclipse.swt.widgets.Composite.releaseWidget",
          "source": "Composite.java:587"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.releaseResources",
          "source": "Widget.java:719"
        },
        {
          "method": "org.eclipse.swt.widgets.Composite.releaseChildren",
          "source": "Composite.java:582"
        },
        {
          "method": "org.eclipse.swt.widgets.Composite.releaseWidget",
          "source": "Composite.java:587"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.releaseResources",
          "source": "Widget.java:719"
        },
        {
          "method": "org.eclipse.swt.widgets.Composite.releaseChildren",
          "source": "Composite.java:582"
        },
        {
          "method": "org.eclipse.swt.widgets.Composite.releaseWidget",
          "source": "Composite.java:587"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.dispose",
          "source": "Widget.java:380"
        },
        {
          "method": "org.eclipse.ui.internal.PartPane.dispose",
          "source": "PartPane.java:242"
        },
        {
          "method": "org.eclipse.ui.internal.EditorAreaHelper.closeEditor",
          "source": "EditorAreaHelper.java:124"
        },
        {
          "method": "org.eclipse.ui.internal.EditorAreaHelper.closeEditor",
          "source": "EditorAreaHelper.java:111"
        },
        {
          "method": "org.eclipse.ui.internal.EditorManager.closeEditor",
          "source": "EditorManager.java:223"
        },
        {
          "method": "org.eclipse.ui.internal.WorkbenchPage.closeEditors",
          "source": "WorkbenchPage.java:1030"
        },
        {
          "method": "org.eclipse.ui.internal.WorkbenchPage.closeAllEditors",
          "source": "WorkbenchPage.java:971"
        },
        {
          "method": "com.bea.test.common.core.EditorHelper.closeAll",
          "source": "EditorHelper.java:64"
        },
        {
          "method": "com.bea.test.common.BaseTest.tearDown",
          "source": "BaseTest.java:178"
        },
        {
          "method": "com.bea.test.wlw.netui.NetuiBaseTest.tearDown",
          "source": "NetuiBaseTest.java:105"
        },
        {
          "method": "com.bea.test.common.BaseTest.runBare",
          "source": "BaseTest.java:429"
        },
        {
          "method": "org.eclipse.test.EclipseTestRunner.run",
          "source": "EclipseTestRunner.java:313"
        },
        {
          "method": "org.eclipse.test.EclipseTestRunner.run",
          "source": "EclipseTestRunner.java:199"
        },
        {
          "method": "org.eclipse.test.UITestApplication$3.run",
          "source": "UITestApplication.java:188"
        },
        {
          "method": "org.eclipse.swt.widgets.RunnableLock.run",
          "source": "RunnableLock.java:35"
        },
        {
          "method": "org.eclipse.swt.widgets.Synchronizer.runAsyncMessages",
          "source": "Synchronizer.java:118"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.runAsyncMessages",
          "source": "Display.java:2885"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.readAndDispatch",
          "source": "Display.java:2544"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runEventLoop",
          "source": "Workbench.java:1612"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runUI",
          "source": "Workbench.java:1578"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.createAndRunWorkbench",
          "source": "Workbench.java:293"
        },
        {
          "method": "org.eclipse.ui.PlatformUI.createAndRunWorkbench",
          "source": "PlatformUI.java:144"
        },
        {
          "method": "org.eclipse.ui.internal.ide.IDEApplication.run",
          "source": "IDEApplication.java:102"
        },
        {
          "method": "org.eclipse.test.UITestApplication.runApplication",
          "source": "UITestApplication.java:131"
        },
        {
          "method": "org.eclipse.test.UITestApplication.run",
          "source": "UITestApplication.java:58"
        },
        {
          "method": "org.eclipse.core.internal.runtime.PlatformActivator$1.run",
          "source": "PlatformActivator.java:228"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:333"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:150"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "NativeMethodAccessorImpl.java:39"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "DelegatingMethodAccessorImpl.java:25"
        },
        {
          "method": "org.eclipse.core.launcher.Main.invokeFramework",
          "source": "Main.java:268"
        },
        {
          "method": "org.eclipse.core.launcher.Main.basicRun",
          "source": "Main.java:260"
        },
        {
          "method": "org.eclipse.core.launcher.Main.run",
          "source": "Main.java:887"
        },
        {
          "method": "org.eclipse.core.launcher.Main.main",
          "source": "Main.java:871"
        }
      ],
      "number": 0,
      "commentIndex": 0,
      "bugId": "92216",
      "date": "2005-04-21T16:00:38+02:00",
      "product": "Platform",
      "component": "Text",
      "severity": "normal"
    }
  ],
  "groupId": "92216",
  "bugId": "92216",
  "date": "2005-04-21T16:00:38+02:00",
  "product": "Platform",
  "component": "Text",
  "severity": "normal"
}