{
  "comments": [
    "When dragging and dropping within the XML editor\u0027s Outline view on Linux, multiple error dialogs with this (or similar) stack trace are opened:\n\n!ENTRY org.eclipse.jface 4 2 2006-11-07 16:44:49.201\n!MESSAGE Problems occurred when invoking code from plug-in: \"org.eclipse.jface\".\n!STACK 0\njava.lang.NullPointerException\n        at java.lang.String.\u003cinit\u003e(Unknown Source)\n        at org.eclipse.wst.common.ui.internal.dnd.ObjectTransfer.nativeToJava(Unknown Source)\n        at org.eclipse.wst.common.ui.internal.dnd.ViewerDropAdapter.getDragSource(Unknown Source)\n        at org.eclipse.wst.common.ui.internal.dnd.ViewerDropAdapter.helper(Unknown Source)\n        at org.eclipse.wst.common.ui.internal.dnd.ViewerDropAdapter.dragOver(Unknown Source)\n        at org.eclipse.wst.xml.ui.views.contentoutline.XMLContentOutlineConfiguration$2.dragOver(Unknown Source)\n        at org.eclipse.jface.util.DelegatingDropAdapter$2.run(Unknown Source)\n        at org.eclipse.core.runtime.SafeRunner.run(Unknown Source)\n        at org.eclipse.core.runtime.Platform.run(Unknown Source)\n        at org.eclipse.ui.internal.JFaceUtil$1.run(Unknown Source)\n        at org.eclipse.jface.util.SafeRunnable.run(Unknown Source)\n        at org.eclipse.jface.util.DelegatingDropAdapter.dragOver(Unknown Source)\n        at org.eclipse.swt.dnd.DNDListener.handleEvent(Unknown Source)\n        at org.eclipse.swt.widgets.EventTable.sendEvent(Unknown Source)\n        at org.eclipse.swt.widgets.Widget.sendEvent(Unknown Source)\n        at org.eclipse.swt.widgets.Widget.sendEvent(Unknown Source)\n        at org.eclipse.swt.widgets.Widget.sendEvent(Unknown Source)\n        at org.eclipse.swt.widgets.Widget.notifyListeners(Unknown Source)\n        at org.eclipse.swt.dnd.DropTarget$3.run(Unknown Source)\n        at org.eclipse.swt.widgets.Display.timerProc(Unknown Source)\n        at org.eclipse.swt.internal.gtk.OS._g_main_context_iteration(Native Method)\n        at org.eclipse.swt.internal.gtk.OS.g_main_context_iteration(Unknown Source)\n        at org.eclipse.swt.widgets.Display.readAndDispatch(Unknown Source)\n        at org.eclipse.ui.internal.Workbench.runEventLoop(Unknown Source)\n        at org.eclipse.ui.internal.Workbench.runUI(Unknown Source)\n        at org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Unknown Source)\n        at org.eclipse.ui.PlatformUI.createAndRunWorkbench(Unknown Source)\n        at org.eclipse.ui.internal.ide.IDEApplication.run(Unknown Source)\n        at org.eclipse.core.internal.runtime.PlatformActivator$1.run(Unknown Source)\n        at org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(Unknown Source)\n        at org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(Unknown Source)\n        at org.eclipse.core.runtime.adaptor.EclipseStarter.run(Unknown Source)\n        at org.eclipse.core.runtime.adaptor.EclipseStarter.run(Unknown Source)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)\n        at java.lang.reflect.Method.invoke(Unknown Source)\n        at org.eclipse.core.launcher.Main.invokeFramework(Unknown Source)\n        at org.eclipse.core.launcher.Main.basicRun(Unknown Source)\n        at org.eclipse.core.launcher.Main.run(Unknown Source)\n        at org.eclipse.core.launcher.Main.main(Unknown Source)\n\nThe ObjectTransfer class is witent to store a byte array representing a system timestamp as the actual data being dragged.  It then uses that timestamp to ensure that the correct Java object, which is kept as a field, can be retrieved as part of the drop.  This class is essentially the same as EMF\u0027s LocalTransfer, it\u0027s meant to provide the exact Java object on the drop, not merely an identical one.  The trace being shown is supposed to retrieve that Java object before the drop has occurred, in fact before dragSetData() has been called on the drag source listener.  SWT states that the DND data can be retrieved before the drop actually occurs, but only on certain platforms.  Linux is not one of them, it retrieves a null value instead of any byte array and triggers a NPE when creating a String from it.  The fallout from this is that each dragOver event that gets queued before the first SafeRunner catches this exception throws up a dialog.  This ends up looking much like an infinite loop the end user, even though it isn\u0027t.\n\nTwo problems exist here, first that ObjectTransfer doesn\u0027t bother to check if the Java object field is not null before interacting with the native parts.  If the object is null, the javaToNative method was never called and there\u0027s no relevant information in the TransferData--no timestamp to compare against.  Second, that the outline view\u0027s use of a JFace DelegatingDropAdapter doesn\u0027t mesh well with the XMLDragAndDropManager/ViewerDropAdapter implementing most of the drop behavior.  In part, the drag and drop manager is expecting to get a value back from the ObjectTransfer earlier than is possible on Linux.  Adding the null check, while preventing the error dialogs, also seems to prevent it from correctly setting up the command to execute when the drop occurs--DND stops working on both platforms.\n\nPart of the design of the XML editor\u0027s outline view uses the the DelegatingDropAdapter and a list of TransferDropTargetListeners that adopters can extend.  Given that this is API, the best solution is to replace the calls to the XMLDragAndDropManager with equivalents that allow both for the null check within ObjectTransfer and still permits extension via the DelegatingDropAdapter.\n\nNote that this also affects the XML Editor\u0027s Design page and the DTD editor\u0027s Outline view, as they both use variants of the XMLDragAndDropManager and ObjectTransfer type.",
    "Created an attachment (id\u003d53558)\nproposed patch\n\n",
    "Targetting 1.5.3, as it\u0027s a very ugly and visible problem on Linux.",
    "CCing Amy for review, although I expect it may take some time for a patch this large.",
    "After applying the patch, I was unable to DND objects in the outline view.  For example, trying to rearrange TD tags inside a table did not work.  I also could not DND elements in the XML design page either.  (I was on windows xp)",
    "Strangely, the dragSetData() method on the delegating drag adapter isn\u0027t called on Windows in this case.  I know it\u0027s called consistently elsewhere, so I\u0027ll have to do more digging.",
    "Created an attachment (id\u003d57487)\nupdated patch, uses JFace LocalSelectionTransfer instead\n\nUpdated patch.  This one works on both platforms and should work fine on Mac as well.",
    "Dragging and dropping in outline view looks good now with the updated patch.\n\nDragging and dropping in the xml design page looks okay for the most part, but I found 2 regressions:\n1. I am unable to drag an attribute from 1 element and drop it between attributes of another element.  However, dropping the attribute on top of the other element will correctly move the attribute.\n\n2. Sometimes, when I drag an element and drop it between 2 elements, it\u0027ll end up being the child of one of those elements rather than a sibling.  I think it depends on if my cursor position is slightly above the intended drop location or not. The drop indicator looks the same (a line is drawn between the 2 elements), but the actual dropped location is different.",
    "Created an attachment (id\u003d57552)\nupdated patch addressing those two issues\n\nThe height passed into the DragNodeCommand was faked using the feedback\u0027s value, but the height really does need to be recomputed for this kind of precise behavior.",
    "Ok, those 2 issues appear fixed in the latest patch!",
    "Releasing for candidate respin.",
    "Verified on M200702072117"
  ],
  "commentCreationDates": [
    "2006-11-09T17:32:16+01:00",
    "2006-11-09T17:59:01+01:00",
    "2006-11-09T17:59:37+01:00",
    "2007-01-18T09:11:48+01:00",
    "2007-01-19T23:17:33+01:00",
    "2007-01-23T17:36:48+01:00",
    "2007-01-25T03:05:28+01:00",
    "2007-01-25T21:50:46+01:00",
    "2007-01-25T22:37:09+01:00",
    "2007-01-25T22:43:41+01:00",
    "2007-01-25T23:28:05+01:00",
    "2007-02-08T03:33:51+01:00"
  ],
  "traces": [
    {
      "exceptionType": "java.lang.NullPointerException",
      "elements": [
        {
          "method": "java.lang.String.\u003cinit\u003e",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.wst.common.ui.internal.dnd.ObjectTransfer.nativeToJava",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.wst.common.ui.internal.dnd.ViewerDropAdapter.getDragSource",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.wst.common.ui.internal.dnd.ViewerDropAdapter.helper",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.wst.common.ui.internal.dnd.ViewerDropAdapter.dragOver",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.wst.xml.ui.views.contentoutline.XMLContentOutlineConfiguration$2.dragOver",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.jface.util.DelegatingDropAdapter$2.run",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.runtime.SafeRunner.run",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.runtime.Platform.run",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.ui.internal.JFaceUtil$1.run",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.jface.util.SafeRunnable.run",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.jface.util.DelegatingDropAdapter.dragOver",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.swt.dnd.DNDListener.handleEvent",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.swt.widgets.EventTable.sendEvent",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.notifyListeners",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.swt.dnd.DropTarget$3.run",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.timerProc",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.swt.internal.gtk.OS._g_main_context_iteration",
          "source": "Native Method"
        },
        {
          "method": "org.eclipse.swt.internal.gtk.OS.g_main_context_iteration",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.readAndDispatch",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runEventLoop",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runUI",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.createAndRunWorkbench",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.ui.PlatformUI.createAndRunWorkbench",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.ui.internal.ide.IDEApplication.run",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.internal.runtime.PlatformActivator$1.run",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "Unknown Source"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "Unknown Source"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "Unknown Source"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.launcher.Main.invokeFramework",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.launcher.Main.basicRun",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.launcher.Main.run",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.launcher.Main.main",
          "source": "Unknown Source"
        }
      ],
      "number": 0,
      "commentIndex": 0,
      "bugId": "163987",
      "date": "2006-11-09T17:32:16+01:00",
      "product": "Web Tools",
      "component": "wst.xml",
      "severity": "major"
    }
  ],
  "groupId": "163987",
  "bugId": "163987",
  "date": "2006-11-09T17:32:16+01:00",
  "product": "Web Tools",
  "component": "wst.xml",
  "severity": "major"
}