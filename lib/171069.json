{
  "comments": [
    "There is a performance optimization in CompilationAndWeavingContext that assumes by default that we are in a single threaded environment unless the JVMTI agent is used. Unfortunately this ignores other LTW scenarios including using the JRockit agent, Aj directly or instantiating a WeavingAdaptor. We should assume we are in a multi-threaded environment by default and determine when we are not instead e.g. AJDT or ajc.\n\njava.util.EmptyStackException\n\tat java.util.Stack.peek(Stack.java(Inlined Compiled Code))\n\tat java.util.Stack.pop(Stack.java(Inlined Compiled Code))\n\tat org.aspectj.bridge.context.CompilationAndWeavingContext.leavingPhase(CompilationAndWeavingContext.java(Inlined Compiled Code))\n\tat org.aspectj.weaver.bcel.BcelWeaver.weave(BcelWeaver.java(Compiled Code))\n\tat org.aspectj.weaver.tools.WeavingAdaptor.getWovenBytes(WeavingAdaptor.java(Inlined Compiled Code))\n\tat org.aspectj.weaver.tools.WeavingAdaptor.weaveClass(WeavingAdaptor.java(Compiled Code))\n\tat org.aspectj.weaver.loadtime.ClassLoaderWeavingAdaptor.weaveAndDefineConceteAspects(ClassLoaderWeavingAdaptor.java:471)\n\tat org.aspectj.weaver.loadtime.ClassLoaderWeavingAdaptor.initialize(ClassLoaderWeavingAdaptor.java:159)\n\tat org.aspectj.weaver.loadtime.Aj$ExplicitlyInitializedClassLoaderWeavingAdaptor.initialize(Aj.java(Inlined Compiled Code))\n\tat org.aspectj.weaver.loadtime.Aj$ExplicitlyInitializedClassLoaderWeavingAdaptor.getWeavingAdaptor(Aj.java(Inlined Compiled Code))\n\tat org.aspectj.weaver.loadtime.Aj$WeaverContainer.getWeaver(Aj.java(Compiled Code))\n\tat org.aspectj.weaver.loadtime.Aj.preProcess(Aj.java(Compiled Code))\n\t...",
    "I believe this bug is caused by Bug 120817 \"[performance]Thread Safety \u0026 8% Optimization : Use ThreadLocal for CompilationAndWeavingContext\". Although not explicit the commit comment \"Put compilation-and-weaving-context into multi-thread mode when doing LTW\" tallies with Comment #4 in the bug report. My suggested fix is to add a call setMultiThreaded(false) in AjBuildManager. This class cannot be called by the weaver (and so will not affect LTW) as it is in a higher module. It is used by all the command line tools via org.aspectj.tools.ajc.Main and AJDT etc via the new AjCompiler.\n"
  ],
  "commentCreationDates": [
    "2007-01-19T16:27:04+01:00",
    "2007-01-22T15:12:48+01:00"
  ],
  "traces": [
    {
      "exceptionType": "java.util.EmptyStackException",
      "elements": [
        {
          "method": "java.util.Stack.peek",
          "source": "Stack.java(Inlined Compiled Code)"
        },
        {
          "method": "java.util.Stack.pop",
          "source": "Stack.java(Inlined Compiled Code)"
        },
        {
          "method": "org.aspectj.bridge.context.CompilationAndWeavingContext.leavingPhase",
          "source": "CompilationAndWeavingContext.java(Inlined Compiled Code)"
        },
        {
          "method": "org.aspectj.weaver.bcel.BcelWeaver.weave",
          "source": "BcelWeaver.java(Compiled Code)"
        },
        {
          "method": "org.aspectj.weaver.tools.WeavingAdaptor.getWovenBytes",
          "source": "WeavingAdaptor.java(Inlined Compiled Code)"
        },
        {
          "method": "org.aspectj.weaver.tools.WeavingAdaptor.weaveClass",
          "source": "WeavingAdaptor.java(Compiled Code)"
        },
        {
          "method": "org.aspectj.weaver.loadtime.ClassLoaderWeavingAdaptor.weaveAndDefineConceteAspects",
          "source": "ClassLoaderWeavingAdaptor.java:471"
        },
        {
          "method": "org.aspectj.weaver.loadtime.ClassLoaderWeavingAdaptor.initialize",
          "source": "ClassLoaderWeavingAdaptor.java:159"
        },
        {
          "method": "org.aspectj.weaver.loadtime.Aj$ExplicitlyInitializedClassLoaderWeavingAdaptor.initialize",
          "source": "Aj.java(Inlined Compiled Code)"
        },
        {
          "method": "org.aspectj.weaver.loadtime.Aj$ExplicitlyInitializedClassLoaderWeavingAdaptor.getWeavingAdaptor",
          "source": "Aj.java(Inlined Compiled Code)"
        },
        {
          "method": "org.aspectj.weaver.loadtime.Aj$WeaverContainer.getWeaver",
          "source": "Aj.java(Compiled Code)"
        },
        {
          "method": "org.aspectj.weaver.loadtime.Aj.preProcess",
          "source": "Aj.java(Compiled Code)"
        }
      ],
      "number": 0,
      "commentIndex": 0,
      "bugId": "171069",
      "date": "2007-01-19T16:27:04+01:00",
      "product": "AspectJ",
      "component": "LTWeaving",
      "severity": "normal"
    }
  ],
  "groupId": "171069",
  "bugId": "171069",
  "date": "2007-01-19T16:27:04+01:00",
  "product": "AspectJ",
  "component": "LTWeaving",
  "severity": "normal"
}