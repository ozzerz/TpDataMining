{
  "comments": [
    "referring to bug Bug#:121148\nas already discussed in the newsgroup we ran into this problem twice already using eclipse 3.2. unfortunatley we are not able to reproduce this bug.\n\nwe are using the 3.2 source (fix for bug #121148 included, checked that)\nand a bundle relying heavily on dynamic imports (might be of some importance).\n\nafter a shutdown of the platform and a subsequent restart the following NPE occured (in the said bundle):\n\norg.osgi.framework.BundleException: The activator at.scch.pmp.datatypeRepository.DatatypeRepositoryPlugin for bundle at.scch.pmp.datatypeRepository is invalid\n\tat org.eclipse.osgi.framework.internal.core.AbstractBundle.loadBundleActivator(AbstractBundle.java:141)\n\tat org.eclipse.osgi.framework.internal.core.BundleContextImpl.start(BundleContextImpl.java:966)\n\tat org.eclipse.osgi.framework.internal.core.BundleHost.startWorker(BundleHost.java:317)\n\tat org.eclipse.osgi.framework.internal.core.AbstractBundle.resume(AbstractBundle.java:329)\n\tat org.eclipse.osgi.framework.internal.core.Framework.resumeBundle(Framework.java:1037)\n\tat org.eclipse.osgi.framework.internal.core.StartLevelManager.resumeBundles(StartLevelManager.java:573)\n\tat org.eclipse.osgi.framework.internal.core.StartLevelManager.incFWSL(StartLevelManager.java:495)\n\tat org.eclipse.osgi.framework.internal.core.StartLevelManager.doSetStartLevel(StartLevelManager.java:275)\n\tat org.eclipse.osgi.framework.internal.core.StartLevelManager.dispatchEvent(StartLevelManager.java:455)\n\tat org.eclipse.osgi.framework.eventmgr.EventManager.dispatchEvent(EventManager.java:189)\n\tat org.eclipse.osgi.framework.eventmgr.EventManager$EventThread.run(EventManager.java:291)\nCaused by: java.lang.NullPointerException\n\tat org.eclipse.osgi.framework.internal.core.BundleLoader.getLoaderProxy(BundleLoader.java:238)\n\tat org.eclipse.osgi.framework.internal.core.BundleLoader.createExportPackageSource(BundleLoader.java:210)\n\tat org.eclipse.osgi.framework.internal.core.BundleLoader.addImportedPackages(BundleLoader.java:201)\n\tat org.eclipse.osgi.framework.internal.core.BundleLoader.findImportedSource(BundleLoader.java:873)\n\tat org.eclipse.osgi.framework.internal.core.BundleLoader.findClass(BundleLoader.java:376)\n\tat org.eclipse.osgi.framework.internal.core.BundleLoader.findClass(BundleLoader.java:352)\n\tat org.eclipse.osgi.internal.baseadaptor.DefaultClassLoader.loadClass(DefaultClassLoader.java:83)\n\tat java.lang.ClassLoader.loadClass(ClassLoader.java:246)\n\tat org.eclipse.osgi.framework.internal.core.BundleLoader.loadClass(BundleLoader.java:276)\n\tat org.eclipse.osgi.framework.internal.core.BundleHost.loadClass(BundleHost.java:227)\n\tat org.eclipse.osgi.framework.internal.core.AbstractBundle.loadBundleActivator(AbstractBundle.java:134)\n\t... 10 more\nRoot exception:\njava.lang.NullPointerException\n\tat org.eclipse.osgi.framework.internal.core.BundleLoader.getLoaderProxy(BundleLoader.java:238)\n\tat org.eclipse.osgi.framework.internal.core.BundleLoader.createExportPackageSource(BundleLoader.java:210)\n\tat org.eclipse.osgi.framework.internal.core.BundleLoader.addImportedPackages(BundleLoader.java:201)\n\tat org.eclipse.osgi.framework.internal.core.BundleLoader.findImportedSource(BundleLoader.java:873)\n\tat org.eclipse.osgi.framework.internal.core.BundleLoader.findClass(BundleLoader.java:376)\n\tat org.eclipse.osgi.framework.internal.core.BundleLoader.findClass(BundleLoader.java:352)\n\tat org.eclipse.osgi.internal.baseadaptor.DefaultClassLoader.loadClass(DefaultClassLoader.java:83)\n\tat java.lang.ClassLoader.loadClass(ClassLoader.java:246)\n\tat org.eclipse.osgi.framework.internal.core.BundleLoader.loadClass(BundleLoader.java:276)\n\tat org.eclipse.osgi.framework.internal.core.BundleHost.loadClass(BundleHost.java:227)\n\tat org.eclipse.osgi.framework.internal.core.AbstractBundle.loadBundleActivator(AbstractBundle.java:134)\n\tat org.eclipse.osgi.framework.internal.core.BundleContextImpl.start(BundleContextImpl.java:966)\n\tat org.eclipse.osgi.framework.internal.core.BundleHost.startWorker(BundleHost.java:317)\n\tat org.eclipse.osgi.framework.internal.core.AbstractBundle.resume(AbstractBundle.java:329)\n\tat org.eclipse.osgi.framework.internal.core.Framework.resumeBundle(Framework.java:1037)\n\tat org.eclipse.osgi.framework.internal.core.StartLevelManager.resumeBundles(StartLevelManager.java:573)\n\tat org.eclipse.osgi.framework.internal.core.StartLevelManager.incFWSL(StartLevelManager.java:495)\n\tat org.eclipse.osgi.framework.internal.core.StartLevelManager.doSetStartLevel(StartLevelManager.java:275)\n\tat org.eclipse.osgi.framework.internal.core.StartLevelManager.dispatchEvent(StartLevelManager.java:455)\n\tat org.eclipse.osgi.framework.eventmgr.EventManager.dispatchEvent(EventManager.java:189)\n\tat org.eclipse.osgi.framework.eventmgr.EventManager$EventThread.run(EventManager.java:291)\n \n!ENTRY org.eclipse.osgi 4 0 2006-11-14 10:10:29.277\n!MESSAGE Bundle initial@reference:file:plugins/at.scch.pmp.datatypeRepository_1.0.0.jar/ [23] is not active.",
    "Another time today. Same stacktrace\nThe affected bundle does a lot of dynamic imports\nexamining the exported packages imported by the problematic bundle showed no split packages\n\nbelow is the relevant section from manifest.mf\n\nManifest-Version: 1.0\nBundle-ManifestVersion: 2\nBundle-Name: DatatypeRepository Plug-in\nBundle-SymbolicName: at.scch.pmp.datatypeRepository; singleton:\u003dtrue\nBundle-Version: 1.0.0\nBundle-Activator: at.scch.pmp.datatypeRepository.DatatypeRepositoryPlugin\nBundle-Vendor: SCCH\nBundle-Localization: plugin\nRequire-Bundle: org.eclipse.core.runtime,\n at.scch.pmp.util,\n at.scch.pmp.logservice,\n at.scch.pmp.scheduler.PMAPI,\n at.scch.pmp.datatypeRepository.interfaces\nExport-Packages: at.scch.pmp.datatypeRepository.service\n............\n.....\n.\nDynamicImport-Package: com.voestalpine.stahl.tm.datatypes.models.*\n\nWe have several bundles, which export subpackages of the one named in the dyn import statement. These bundles are subject to some refrehsing/uninst/reinstalling.\nIt seems that sometimes the cache gets corrupted by such an operation.\nWe have now set the noLazyStateLoading flag on the affected systems.\nWe will look at this problem on our inhouse system as soon as we have calmed down our customer :-)\n",
    "Just to confirm, could you please try with 3.3 M4?",
    "*** Bug 168540 has been marked as a duplicate of this bug. ***",
    "*** Bug 168542 has been marked as a duplicate of this bug. ***",
    "first: sorry for the mulitple reports of this bug- seems to be some issue with my connection/browser\n\nunfortunatley using 3.3 m4 for testing purpose is not a viable option for us at this moment as it would result in extensive testing of our application (plus we had to do some changes to the framework we need done).\n\n",
    "*** Bug 168543 has been marked as a duplicate of this bug. ***",
    "Bug 157723 may also be of interest here.  This bug was fixed in 3.2.1.",
    "Can you try moving up to 3.2.1?  I think this may be a dup of bug 157723.\n\nAlso what changes to the framework do you require.  Can you open a seperate bug and attach your changes as a patch so we can consider your usecases and integrate a solution into the main code stream?  Thanks.",
    "Bernard or Werner can you verify that setting osgi.noLazyStateLoading\u003dtrue flag works around your issues?  Is there any way we could get a testcase to reproduce?",
    "Created an attachment (id\u003d56494)\npossible fix for 3.2.x\n\nThe 3.3 stream has an additional code fix related to this area that did not make it into the 3.2 stream.  There is a possible threading issue in BundleDescriptionImpl when loading the lazy data.  We must ensure that the state reader is locked before calling the setAccessedFlag.  Otherwise we run the risk of unloading lazy data at the same time a bundle is accessing their lazy data.\n\nWe should consider releasing this fix to 3.2.2.",
    "Need a code review by Pascal and an approval from Jeff for 3.2.2.  This fix has been in 3.3 since M2.",
    "Werner or Bernhard, can you apply the patch to your version of the framework to see if it fixes the issue for you.  Thanks.",
    "+1 for 3.2.2",
    "This patch looks good.\nHowever I wonder if the accesses to the state reader from BundleDescriptionImpl#unload and #setContainingState should not be sync\u0027ed as well.",
    "BundleDescriptionImpl#unload is only called while the StateReader lock is obtained, but for clarity we should probably obtain the lock in the method for the state reader.  Either that or comment the code.\n\nBundleDescriptionImpl#setContainingState does not need to be synchronized because StateReader.isLazyLoaded will always return the same value.\n\nWith that said I did a bunch more testing and analysis of the code.  I took my a long to figure out how we could get into this situation (even with the current 3.2.1 code).  I have found a real problem that can cause the NPE from this bug report to occur.  The problem is when we save the state to disk we clear the dynamicCacheChanged flag.  This allows for the memory to be flushed, but any bundle that had a dynamic import will not be flushed correctly.  Then if the state is changed again we reload the cache from disk incorrectly and when the state is saved again the corrupted data is saved to disk.\n\nI will attach a new patch addressing Pascals comments and fixing this new problem once I can connect to CVS again (CVS is acting up today) ...\n\n",
    "Created an attachment (id\u003d56592)\ncomplete patch for 3.2.x\n\nPascal, please review this new patch.  Thanks.",
    "Created an attachment (id\u003d56594)\ncomplete patch for HEAD\n\nPatch for HEAD.",
    "new patch reviewed.",
    "First of all: Sorry for our late response, but both Werner and I were on vacation.\n(In reply to comment #9)\n\u003e Bernard or Werner can you verify that setting osgi.noLazyStateLoading\u003dtrue flag\n\u003e works around your issues?  Is there any way we could get a testcase to\n\u003e reproduce?\n\u003e \nWe haven\u0027t been able to reproduce the problem on our testing system yet. \nThe production systems at the customer\u0027s site were tested a couple of times and no failure occured upon reboot (with the flag set to true).\n\n\u003eWerner or Bernhard, can you apply the patch to your version of the framework to\n\u003esee if it fixes the issue for you.  Thanks.\nWe\u0027ll do that asap.\n\nThanks for your efforts!\n",
    "I released the fix to 3.3 and the next 3.2.2 build.  Please let us know how your testing goes on the latest patch and reopen if you still have problems.  Thanks."
  ],
  "commentCreationDates": [
    "2006-12-19T10:21:45+01:00",
    "2006-12-19T13:40:32+01:00",
    "2006-12-19T14:05:57+01:00",
    "2006-12-19T14:31:37+01:00",
    "2006-12-19T14:32:11+01:00",
    "2006-12-19T14:47:32+01:00",
    "2006-12-19T14:51:47+01:00",
    "2006-12-19T15:12:51+01:00",
    "2007-01-03T17:02:08+01:00",
    "2007-01-05T22:14:21+01:00",
    "2007-01-05T22:46:18+01:00",
    "2007-01-05T22:48:47+01:00",
    "2007-01-05T23:33:03+01:00",
    "2007-01-06T00:46:54+01:00",
    "2007-01-08T04:17:04+01:00",
    "2007-01-08T22:07:15+01:00",
    "2007-01-08T22:17:01+01:00",
    "2007-01-08T22:26:04+01:00",
    "2007-01-08T22:34:45+01:00",
    "2007-01-09T08:57:16+01:00",
    "2007-01-09T14:51:36+01:00"
  ],
  "traces": [
    {
      "exceptionType": "org.osgi.framework.BundleException",
      "message": "The activator at.scch.pmp.datatypeRepository.DatatypeRepositoryPlugin for bundle at.scch.pmp.datatypeRepository is invalid",
      "elements": [
        {
          "method": "org.eclipse.osgi.framework.internal.core.AbstractBundle.loadBundleActivator",
          "source": "AbstractBundle.java:141"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleContextImpl.start",
          "source": "BundleContextImpl.java:966"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleHost.startWorker",
          "source": "BundleHost.java:317"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.AbstractBundle.resume",
          "source": "AbstractBundle.java:329"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.Framework.resumeBundle",
          "source": "Framework.java:1037"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.StartLevelManager.resumeBundles",
          "source": "StartLevelManager.java:573"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.StartLevelManager.incFWSL",
          "source": "StartLevelManager.java:495"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.StartLevelManager.doSetStartLevel",
          "source": "StartLevelManager.java:275"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.StartLevelManager.dispatchEvent",
          "source": "StartLevelManager.java:455"
        },
        {
          "method": "org.eclipse.osgi.framework.eventmgr.EventManager.dispatchEvent",
          "source": "EventManager.java:189"
        },
        {
          "method": "org.eclipse.osgi.framework.eventmgr.EventManager$EventThread.run",
          "source": "EventManager.java:291"
        }
      ],
      "causedBy": {
        "exceptionType": "java.lang.NullPointerException",
        "elements": [
          {
            "method": "org.eclipse.osgi.framework.internal.core.BundleLoader.getLoaderProxy",
            "source": "BundleLoader.java:238"
          },
          {
            "method": "org.eclipse.osgi.framework.internal.core.BundleLoader.createExportPackageSource",
            "source": "BundleLoader.java:210"
          },
          {
            "method": "org.eclipse.osgi.framework.internal.core.BundleLoader.addImportedPackages",
            "source": "BundleLoader.java:201"
          },
          {
            "method": "org.eclipse.osgi.framework.internal.core.BundleLoader.findImportedSource",
            "source": "BundleLoader.java:873"
          },
          {
            "method": "org.eclipse.osgi.framework.internal.core.BundleLoader.findClass",
            "source": "BundleLoader.java:376"
          },
          {
            "method": "org.eclipse.osgi.framework.internal.core.BundleLoader.findClass",
            "source": "BundleLoader.java:352"
          },
          {
            "method": "org.eclipse.osgi.internal.baseadaptor.DefaultClassLoader.loadClass",
            "source": "DefaultClassLoader.java:83"
          },
          {
            "method": "java.lang.ClassLoader.loadClass",
            "source": "ClassLoader.java:246"
          },
          {
            "method": "org.eclipse.osgi.framework.internal.core.BundleLoader.loadClass",
            "source": "BundleLoader.java:276"
          },
          {
            "method": "org.eclipse.osgi.framework.internal.core.BundleHost.loadClass",
            "source": "BundleHost.java:227"
          },
          {
            "method": "org.eclipse.osgi.framework.internal.core.AbstractBundle.loadBundleActivator",
            "source": "AbstractBundle.java:134"
          }
        ],
        "number": 0,
        "commentIndex": 0
      },
      "number": 0,
      "commentIndex": 0,
      "bugId": "168521",
      "date": "2006-12-19T10:21:45+01:00",
      "product": "Equinox",
      "component": "Framework",
      "severity": "normal"
    },
    {
      "exceptionType": "java.lang.NullPointerException",
      "elements": [
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleLoader.getLoaderProxy",
          "source": "BundleLoader.java:238"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleLoader.createExportPackageSource",
          "source": "BundleLoader.java:210"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleLoader.addImportedPackages",
          "source": "BundleLoader.java:201"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleLoader.findImportedSource",
          "source": "BundleLoader.java:873"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleLoader.findClass",
          "source": "BundleLoader.java:376"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleLoader.findClass",
          "source": "BundleLoader.java:352"
        },
        {
          "method": "org.eclipse.osgi.internal.baseadaptor.DefaultClassLoader.loadClass",
          "source": "DefaultClassLoader.java:83"
        },
        {
          "method": "java.lang.ClassLoader.loadClass",
          "source": "ClassLoader.java:246"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleLoader.loadClass",
          "source": "BundleLoader.java:276"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleHost.loadClass",
          "source": "BundleHost.java:227"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.AbstractBundle.loadBundleActivator",
          "source": "AbstractBundle.java:134"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleContextImpl.start",
          "source": "BundleContextImpl.java:966"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleHost.startWorker",
          "source": "BundleHost.java:317"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.AbstractBundle.resume",
          "source": "AbstractBundle.java:329"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.Framework.resumeBundle",
          "source": "Framework.java:1037"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.StartLevelManager.resumeBundles",
          "source": "StartLevelManager.java:573"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.StartLevelManager.incFWSL",
          "source": "StartLevelManager.java:495"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.StartLevelManager.doSetStartLevel",
          "source": "StartLevelManager.java:275"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.StartLevelManager.dispatchEvent",
          "source": "StartLevelManager.java:455"
        },
        {
          "method": "org.eclipse.osgi.framework.eventmgr.EventManager.dispatchEvent",
          "source": "EventManager.java:189"
        },
        {
          "method": "org.eclipse.osgi.framework.eventmgr.EventManager$EventThread.run",
          "source": "EventManager.java:291"
        }
      ],
      "number": 1,
      "commentIndex": 0,
      "bugId": "168521",
      "date": "2006-12-19T10:21:45+01:00",
      "product": "Equinox",
      "component": "Framework",
      "severity": "normal"
    }
  ],
  "groupId": "168521",
  "bugId": "168521",
  "date": "2006-12-19T10:21:45+01:00",
  "product": "Equinox",
  "component": "Framework",
  "severity": "normal"
}