{
  "comments": [
    "The ChainedPreferenceStore is not working well if default and actual values are\nset in different stores of the chain. Bellow is the code to reproduce tha bug\nand exception trace from the .log file.\n\n\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n\nIPreferenceStore store \u003d SomePlugin.getDefault().getPreferenceStore();\n\nIPreferenceStore[] chain \u003d { store, EditorsUI.getPreferenceStore() };\nIPreferenceStore cps \u003d new ChainedPreferenceStore(chain);\n\ncps.addPropertyChangeListener(new IPropertyChangeListener() {\n\tpublic void propertyChange(PropertyChangeEvent event) {}\n});\n\nString key \u003d AbstractDecoratedTextEditorPreferenceConstants.EDITOR_TAB_WIDTH;\n\nstore.setValue(key, \"8\");\nstore.setToDefault(key);\n\n\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n\n!MESSAGE Problems occurred when invoking code from plug-in:\n\"org.eclipse.core.runtime\".\n!STACK 0\norg.eclipse.jface.util.Assert$AssertionFailedException: Assertion failed: \n\tat org.eclipse.jface.util.Assert.isTrue(Assert.java:168)\n\tat org.eclipse.jface.util.Assert.isTrue(Assert.java:154)\n\tat\norg.eclipse.ui.texteditor.ChainedPreferenceStore.handlePropertyChangeEvent(ChainedPreferenceStore.java:473)\n\tat\norg.eclipse.ui.texteditor.ChainedPreferenceStore.access$0(ChainedPreferenceStore.java:406)\n\tat\norg.eclipse.ui.texteditor.ChainedPreferenceStore$PropertyChangeListener.propertyChange(ChainedPreferenceStore.java:68)\n\tat org.eclipse.ui.plugin.AbstractUIPlugin$2.run(AbstractUIPlugin.java:267)\n\tat\norg.eclipse.core.internal.runtime.InternalPlatform.run(InternalPlatform.java:615)\n\tat org.eclipse.core.runtime.Platform.run(Platform.java:747)\n\tat\norg.eclipse.ui.plugin.AbstractUIPlugin$CompatibilityPreferenceStore.firePropertyChangeEvent(AbstractUIPlugin.java:265)\n\tat\norg.eclipse.ui.plugin.AbstractUIPlugin$1.propertyChange(AbstractUIPlugin.java:205)\n\tat\norg.eclipse.core.internal.preferences.PreferenceForwarder.preferenceChange(PreferenceForwarder.java:115)\n\tat\norg.eclipse.core.internal.preferences.EclipsePreferences$4.run(EclipsePreferences.java:743)\n\tat\norg.eclipse.core.internal.runtime.InternalPlatform.run(InternalPlatform.java:615)\n\tat org.eclipse.core.runtime.Platform.run(Platform.java:747)\n\tat\norg.eclipse.core.internal.preferences.EclipsePreferences.preferenceChanged(EclipsePreferences.java:746)\n\tat\norg.eclipse.core.internal.preferences.EclipsePreferences.internalRemove(EclipsePreferences.java:560)\n\tat\norg.eclipse.core.internal.preferences.EclipsePreferences.remove(EclipsePreferences.java:863)\n\tat\norg.eclipse.core.internal.preferences.PreferenceForwarder.setToDefault(PreferenceForwarder.java:680)\n\tat\norg.eclipse.ui.plugin.AbstractUIPlugin$CompatibilityPreferenceStore.setToDefault(AbstractUIPlugin.java:439)\n\tat ChainedPreferenceStoreBug.popup.actions.NewAction.run(NewAction.java:52)\n\tat org.eclipse.ui.internal.PluginAction.runWithEvent(PluginAction.java:276)\n\tat\norg.eclipse.jface.action.ActionContributionItem.handleWidgetSelection(ActionContributionItem.java:915)\n\tat\norg.eclipse.jface.action.ActionContributionItem.access$2(ActionContributionItem.java:866)\n\tat\norg.eclipse.jface.action.ActionContributionItem$7.handleEvent(ActionContributionItem.java:785)\n\tat org.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:82)\n\tat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:796)\n\tat org.eclipse.swt.widgets.Display.runDeferredEvents(Display.java:2772)\n\tat org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:2431)\n\tat org.eclipse.ui.internal.Workbench.runEventLoop(Workbench.java:1377)\n\tat org.eclipse.ui.internal.Workbench.runUI(Workbench.java:1348)\n\tat org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:254)\n\tat org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:141)\n\tat org.eclipse.ui.internal.ide.IDEApplication.run(IDEApplication.java:96)\n\tat\norg.eclipse.core.internal.runtime.PlatformActivator$1.run(PlatformActivator.java:335)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:273)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:129)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)\n\tat java.lang.reflect.Method.invoke(Unknown Source)\n\tat org.eclipse.core.launcher.Main.basicRun(Main.java:183)\n\tat org.eclipse.core.launcher.Main.run(Main.java:644)\n\tat org.eclipse.core.launcher.Main.main(Main.java:628)",
    "Christof please comment",
    "In this case the event from SomePlugin\u0027s store has its new value set to the\ndefault-default value. The ChainedPreferenceStore correctly detects that the\nproperty was removed from SomePlugin\u0027s store, but then incorrectly \u0027asserts\u0027\nthat the new value in the event is null.\n",
    "Consequently, layering of property values with the first store reporting a\nnewValue !\u003d null when the property is setToDefault (without explicit default\nvalue in this store) does not work.\n\nThe fix is to remove that assertion, which is too restrictive. Consider fix for\n3.0.1.\n",
    "Fixed in post-3.0 builds \u003e20040712\n\nKeeping open in case a fix goes into 3.0.1\n",
    "Created an attachment (id\u003d13147)\nProposed patch for 3.0.1\n\nThe patch removes the assertion. The fix in HEAD is more elaborate in that it\nalso provides fallbacks for two other cases for which there are no PRs yet. I\nsuggest to also consider these cases for inclusion into 3.0.1.",
    "Created an attachment (id\u003d13149)\nThe fix in HEAD (for completeness)\n",
    "Can you explain the cases\n- is it critical i.e. what happens if we don\u0027t fix it for 3.0.1\n- risk of fix",
    "Assertion exception is not the only problem with the code in description.\n\nThe line \"store.setValue(key, \"8\");\" produces wrong event:\noldValue \u003d 0, newValue \u003d 8\nBut EditorsUI PreferenceStore has a default value for the property set to 4, and\nevent should be then:\noldValue \u003d 4, newValue \u003d 8\n\nRemoving assertion solves the problem with removal of property from first store,\nbut does not solve problem with wrong event when adding property to this store.\nI tried to analyze the sources and it seems to me that fix could not be done\npropery because at the time ChainedPreferenceStore has received a PropertyChange\nevent from first store it could not be determined if new propery was added to\nthe store or store has some value already before setValue() called on it.",
    "Comment 8:\nTrue, setting oldValue to null would be an option and within the event\u0027s\nspecification: \"The old value of the changed property, or \u003ccode\u003enull\u003c/code\u003e if\nnot known or not relevant.\" Working with the Settings API like\nPreferenceForwarder does could yield better results here. The Settings API\nspecifies the event\u0027s oldValue as: \"Return the old value for the preference or\n\u003ccode\u003enull\u003c/code\u003e if the preference was removed or if it cannot be determined.\"\nNeeds investigation.\n\nComment 7:\nThe additional fixes are:\n- in getOtherValue(): instead of throwing an IAE when thisValue (one of the\nevent values which can be null) is null, assume we deal with a String property.\nthisValue is used here for determining the property\u0027s type only.\n- in handlePropertyChangeEvent(): remove an assertion which assumed that if the\nvisible store is the same as the store from which the event came newValue is\nnon-null - this is not necessarily the case. Instead read the String value from\nthe visible store.\n\nI\u0027m not aware of PRs for these two cases, fixing them would be low risk.\n",
    "The two cases from the previous comment are triggered by:\n- in getOtherValue(): There are at least two stores in the chain, the second\nstore contains some property and the first store emits an event with that\nproperty and an oldValue \u003d\u003d null (and at this point the second store is the\nvisible store for this property).\n- in handlePropertyChangeEvent(): the visible store for some property emits an\nevent with newValue \u003d\u003d null (and still contains the property)\n\nBoth cases are with the spec and should be handled. More investigation would be\nneeded to assess whether with the current uses of the CPS these cases could\noccur (if decidable at all).\n",
    "OK to fix for 3.0.1: we had Assert.notNull for event\u0027s old and new values which\nwere explicitly specified that null is a valid value.\n\nFixed.\nReleased into M200407210800.\n",
    "Verified in M200409010800."
  ],
  "commentCreationDates": [
    "2004-07-06T23:30:56+02:00",
    "2004-07-07T16:55:30+02:00",
    "2004-07-08T10:05:29+02:00",
    "2004-07-08T15:07:38+02:00",
    "2004-07-12T16:05:53+02:00",
    "2004-07-12T16:13:41+02:00",
    "2004-07-12T16:16:31+02:00",
    "2004-07-12T16:28:14+02:00",
    "2004-07-12T16:45:24+02:00",
    "2004-07-12T19:07:47+02:00",
    "2004-07-19T16:06:59+02:00",
    "2004-07-21T12:17:49+02:00",
    "2004-09-02T10:36:42+02:00"
  ],
  "traces": [
    {
      "exceptionType": "org.eclipse.jface.util.Assert$AssertionFailedException",
      "message": "Assertion failed:",
      "elements": [
        {
          "method": "org.eclipse.jface.util.Assert.isTrue",
          "source": "Assert.java:168"
        },
        {
          "method": "org.eclipse.jface.util.Assert.isTrue",
          "source": "Assert.java:154"
        },
        {
          "method": "org.eclipse.ui.texteditor.ChainedPreferenceStore.handlePropertyChangeEvent",
          "source": "ChainedPreferenceStore.java:473"
        },
        {
          "method": "org.eclipse.ui.texteditor.ChainedPreferenceStore.access$0",
          "source": "ChainedPreferenceStore.java:406"
        },
        {
          "method": "org.eclipse.ui.texteditor.ChainedPreferenceStore$PropertyChangeListener.propertyChange",
          "source": "ChainedPreferenceStore.java:68"
        },
        {
          "method": "org.eclipse.ui.plugin.AbstractUIPlugin$2.run",
          "source": "AbstractUIPlugin.java:267"
        },
        {
          "method": "org.eclipse.core.internal.runtime.InternalPlatform.run",
          "source": "InternalPlatform.java:615"
        },
        {
          "method": "org.eclipse.core.runtime.Platform.run",
          "source": "Platform.java:747"
        },
        {
          "method": "org.eclipse.ui.plugin.AbstractUIPlugin$CompatibilityPreferenceStore.firePropertyChangeEvent",
          "source": "AbstractUIPlugin.java:265"
        },
        {
          "method": "org.eclipse.ui.plugin.AbstractUIPlugin$1.propertyChange",
          "source": "AbstractUIPlugin.java:205"
        },
        {
          "method": "org.eclipse.core.internal.preferences.PreferenceForwarder.preferenceChange",
          "source": "PreferenceForwarder.java:115"
        },
        {
          "method": "org.eclipse.core.internal.preferences.EclipsePreferences$4.run",
          "source": "EclipsePreferences.java:743"
        },
        {
          "method": "org.eclipse.core.internal.runtime.InternalPlatform.run",
          "source": "InternalPlatform.java:615"
        },
        {
          "method": "org.eclipse.core.runtime.Platform.run",
          "source": "Platform.java:747"
        },
        {
          "method": "org.eclipse.core.internal.preferences.EclipsePreferences.preferenceChanged",
          "source": "EclipsePreferences.java:746"
        },
        {
          "method": "org.eclipse.core.internal.preferences.EclipsePreferences.internalRemove",
          "source": "EclipsePreferences.java:560"
        },
        {
          "method": "org.eclipse.core.internal.preferences.EclipsePreferences.remove",
          "source": "EclipsePreferences.java:863"
        },
        {
          "method": "org.eclipse.core.internal.preferences.PreferenceForwarder.setToDefault",
          "source": "PreferenceForwarder.java:680"
        },
        {
          "method": "org.eclipse.ui.plugin.AbstractUIPlugin$CompatibilityPreferenceStore.setToDefault",
          "source": "AbstractUIPlugin.java:439"
        },
        {
          "method": "ChainedPreferenceStoreBug.popup.actions.NewAction.run",
          "source": "NewAction.java:52"
        },
        {
          "method": "org.eclipse.ui.internal.PluginAction.runWithEvent",
          "source": "PluginAction.java:276"
        },
        {
          "method": "org.eclipse.jface.action.ActionContributionItem.handleWidgetSelection",
          "source": "ActionContributionItem.java:915"
        },
        {
          "method": "org.eclipse.jface.action.ActionContributionItem.access$2",
          "source": "ActionContributionItem.java:866"
        },
        {
          "method": "org.eclipse.jface.action.ActionContributionItem$7.handleEvent",
          "source": "ActionContributionItem.java:785"
        },
        {
          "method": "org.eclipse.swt.widgets.EventTable.sendEvent",
          "source": "EventTable.java:82"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:796"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.runDeferredEvents",
          "source": "Display.java:2772"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.readAndDispatch",
          "source": "Display.java:2431"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runEventLoop",
          "source": "Workbench.java:1377"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runUI",
          "source": "Workbench.java:1348"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.createAndRunWorkbench",
          "source": "Workbench.java:254"
        },
        {
          "method": "org.eclipse.ui.PlatformUI.createAndRunWorkbench",
          "source": "PlatformUI.java:141"
        },
        {
          "method": "org.eclipse.ui.internal.ide.IDEApplication.run",
          "source": "IDEApplication.java:96"
        },
        {
          "method": "org.eclipse.core.internal.runtime.PlatformActivator$1.run",
          "source": "PlatformActivator.java:335"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:273"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:129"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "Unknown Source"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "Unknown Source"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.launcher.Main.basicRun",
          "source": "Main.java:183"
        },
        {
          "method": "org.eclipse.core.launcher.Main.run",
          "source": "Main.java:644"
        },
        {
          "method": "org.eclipse.core.launcher.Main.main",
          "source": "Main.java:628"
        }
      ],
      "number": 0,
      "commentIndex": 0,
      "bugId": "69419",
      "date": "2004-07-06T23:30:56+02:00",
      "product": "Platform",
      "component": "Text",
      "severity": "normal"
    }
  ],
  "groupId": "69419",
  "bugId": "69419",
  "date": "2004-07-06T23:30:56+02:00",
  "product": "Platform",
  "component": "Text",
  "severity": "normal"
}