{
  "comments": [
    "I20061026-0010\n\nWe need API to unregister the drop target that has been added using IDragAndDropService.addMergedDropTarget(...) since we need to offer a preference to enable and disable text DnD.\n\nWe know there is a workaround but we want a way to cleanly remove the drop target.",
    "Daniel, I\u0027ve talked this over with Boris and we\u0027ll make the change in M4.",
    "thanks.",
    "Deferring implementation to M5 so taht we can all synch up.",
    "Created an attachment (id\u003d55333)\nPatch to define / implement the remove API\n\n",
    "\nCommitted - \u003e20070205. Added a \u0027removeMergedDropTarget\u0027 method.\n",
    "\nVerified in I20070206-0010.\n",
    "Based on I20070206-0010 I have to reopen this bug because it does not work. Your code does not remove the drop listener from the control and hence when calling addMergedDropTarget(...) a second time to enable the text DnD again an exceptionm is thrown (see stack trace below).\n\nThere seems to be no SWT API to remove a drop target and a drag source from a control once it is added, so either you have to workaround that limitation and manage the drop targets on your side or request API from SWT that allows to remove the drop target (and in the same step also allow to remove the drag source).\n\n!ENTRY org.eclipse.ui 4 0 2007-02-07 09:56:17.653\n!MESSAGE Unhandled event loop exception\n!STACK 0\norg.eclipse.swt.SWTError: Cannot initialize Drop\n\tat org.eclipse.swt.dnd.DND.error(DND.java:247)\n\tat org.eclipse.swt.dnd.DND.error(DND.java:208)\n\tat org.eclipse.swt.dnd.DropTarget.\u003cinit\u003e(DropTarget.java:130)\n\tat org.eclipse.ui.internal.EditorSiteDragAndDropServiceImpl$MergedDropTarget.\u003cinit\u003e(EditorSiteDragAndDropServiceImpl.java:70)\n\tat org.eclipse.ui.internal.EditorSiteDragAndDropServiceImpl.addMergedDropTarget(EditorSiteDragAndDropServiceImpl.java:157)\n\tat org.eclipse.ui.texteditor.AbstractTextEditor.installTextDragAndDrop(AbstractTextEditor.java:3193)\n\tat org.eclipse.ui.texteditor.AbstractTextEditor.handlePreferenceStoreChanged(AbstractTextEditor.java:4011)\n\tat org.eclipse.ui.texteditor.AbstractDecoratedTextEditor.handlePreferenceStoreChanged(AbstractDecoratedTextEditor.java:752)\n\tat org.eclipse.ui.editors.text.TextEditor.handlePreferenceStoreChanged(TextEditor.java:217)\n\tat org.eclipse.ui.texteditor.AbstractTextEditor$PropertyChangeListener.propertyChange(AbstractTextEditor.java:631)\n\tat org.eclipse.ui.preferences.ScopedPreferenceStore$3.run(ScopedPreferenceStore.java:371)\n\tat org.eclipse.core.runtime.SafeRunner.run(SafeRunner.java:37)\n\tat org.eclipse.ui.preferences.ScopedPreferenceStore.firePropertyChangeEvent(ScopedPreferenceStore.java:368)\n\tat org.eclipse.ui.preferences.ScopedPreferenceStore.setValue(ScopedPreferenceStore.java:806)\n\tat org.eclipse.ui.internal.editors.text.OverlayPreferenceStore.propagateProperty(OverlayPreferenceStore.java:143)\n\tat org.eclipse.ui.internal.editors.text.OverlayPreferenceStore.propagate(OverlayPreferenceStore.java:188)\n\tat org.eclipse.ui.internal.editors.text.TextEditorDefaultsPreferencePage.performOk(TextEditorDefaultsPreferencePage.java:752)\n\tat org.eclipse.jface.preference.PreferencePage.performApply(PreferencePage.java:431)\n\tat org.eclipse.jface.preference.PreferencePage$2.widgetSelected(PreferencePage.java:282)\n\tat org.eclipse.swt.widgets.TypedListener.handleEvent(TypedListener.java:215)\n\tat org.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:66)\n\tat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:938)\n\tat org.eclipse.swt.widgets.Display.runDeferredEvents(Display.java:3490)\n\tat org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:3104)\n\tat org.eclipse.jface.window.Window.runEventLoop(Window.java:820)\n\tat org.eclipse.jface.window.Window.open(Window.java:796)\n\tat org.eclipse.ui.internal.OpenPreferencesAction.run(OpenPreferencesAction.java:65)\n\tat org.eclipse.jface.action.Action.runWithEvent(Action.java:498)\n\tat org.eclipse.jface.action.ActionContributionItem.handleWidgetSelection(ActionContributionItem.java:545)\n\tat org.eclipse.jface.action.ActionContributionItem.access$2(ActionContributionItem.java:490)\n\tat org.eclipse.jface.action.ActionContributionItem$5.handleEvent(ActionContributionItem.java:402)\n\tat org.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:66)\n\tat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:938)\n\tat org.eclipse.swt.widgets.Display.runDeferredEvents(Display.java:3490)\n\tat org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:3104)\n\tat org.eclipse.ui.internal.Workbench.runEventLoop(Workbench.java:2264)\n\tat org.eclipse.ui.internal.Workbench.runUI(Workbench.java:2228)\n\tat org.eclipse.ui.internal.Workbench.access$4(Workbench.java:2103)\n\tat org.eclipse.ui.internal.Workbench$4.run(Workbench.java:457)\n\tat org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:289)\n\tat org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:452)\n\tat org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:149)\n\tat org.eclipse.ui.internal.ide.application.IDEApplication.start(IDEApplication.java:101)\n\tat org.eclipse.equinox.internal.app.EclipseAppHandle.run(EclipseAppHandle.java:146)\n\tat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(EclipseAppLauncher.java:106)\n\tat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(EclipseAppLauncher.java:76)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:354)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:169)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:585)\n\tat org.eclipse.equinox.launcher.Main.invokeFramework(Main.java:476)\n\tat org.eclipse.equinox.launcher.Main.basicRun(Main.java:416)\n\tat org.eclipse.equinox.launcher.Main.run(Main.java:1124)\n\tat org.eclipse.equinox.launcher.Main.main(Main.java:1099)\n",
    "\nDaniel, gack! sorry dude. I\u0027d failed to \u0027dispose\u0027 the \u0027actualDropTarget\u0027 (the SWT DropTarget implementation) in my MergedDropTarget\u0027s dispose. I\u0027m in the process of fixing this and I\u0027ll get back once I\u0027m sure (this time!) that it\u0027s working...\n\nI\u0027m fairly sure that SWT cleans up its own listeners when the DropTarget gets disposed. If this turns out not to be the case I\u0027ll take it up with the SWT group.\n",
    "\nOK, I know how to fix this but to do so I\u0027m currently using a dangerous hack (not to worry, the code isn\u0027t checked in...;-).\n\nBefore I can create a \u0027merged\u0027 drop target I -must- dispose any existing drop target...this is stored in the control\u0027s \u0027data\u0027 with the tag \"DropTarget\" and works when I use it but it\u0027d be faaar safer if I was to use the DropTarget\u0027s \"DROPTARGETID\" constant...but it\u0027s not public...\n\nBTW, I found this using the \u0027org.eclipse.ui.examples.readmetool\u0027 project which was defining an editor and then using the \u0027addMergedDropTarget\u0027 to add text drops support to it. Now that this is already added by the base text editor I was getting the same stack trace on my \u0027add\u0027 call (i.e. as soon as the base class defined a drop target I couldn\u0027t add a merged one).\n\nDoung, we\u0027ll have to hash out -some- mechanism around this; either expose the data\u0027s ID or auto-dispose the existing DropTarget when a new one is defined (or any other reasonable approach that you can come up with...;-).\n",
    "See also bug 173410.",
    "Created an attachment (id\u003d58663)\nPatch to dispose any previous DropTarget using \u0027magic\u0027 propId\n\n\nJust capturing necessary code changes...\n\nThis patch should -not- be committed without first switching it to use a genuine SWT constant for the \"DropTarget\" prop id...\n\n",
    "The remove in this case really isn\u0027t mirroring the add.  With this patch I might be able to call add multiple times for different DropTargetListeners, but I can\u0027t remove them individually.",
    "\u003eWith this patch I\n\u003emight be able to call add multiple times for different DropTargetListeners, but\n\u003eI can\u0027t remove them individually.\nWell in fact it\u0027s worse: you can\u0027t even call addMergedDropTarget(...) more than once for the same control otherwise you run into the same problem like the remove. See also bug 173410.\n\nThe correct solution is to\n1. use a DelegatingDropAdapter\n2. add IDragAndDropService.removeMergedDropTarget(DropTargetListener)\n3. in the Javadoc of removeMergedDropTarget(Control) write that this will\n   remove all registered listeners and should be used carefully.\n\nHTH\nDani",
    "The behavior in comment 13 means it\u0027s not conforming to its own doc.\n\nThe DelegatingDropAdapter wouldn\u0027t do SSE much good, unfortunately, since we need to be able to modify the list of Transfers dynamically.  If the MergedDropTarget.realDropTarget was actually disposed of as mentioned in comment 8 (bug 173410 doesn\u0027t need to be fixed for that to happen), callers could swap out the transfer list at will.  Then the only sticking point for us would be that we\u0027re still not supposed to talk to the viewer\u0027s widget directly anyway.",
    "Adjusting target so that it doesn\u0027t get lost.",
    "\nCommitted in \u003e20070316. \n\nI now dispose -any- existing drop target before creating the new one. I\u0027ve been in discussion with the SWT team regarding the solution to this defect (which is to gain access to the current DropTarget for a control using \u0027internal\u0027 knowledge) and we have agreed that we\u0027d rather go with this solution for now and that post 3.3 we\u0027ll come up with a more viable SWT API for drag and drop in general...\n",
    "\u003eI now dispose -any- existing drop target before creating the new one. \nOK - but I assume you also do this directly after I call the remove method.",
    "\u003epost 3.3 we\u0027ll come up with a more viable SWT API for drag and drop in\n\u003egeneral...\nIs there a bug for this? Note that I have the same problem with the drag source: I currently can\u0027t remove it when the user disables DND (see SWT bug 173410).",
    "\nDani, there is indeed a bug for this (I made Doung open one as my compromise for using the current API..;-). Unfortunately I can\u0027t find it at the moment.\n",
    "Here are the open SWT bugs filed bug Duong:\nhttps://bugs.eclipse.org/bugs/buglist.cgi?query_format\u003dadvanced\u0026short_desc_type\u003dallwordssubstr\u0026short_desc\u003d\u0026classification\u003dEclipse\u0026product\u003dPlatform\u0026component\u003dSWT\u0026long_desc_type\u003dallwordssubstr\u0026long_desc\u003d\u0026bug_file_loc_type\u003dallwordssubstr\u0026bug_file_loc\u003d\u0026status_whiteboard_type\u003dallwordssubstr\u0026status_whiteboard\u003d\u0026keywords_type\u003dallwords\u0026keywords\u003d\u0026bug_status\u003dUNCONFIRMED\u0026bug_status\u003dNEW\u0026bug_status\u003dASSIGNED\u0026bug_status\u003dREOPENED\u0026emailreporter1\u003d1\u0026emailtype1\u003dsubstring\u0026email1\u003dDuong\u0026emailtype2\u003dsubstring\u0026email2\u003d\u0026bugidtype\u003dinclude\u0026bug_id\u003d\u0026votes\u003d\u0026chfieldfrom\u003d\u0026chfieldto\u003dNow\u0026chfieldvalue\u003d\u0026cmdtype\u003ddoit\u0026order\u003dReuse+same+sort+as+last+time\u0026field0-0-0\u003dnoop\u0026type0-0-0\u003dnoop\u0026value0-0-0\u003d\n\nI guess he didn\u0027t follow yor advice. Duong, do you have the bug number?",
    "\nHe emailed it to me, wait until I get to Notes tomorrow.\n",
    "Sorry guys. I thought I created a new bug report already but I can\u0027t find it either. I believe I may have been using bug 173410 and emailing it to Eric.\n\nI just created a new one.\nhttps://bugs.eclipse.org/bugs/show_bug.cgi?id\u003d178104\n\nPlease add your comments to that defect to describe your needs.\nThanks.",
    "\nVerified in 20070321-0010.\n"
  ],
  "commentCreationDates": [
    "2006-10-25T14:03:47+02:00",
    "2006-10-25T16:04:09+02:00",
    "2006-10-25T16:06:53+02:00",
    "2006-12-08T19:46:37+01:00",
    "2006-12-08T19:50:06+01:00",
    "2007-02-05T20:56:01+01:00",
    "2007-02-06T14:38:09+01:00",
    "2007-02-07T09:02:04+01:00",
    "2007-02-07T19:06:18+01:00",
    "2007-02-07T20:30:29+01:00",
    "2007-02-08T08:32:52+01:00",
    "2007-02-09T15:48:44+01:00",
    "2007-02-09T20:15:53+01:00",
    "2007-02-10T07:33:26+01:00",
    "2007-02-12T19:26:35+01:00",
    "2007-03-16T14:47:55+01:00",
    "2007-03-16T14:51:45+01:00",
    "2007-03-16T15:06:36+01:00",
    "2007-03-18T17:01:28+01:00",
    "2007-03-18T21:28:59+01:00",
    "2007-03-18T22:29:01+01:00",
    "2007-03-19T00:03:02+01:00",
    "2007-03-19T18:50:20+01:00",
    "2007-03-21T14:55:33+01:00"
  ],
  "traces": [
    {
      "exceptionType": "org.eclipse.swt.SWTError",
      "message": "Cannot initialize Drop",
      "elements": [
        {
          "method": "org.eclipse.swt.dnd.DND.error",
          "source": "DND.java:247"
        },
        {
          "method": "org.eclipse.swt.dnd.DND.error",
          "source": "DND.java:208"
        },
        {
          "method": "org.eclipse.swt.dnd.DropTarget.\u003cinit\u003e",
          "source": "DropTarget.java:130"
        },
        {
          "method": "org.eclipse.ui.internal.EditorSiteDragAndDropServiceImpl$MergedDropTarget.\u003cinit\u003e",
          "source": "EditorSiteDragAndDropServiceImpl.java:70"
        },
        {
          "method": "org.eclipse.ui.internal.EditorSiteDragAndDropServiceImpl.addMergedDropTarget",
          "source": "EditorSiteDragAndDropServiceImpl.java:157"
        },
        {
          "method": "org.eclipse.ui.texteditor.AbstractTextEditor.installTextDragAndDrop",
          "source": "AbstractTextEditor.java:3193"
        },
        {
          "method": "org.eclipse.ui.texteditor.AbstractTextEditor.handlePreferenceStoreChanged",
          "source": "AbstractTextEditor.java:4011"
        },
        {
          "method": "org.eclipse.ui.texteditor.AbstractDecoratedTextEditor.handlePreferenceStoreChanged",
          "source": "AbstractDecoratedTextEditor.java:752"
        },
        {
          "method": "org.eclipse.ui.editors.text.TextEditor.handlePreferenceStoreChanged",
          "source": "TextEditor.java:217"
        },
        {
          "method": "org.eclipse.ui.texteditor.AbstractTextEditor$PropertyChangeListener.propertyChange",
          "source": "AbstractTextEditor.java:631"
        },
        {
          "method": "org.eclipse.ui.preferences.ScopedPreferenceStore$3.run",
          "source": "ScopedPreferenceStore.java:371"
        },
        {
          "method": "org.eclipse.core.runtime.SafeRunner.run",
          "source": "SafeRunner.java:37"
        },
        {
          "method": "org.eclipse.ui.preferences.ScopedPreferenceStore.firePropertyChangeEvent",
          "source": "ScopedPreferenceStore.java:368"
        },
        {
          "method": "org.eclipse.ui.preferences.ScopedPreferenceStore.setValue",
          "source": "ScopedPreferenceStore.java:806"
        },
        {
          "method": "org.eclipse.ui.internal.editors.text.OverlayPreferenceStore.propagateProperty",
          "source": "OverlayPreferenceStore.java:143"
        },
        {
          "method": "org.eclipse.ui.internal.editors.text.OverlayPreferenceStore.propagate",
          "source": "OverlayPreferenceStore.java:188"
        },
        {
          "method": "org.eclipse.ui.internal.editors.text.TextEditorDefaultsPreferencePage.performOk",
          "source": "TextEditorDefaultsPreferencePage.java:752"
        },
        {
          "method": "org.eclipse.jface.preference.PreferencePage.performApply",
          "source": "PreferencePage.java:431"
        },
        {
          "method": "org.eclipse.jface.preference.PreferencePage$2.widgetSelected",
          "source": "PreferencePage.java:282"
        },
        {
          "method": "org.eclipse.swt.widgets.TypedListener.handleEvent",
          "source": "TypedListener.java:215"
        },
        {
          "method": "org.eclipse.swt.widgets.EventTable.sendEvent",
          "source": "EventTable.java:66"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:938"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.runDeferredEvents",
          "source": "Display.java:3490"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.readAndDispatch",
          "source": "Display.java:3104"
        },
        {
          "method": "org.eclipse.jface.window.Window.runEventLoop",
          "source": "Window.java:820"
        },
        {
          "method": "org.eclipse.jface.window.Window.open",
          "source": "Window.java:796"
        },
        {
          "method": "org.eclipse.ui.internal.OpenPreferencesAction.run",
          "source": "OpenPreferencesAction.java:65"
        },
        {
          "method": "org.eclipse.jface.action.Action.runWithEvent",
          "source": "Action.java:498"
        },
        {
          "method": "org.eclipse.jface.action.ActionContributionItem.handleWidgetSelection",
          "source": "ActionContributionItem.java:545"
        },
        {
          "method": "org.eclipse.jface.action.ActionContributionItem.access$2",
          "source": "ActionContributionItem.java:490"
        },
        {
          "method": "org.eclipse.jface.action.ActionContributionItem$5.handleEvent",
          "source": "ActionContributionItem.java:402"
        },
        {
          "method": "org.eclipse.swt.widgets.EventTable.sendEvent",
          "source": "EventTable.java:66"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:938"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.runDeferredEvents",
          "source": "Display.java:3490"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.readAndDispatch",
          "source": "Display.java:3104"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runEventLoop",
          "source": "Workbench.java:2264"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runUI",
          "source": "Workbench.java:2228"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.access$4",
          "source": "Workbench.java:2103"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench$4.run",
          "source": "Workbench.java:457"
        },
        {
          "method": "org.eclipse.core.databinding.observable.Realm.runWithDefault",
          "source": "Realm.java:289"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.createAndRunWorkbench",
          "source": "Workbench.java:452"
        },
        {
          "method": "org.eclipse.ui.PlatformUI.createAndRunWorkbench",
          "source": "PlatformUI.java:149"
        },
        {
          "method": "org.eclipse.ui.internal.ide.application.IDEApplication.start",
          "source": "IDEApplication.java:101"
        },
        {
          "method": "org.eclipse.equinox.internal.app.EclipseAppHandle.run",
          "source": "EclipseAppHandle.java:146"
        },
        {
          "method": "org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication",
          "source": "EclipseAppLauncher.java:106"
        },
        {
          "method": "org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start",
          "source": "EclipseAppLauncher.java:76"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:354"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:169"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "NativeMethodAccessorImpl.java:39"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "DelegatingMethodAccessorImpl.java:25"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Method.java:585"
        },
        {
          "method": "org.eclipse.equinox.launcher.Main.invokeFramework",
          "source": "Main.java:476"
        },
        {
          "method": "org.eclipse.equinox.launcher.Main.basicRun",
          "source": "Main.java:416"
        },
        {
          "method": "org.eclipse.equinox.launcher.Main.run",
          "source": "Main.java:1124"
        },
        {
          "method": "org.eclipse.equinox.launcher.Main.main",
          "source": "Main.java:1099"
        }
      ],
      "number": 0,
      "commentIndex": 7,
      "bugId": "162192",
      "date": "2007-02-07T09:02:04+01:00",
      "product": "Platform",
      "component": "UI",
      "severity": "normal"
    }
  ],
  "groupId": "162192",
  "bugId": "162192",
  "date": "2006-10-25T14:03:47+02:00",
  "product": "Platform",
  "component": "UI",
  "severity": "normal"
}