{
  "comments": [
    "I20071030-0010.\n\nI changed a file and wanted to commit it but before I of course want to see what I commit and hence look at the diff. When doing so I get an AFE in the .log and a blank compare editor (see attached picture).\n\nI\u0027m marking this as critical because it currently blocks my work, especially because there is no fall back to simple text compare.\n\nTest Case:\n1. load org.eclipse.jdt.ui from HEAD\n2. load plugin.xml rev 1.772 (as sticky revision)\n3. paste the contents of the attached file over the existing one and save\n4. Compare With \u003e Version 1.772\n\n\u003d\u003d\u003e\n\norg.eclipse.swt.SWTException: Failed to execute runnable (org.eclipse.core.runtime.AssertionFailedException: assertion failed: )\nat org.eclipse.swt.SWT.error(SWT.java:3706)\nat org.eclipse.swt.SWT.error(SWT.java:3624)\nat org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:127)\nat org.eclipse.swt.widgets.Display.runAsyncMessages(Display.java:3721)\nat org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:3358)\nat org.eclipse.ui.internal.Workbench.runEventLoop(Workbench.java:2395)\nat org.eclipse.ui.internal.Workbench.runUI(Workbench.java:2359)\nat org.eclipse.ui.internal.Workbench.access$4(Workbench.java:2225)\nat org.eclipse.ui.internal.Workbench$4.run(Workbench.java:468)\nat org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:288)\nat org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:463)\nat org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:149)\nat org.eclipse.ui.internal.ide.application.IDEApplication.start(IDEApplication.java:106)\nat org.eclipse.equinox.internal.app.EclipseAppHandle.run(EclipseAppHandle.java:193)\nat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(EclipseAppLauncher.java:106)\nat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(EclipseAppLauncher.java:76)\nat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:362)\nat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:175)\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\nat java.lang.reflect.Method.invoke(Method.java:597)\nat org.eclipse.equinox.launcher.Main.invokeFramework(Main.java:515)\nat org.eclipse.equinox.launcher.Main.basicRun(Main.java:455)\nat org.eclipse.equinox.launcher.Main.run(Main.java:1193)\nat org.eclipse.equinox.launcher.Main.main(Main.java:1169)\nat org.eclipse.core.launcher.Main.main(Main.java:30)\nCaused by: org.eclipse.core.runtime.AssertionFailedException: assertion failed:\nat org.eclipse.core.runtime.Assert.isTrue(Assert.java:109)\nat org.eclipse.core.runtime.Assert.isTrue(Assert.java:95)\nat org.eclipse.jface.text.Position.\u003cinit\u003e(Position.java:63)\nat org.eclipse.compare.structuremergeviewer.DocumentRangeNode.registerPositionUpdater(DocumentRangeNode.java:103)\nat org.eclipse.compare.structuremergeviewer.DocumentRangeNode.\u003cinit\u003e(DocumentRangeNode.java:98)\nat org.eclipse.pde.internal.ui.compare.PluginStructureCreator$PluginNode.\u003cinit\u003e(PluginStructureCreator.java:41)\nat org.eclipse.pde.internal.ui.compare.PluginStructureCreator.createNode(PluginStructureCreator.java:214)\nat org.eclipse.pde.internal.ui.compare.PluginStructureCreator.createExtensions(PluginStructureCreator.java:201)\nat org.eclipse.pde.internal.ui.compare.PluginStructureCreator.createChildren(PluginStructureCreator.java:163)\nat org.eclipse.pde.internal.ui.compare.PluginStructureCreator.parsePlugin(PluginStructureCreator.java:128)\nat org.eclipse.pde.internal.ui.compare.PluginStructureCreator.createStructureComparator(PluginStructureCreator.java:93)\nat org.eclipse.compare.structuremergeviewer.StructureCreator.internalCreateStructure(StructureCreator.java:102)\nat org.eclipse.compare.structuremergeviewer.StructureCreator.access$0(StructureCreator.java:90)\nat org.eclipse.compare.structuremergeviewer.StructureCreator$1.run(StructureCreator.java:80)\nat org.eclipse.swt.custom.BusyIndicator.showWhile(BusyIndicator.java:67)\nat org.eclipse.compare.internal.Utilities.runInUIThread(Utilities.java:755)\nat org.eclipse.compare.structuremergeviewer.StructureCreator.createStructure(StructureCreator.java:83)\nat org.eclipse.compare.structuremergeviewer.StructureDiffViewer$StructureInfo.createStructure(StructureDiffViewer.java:157)\nat org.eclipse.compare.structuremergeviewer.StructureDiffViewer$StructureInfo.refresh(StructureDiffViewer.java:135)\nat org.eclipse.compare.structuremergeviewer.StructureDiffViewer$StructureInfo.setInput(StructureDiffViewer.java:106)\nat org.eclipse.compare.structuremergeviewer.StructureDiffViewer.compareInputChanged(StructureDiffViewer.java:349)\nat org.eclipse.compare.structuremergeviewer.StructureDiffViewer$2.run(StructureDiffViewer.java:73)\nat org.eclipse.compare.structuremergeviewer.StructureDiffViewer$6.run(StructureDiffViewer.java:324)\nat org.eclipse.swt.custom.BusyIndicator.showWhile(BusyIndicator.java:67)\nat org.eclipse.compare.structuremergeviewer.StructureDiffViewer.compareInputChanged(StructureDiffViewer.java:321)\nat org.eclipse.compare.structuremergeviewer.StructureDiffViewer.compareInputChanged(StructureDiffViewer.java:309)\nat org.eclipse.compare.structuremergeviewer.StructureDiffViewer.inputChanged(StructureDiffViewer.java:280)\nat org.eclipse.jface.viewers.ContentViewer.setInput(ContentViewer.java:251)\nat org.eclipse.jface.viewers.StructuredViewer.setInput(StructuredViewer.java:1603)\nat org.eclipse.compare.CompareViewerSwitchingPane.setInput(CompareViewerSwitchingPane.java:254)\nat org.eclipse.compare.CompareEditorInput.feedInput(CompareEditorInput.java:690)\nat org.eclipse.compare.CompareEditorInput.createContents(CompareEditorInput.java:524)\nat org.eclipse.compare.internal.CompareEditor.createCompareControl(CompareEditor.java:399)\nat org.eclipse.compare.internal.CompareEditor.access$2(CompareEditor.java:369)\nat org.eclipse.compare.internal.CompareEditor$3.run(CompareEditor.java:326)\nat org.eclipse.swt.widgets.RunnableLock.run(RunnableLock.java:35)\nat org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:124)\n... 24 more",
    "Created an attachment (id\u003d81748)\nnew contents for plugin.xml\n\n",
    "Created an attachment (id\u003d81749)\nPicture of corrupt compare editor\n\n",
    "I couldn\u0027t reproduce the issue. Tomek please look at it.",
    "Maybe you did not follow the steps exactly? Markus just tried here and he can reproduce with my steps from comment 0.",
    "Yup. I managed to reproduce it.",
    "My first thought was that it\u0027s Compare we should blame for the issue. Then I had a chat with Dani who suggested that, even though it might be caused by PDE\u0027s structure creator Compare should allow to fallback to simple compare. I couldn\u0027t argue with that :) I was happy to see that a mechanism of this kind is already there[1]. The only issue I can see is that the expected CoreException is never thrown, instead there is the AssertionFailedException mentioned by Dani in the summary. I\u0027m not saying that CoreException is an appropriate exception but I think the erroneous arguments[2] should be handled differently.\n\nMoving to PDE to comment.\n\n[1] org.eclipse.compare.structuremergeviewer.StructureCreator : lines 102-111\n[2] in this case either length or offset less than 0; see org.eclipse.jface.text.Position : line 62 and 63",
    "Tomek, first of all, you changed the component but not the assignee so it probably won\u0027t show up on the PDE radar. Also, although the code that is causing the problem lives in the PDE plug-in, it was provided by the Team team (i.e. me) and applied by Wassim who is no longer an active committer. I think it would be best if we provided a patch to PDE that fixed the problem since we understand the issue and I don;t think there is anyone on PDE who is familiar with this code. I\u0027ve taken the liberty of changing the component back to Compare.\n\nAs for Dani\u0027s suggestion, it is reasonable but it is really a matter of how much effort it would be. I think it would also be reasonable to modify the CompareEditorInput to gracefully ignore a failure to create a Structure Compare since the content could still be shown. I think we would still want to prompt the user to let them know that the structure creation failed but we wouldn\u0027t need to prevent the content from being shown. However, our first priority should be to fix the problem in the PDE structure creator. Once we have that, we should create a separate enhancement request to improve the robustness of the CompareEditorInput when there are exceptions when creating a structure viewer and a content merge viewer.",
    "Understood, sorry for the confusion.",
    "When PluginStructureCreator[1] prepares an input for the Compare Editor it parses both plugin.xmls (remote and local). As the result we get two plug-in models[2]. The one for remote resource is fine, the problem occurs when we are trying to load a model for the local (not well formed) resource. Actually, there is a SAXException thrown[3]. This results in the model not being fully loaded. Moreover, that is probably why one of it\u0027s nodes has length set to -1 (or not changed from a default value) and that\u0027s why at the end the AFE is thrown.\n\nI did figure out how to avoid the AFE being thrown. In PluginStructureCreator[1] I replace line 214 with: \n\nnew PluginNode(parent, type, labelProvider.getText(element), image, parent.getDocument(), node.getOffset(), Math.max(0, node.getLength()));\n\nBut this is a kludge.\n\n[1] org.eclipse.pde.ui/org.eclipse.pde.internal.ui.compare\n[2] org.eclipse.pde.core/org.eclipse.pde.internal.core.bundle.PluginModelBase\n[3] org.eclipse.pde.core/org.eclipse.pde.internal.core.text.XMLEditingModel, line 47",
    "Created an attachment (id\u003d83526)\nSAXException catched\n\nI\u0027ve created a patch which handles the case when the model is not loaded properly. Now, catching SAXException also results in creating a Status, which is later used to throw the CoreException. However, I can see some good and bad sides of this solution\n\nGood:\n* the AFE from comment 0 is replaced with CoreException (with SAXException as the root cause)\n* the error is logged\n* the user can use the comparison (compare contents)\n\nBad:\n* the CoreException is thrown every time the model is not fully loaded, this is not needed every time (ie there are some SAXExceptions which don\u0027t prevent from creating the structure compare)\n* if the CoreException is thrown, the user will get a compare editor with an empty structure compare pane\n\nAn other solution would be the check if parameters for the PluginNode[1] won\u0027t cause the AFE (ie values for Position[2] are greater than 0) and then throw the CoreException.\n\n[1] PluginStructureCreator.PluginNode\n[2] org.eclipse.jface.text.Position",
    "Szymon, could you take a look at the patch as you\u0027re an expert in error handling :)",
    "Using the same steps as I used when previously I was trying to reproduce the issue, I can\u0027t reproduce it now.\n\nXMLEditingModel#load(...) method has a worrying part...\n\n} catch (IOException e) {\n} catch (ParserConfigurationException e) {\n} catch (FactoryConfigurationError e) {\n}\n\nThere should be at least a comment in the catch clauses. Or the status should be set as well and the flag fLoaded should be set to false.\n\nThe statuses should use localized messages, moreover I would use a message like \"Model loading failed\" in the error status. \n\nFor the OK status, look at org.eclipse.core.runtime.Status.OK_STATUS.",
    "The exception is thrown while creating a structure for one of the input. Szymon, can you a structure compare pane there? ",
    "Nope. I can\u0027t see it. Moreover all texts in the left and right panes are black. It seems like an exception during comparing caused that the text compare view was used in an emergency."
  ],
  "commentCreationDates": [
    "2007-10-31T18:56:11+01:00",
    "2007-10-31T18:57:28+01:00",
    "2007-10-31T19:00:29+01:00",
    "2007-11-06T09:37:18+01:00",
    "2007-11-06T09:54:02+01:00",
    "2007-11-06T10:16:58+01:00",
    "2007-11-06T13:24:52+01:00",
    "2007-11-06T13:39:25+01:00",
    "2007-11-06T13:50:03+01:00",
    "2007-11-08T16:27:02+01:00",
    "2007-11-22T12:39:45+01:00",
    "2007-11-22T12:41:54+01:00",
    "2007-11-29T11:10:59+01:00",
    "2007-11-29T11:20:36+01:00",
    "2007-11-29T11:29:55+01:00"
  ],
  "traces": [
    {
      "exceptionType": "org.eclipse.core.runtime.AssertionFailedException",
      "message": "assertion failed: )",
      "elements": [
        {
          "method": "org.eclipse.swt.SWT.error",
          "source": "SWT.java:3706"
        },
        {
          "method": "org.eclipse.swt.SWT.error",
          "source": "SWT.java:3624"
        },
        {
          "method": "org.eclipse.swt.widgets.Synchronizer.runAsyncMessages",
          "source": "Synchronizer.java:127"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.runAsyncMessages",
          "source": "Display.java:3721"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.readAndDispatch",
          "source": "Display.java:3358"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runEventLoop",
          "source": "Workbench.java:2395"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runUI",
          "source": "Workbench.java:2359"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.access$4",
          "source": "Workbench.java:2225"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench$4.run",
          "source": "Workbench.java:468"
        },
        {
          "method": "org.eclipse.core.databinding.observable.Realm.runWithDefault",
          "source": "Realm.java:288"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.createAndRunWorkbench",
          "source": "Workbench.java:463"
        },
        {
          "method": "org.eclipse.ui.PlatformUI.createAndRunWorkbench",
          "source": "PlatformUI.java:149"
        },
        {
          "method": "org.eclipse.ui.internal.ide.application.IDEApplication.start",
          "source": "IDEApplication.java:106"
        },
        {
          "method": "org.eclipse.equinox.internal.app.EclipseAppHandle.run",
          "source": "EclipseAppHandle.java:193"
        },
        {
          "method": "org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication",
          "source": "EclipseAppLauncher.java:106"
        },
        {
          "method": "org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start",
          "source": "EclipseAppLauncher.java:76"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:362"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:175"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "NativeMethodAccessorImpl.java:39"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "DelegatingMethodAccessorImpl.java:25"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Method.java:597"
        },
        {
          "method": "org.eclipse.equinox.launcher.Main.invokeFramework",
          "source": "Main.java:515"
        },
        {
          "method": "org.eclipse.equinox.launcher.Main.basicRun",
          "source": "Main.java:455"
        },
        {
          "method": "org.eclipse.equinox.launcher.Main.run",
          "source": "Main.java:1193"
        },
        {
          "method": "org.eclipse.equinox.launcher.Main.main",
          "source": "Main.java:1169"
        },
        {
          "method": "org.eclipse.core.launcher.Main.main",
          "source": "Main.java:30"
        }
      ],
      "causedBy": {
        "exceptionType": "org.eclipse.core.runtime.AssertionFailedException",
        "message": "assertion failed:",
        "elements": [
          {
            "method": "org.eclipse.core.runtime.Assert.isTrue",
            "source": "Assert.java:109"
          },
          {
            "method": "org.eclipse.core.runtime.Assert.isTrue",
            "source": "Assert.java:95"
          },
          {
            "method": "org.eclipse.jface.text.Position.\u003cinit\u003e",
            "source": "Position.java:63"
          },
          {
            "method": "org.eclipse.compare.structuremergeviewer.DocumentRangeNode.registerPositionUpdater",
            "source": "DocumentRangeNode.java:103"
          },
          {
            "method": "org.eclipse.compare.structuremergeviewer.DocumentRangeNode.\u003cinit\u003e",
            "source": "DocumentRangeNode.java:98"
          },
          {
            "method": "org.eclipse.pde.internal.ui.compare.PluginStructureCreator$PluginNode.\u003cinit\u003e",
            "source": "PluginStructureCreator.java:41"
          },
          {
            "method": "org.eclipse.pde.internal.ui.compare.PluginStructureCreator.createNode",
            "source": "PluginStructureCreator.java:214"
          },
          {
            "method": "org.eclipse.pde.internal.ui.compare.PluginStructureCreator.createExtensions",
            "source": "PluginStructureCreator.java:201"
          },
          {
            "method": "org.eclipse.pde.internal.ui.compare.PluginStructureCreator.createChildren",
            "source": "PluginStructureCreator.java:163"
          },
          {
            "method": "org.eclipse.pde.internal.ui.compare.PluginStructureCreator.parsePlugin",
            "source": "PluginStructureCreator.java:128"
          },
          {
            "method": "org.eclipse.pde.internal.ui.compare.PluginStructureCreator.createStructureComparator",
            "source": "PluginStructureCreator.java:93"
          },
          {
            "method": "org.eclipse.compare.structuremergeviewer.StructureCreator.internalCreateStructure",
            "source": "StructureCreator.java:102"
          },
          {
            "method": "org.eclipse.compare.structuremergeviewer.StructureCreator.access$0",
            "source": "StructureCreator.java:90"
          },
          {
            "method": "org.eclipse.compare.structuremergeviewer.StructureCreator$1.run",
            "source": "StructureCreator.java:80"
          },
          {
            "method": "org.eclipse.swt.custom.BusyIndicator.showWhile",
            "source": "BusyIndicator.java:67"
          },
          {
            "method": "org.eclipse.compare.internal.Utilities.runInUIThread",
            "source": "Utilities.java:755"
          },
          {
            "method": "org.eclipse.compare.structuremergeviewer.StructureCreator.createStructure",
            "source": "StructureCreator.java:83"
          },
          {
            "method": "org.eclipse.compare.structuremergeviewer.StructureDiffViewer$StructureInfo.createStructure",
            "source": "StructureDiffViewer.java:157"
          },
          {
            "method": "org.eclipse.compare.structuremergeviewer.StructureDiffViewer$StructureInfo.refresh",
            "source": "StructureDiffViewer.java:135"
          },
          {
            "method": "org.eclipse.compare.structuremergeviewer.StructureDiffViewer$StructureInfo.setInput",
            "source": "StructureDiffViewer.java:106"
          },
          {
            "method": "org.eclipse.compare.structuremergeviewer.StructureDiffViewer.compareInputChanged",
            "source": "StructureDiffViewer.java:349"
          },
          {
            "method": "org.eclipse.compare.structuremergeviewer.StructureDiffViewer$2.run",
            "source": "StructureDiffViewer.java:73"
          },
          {
            "method": "org.eclipse.compare.structuremergeviewer.StructureDiffViewer$6.run",
            "source": "StructureDiffViewer.java:324"
          },
          {
            "method": "org.eclipse.swt.custom.BusyIndicator.showWhile",
            "source": "BusyIndicator.java:67"
          },
          {
            "method": "org.eclipse.compare.structuremergeviewer.StructureDiffViewer.compareInputChanged",
            "source": "StructureDiffViewer.java:321"
          },
          {
            "method": "org.eclipse.compare.structuremergeviewer.StructureDiffViewer.compareInputChanged",
            "source": "StructureDiffViewer.java:309"
          },
          {
            "method": "org.eclipse.compare.structuremergeviewer.StructureDiffViewer.inputChanged",
            "source": "StructureDiffViewer.java:280"
          },
          {
            "method": "org.eclipse.jface.viewers.ContentViewer.setInput",
            "source": "ContentViewer.java:251"
          },
          {
            "method": "org.eclipse.jface.viewers.StructuredViewer.setInput",
            "source": "StructuredViewer.java:1603"
          },
          {
            "method": "org.eclipse.compare.CompareViewerSwitchingPane.setInput",
            "source": "CompareViewerSwitchingPane.java:254"
          },
          {
            "method": "org.eclipse.compare.CompareEditorInput.feedInput",
            "source": "CompareEditorInput.java:690"
          },
          {
            "method": "org.eclipse.compare.CompareEditorInput.createContents",
            "source": "CompareEditorInput.java:524"
          },
          {
            "method": "org.eclipse.compare.internal.CompareEditor.createCompareControl",
            "source": "CompareEditor.java:399"
          },
          {
            "method": "org.eclipse.compare.internal.CompareEditor.access$2",
            "source": "CompareEditor.java:369"
          },
          {
            "method": "org.eclipse.compare.internal.CompareEditor$3.run",
            "source": "CompareEditor.java:326"
          },
          {
            "method": "org.eclipse.swt.widgets.RunnableLock.run",
            "source": "RunnableLock.java:35"
          },
          {
            "method": "org.eclipse.swt.widgets.Synchronizer.runAsyncMessages",
            "source": "Synchronizer.java:124"
          }
        ],
        "number": 0,
        "commentIndex": 0
      },
      "number": 0,
      "commentIndex": 0,
      "bugId": "208291",
      "date": "2007-10-31T18:56:11+01:00",
      "product": "Platform",
      "component": "Compare",
      "severity": "critical"
    }
  ],
  "groupId": "208291",
  "bugId": "208291",
  "date": "2007-10-31T18:56:11+01:00",
  "product": "Platform",
  "component": "Compare",
  "severity": "critical"
}