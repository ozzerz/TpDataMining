{
  "comments": [
    "WTP I20041220, M4, JDK 1.4.2\n\nSteps to reproduce:\nHaving two JSP files test.jsp and test2.jsp where test.jsp contains a scriptlet\nand includes test2.jsp, whereas test2.jsp contains a page import directive.\nSource formatting on test.jsp leads to NPE and eleminates the include token in\nthe test.jsp file.\n\ntest.jsp:\n\u003chtml\u003e\n\u003cbody\u003e\n\u003c%@include file\u003d\"test3.jsp\"%\u003e\n\u003c% System.out.println(\"test\"); %\n\u003c/body\u003e\n\u003c/html\u003e\n\ntest2.jsp:\n\u003c%@page import\u003d\"java.lang.*\"%\u003e\n\u003cp\u003esample header\u003c/p\u003e\n\n\nNPE:\njava.lang.NullPointerException\n\tat\norg.eclipse.wst.sse.ui.StructuredTextReconciler.partitionChanged(StructuredTextReconciler.java:468)\n\tat\norg.eclipse.wst.sse.ui.StructuredTextReconciler.nodesReplaced(StructuredTextReconciler.java:440)\n\tat\norg.eclipse.wst.sse.core.internal.text.BasicStructuredDocument._fireEvent(BasicStructuredDocument.java:590)\n\tat\norg.eclipse.wst.sse.core.internal.text.BasicStructuredDocument.fireStructuredDocumentEvent(BasicStructuredDocument.java:1190)\n\tat\norg.eclipse.wst.sse.core.internal.text.BasicStructuredDocument.internalReplaceText(BasicStructuredDocument.java:1849)\n\tat\norg.eclipse.wst.sse.core.internal.text.BasicStructuredDocument.replaceText(BasicStructuredDocument.java:2266)\n\tat\norg.eclipse.wst.sse.core.internal.text.JobSafeStructuredDocument.access$0(JobSafeStructuredDocument.java:1)\n\tat\norg.eclipse.wst.sse.core.internal.text.JobSafeStructuredDocument$1.run(JobSafeStructuredDocument.java:100)\n\tat\norg.eclipse.wst.sse.ui.internal.editor.EditorExecutionContext.execute(EditorExecutionContext.java:43)\n\tat\norg.eclipse.wst.sse.core.internal.text.JobSafeStructuredDocument.replaceText(JobSafeStructuredDocument.java:110)\n\tat\norg.eclipse.wst.sse.core.internal.text.BasicStructuredDocument.replaceText(BasicStructuredDocument.java:2262)\n\tat\norg.eclipse.wst.sse.core.internal.text.BasicStructuredDocument.replace(BasicStructuredDocument.java:2225)\n\tat org.eclipse.text.edits.ReplaceEdit.performDocumentUpdating(ReplaceEdit.java:81)\n\tat org.eclipse.text.edits.TextEdit.traverseDocumentUpdating(TextEdit.java:850)\n\tat org.eclipse.text.edits.TextEdit.traverseDocumentUpdating(TextEdit.java:843)\n\tat org.eclipse.text.edits.TextEditProcessor.executeDo(TextEditProcessor.java:185)\n\tat org.eclipse.text.edits.TextEdit.dispatchPerformEdits(TextEdit.java:704)\n\tat\norg.eclipse.text.edits.TextEditProcessor.performEdits(TextEditProcessor.java:153)\n\tat org.eclipse.text.edits.TextEdit.apply(TextEdit.java:676)\n\tat org.eclipse.text.edits.TextEdit.apply(TextEdit.java:700)\n\tat\norg.eclipse.jst.jsp.ui.format.FormattingStrategyJSPJava.format(FormattingStrategyJSPJava.java:69)\n\tat\norg.eclipse.jface.text.formatter.MultiPassContentFormatter.formatSlave(MultiPassContentFormatter.java:220)\n\tat\norg.eclipse.jface.text.formatter.MultiPassContentFormatter.formatSlaves(MultiPassContentFormatter.java:267)\n\tat\norg.eclipse.jface.text.formatter.MultiPassContentFormatter.format(MultiPassContentFormatter.java:143)\n\tat\norg.eclipse.wst.sse.ui.StructuredTextViewer.doOperation(StructuredTextViewer.java:575)\n\tat\norg.eclipse.ui.texteditor.TextOperationAction$1.run(TextOperationAction.java:122)\n\tat org.eclipse.swt.custom.BusyIndicator.showWhile(BusyIndicator.java:69)\n\tat org.eclipse.ui.texteditor.TextOperationAction.run(TextOperationAction.java:120)\n\tat org.eclipse.jface.action.Action.runWithEvent(Action.java:989)\n\tat org.eclipse.ui.commands.ActionHandler.execute(ActionHandler.java:188)\n\tat org.eclipse.ui.internal.commands.Command.execute(Command.java:130)\n\tat\norg.eclipse.ui.internal.keys.WorkbenchKeyboard.executeCommand(WorkbenchKeyboard.java:445)\n\tat org.eclipse.ui.internal.keys.WorkbenchKeyboard.press(WorkbenchKeyboard.java:724)\n\tat\norg.eclipse.ui.internal.keys.WorkbenchKeyboard.processKeyEvent(WorkbenchKeyboard.java:767)\n\tat\norg.eclipse.ui.internal.keys.WorkbenchKeyboard.filterKeySequenceBindings(WorkbenchKeyboard.java:536)\n\tat\norg.eclipse.ui.internal.keys.WorkbenchKeyboard.access$2(WorkbenchKeyboard.java:479)\n\tat\norg.eclipse.ui.internal.keys.WorkbenchKeyboard$1.handleEvent(WorkbenchKeyboard.java:221)\n\tat org.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:82)\n\tat org.eclipse.swt.widgets.Display.filterEvent(Display.java:752)\n\tat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:832)\n\tat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:857)\n\tat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:842)\n\tat org.eclipse.swt.widgets.Widget.sendKeyEvent(Widget.java:870)\n\tat org.eclipse.swt.widgets.Widget.sendKeyEvent(Widget.java:866)\n\tat org.eclipse.swt.widgets.Widget.wmChar(Widget.java:1171)\n\tat org.eclipse.swt.widgets.Control.WM_CHAR(Control.java:3109)\n\tat org.eclipse.swt.widgets.Control.windowProc(Control.java:3012)\n\tat org.eclipse.swt.widgets.Display.windowProc(Display.java:3370)\n\tat org.eclipse.swt.internal.win32.OS.DispatchMessageW(Native Method)\n\tat org.eclipse.swt.internal.win32.OS.DispatchMessage(OS.java:1570)\n\tat org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:2446)\n\tat org.eclipse.ui.internal.Workbench.runEventLoop(Workbench.java:1569)\n\tat org.eclipse.ui.internal.Workbench.runUI(Workbench.java:1540)\n\tat org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:285)\n\tat org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:144)\n\tat org.eclipse.ui.internal.ide.IDEApplication.run(IDEApplication.java:102)\n\tat\norg.eclipse.core.internal.runtime.PlatformActivator$1.run(PlatformActivator.java:220)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:273)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:129)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat\nsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:324)\n\tat org.eclipse.core.launcher.Main.basicRun(Main.java:185)\n\tat org.eclipse.core.launcher.Main.run(Main.java:710)\n\tat org.eclipse.core.launcher.Main.main(Main.java:694)",
    "I\u0027ll document what I\u0027ve found, though not encouraging for finding easy safe fix. \n1. If that test JSP is in a simple project, the problem does not occur (but I\ncan easily reproduce it in web project). \n2. Using Source --\u003e Format from navigator context menu does not exhibit the \nproblem (there\u0027s a number of thread/concurrent modification safety mechanisms \nbuilt in there.\n3. I tried fixing 3 obvious thread and concurrent access problems, but the problem \nstill occurred (even though the NPE did not). \nSo ... I think it will take more time to sort through issues and fix correctly. \n",
    "Lastest findings and status for M2: \nI\u0027ve fixed the NPE errrors in several places, but those were not really releated \nto the formatting problem. \n\nFrom what I\u0027ve seen, the format problem itself is quite specific to documents\nthat have \n\u003c%@include file\u003d\"test3.jsp\"%\u003e \nand even then only if \"test3.jsp\" really \nexists in project (so our translator finds it). \n\nPhil, please take a look at JSPTranslationExtension::getJspEdit() and see how to \nhandle the \u0027included\u0027 text better (or better ignore it :). \n\nFor M2 we\u0027ll rely on this workaround:\n\"\nFor end-users who are formatting JSP documents that contain \u003c%@ include\ndirectives, formatting from the document itself will cause some text to be \nincorrectly removed. If you have such documents, please use the Source--\u003eFormat \navailable on the navigators pop-up menu to avoid this problem. \n\"",
    "Before I forget, I wanted to paste in corrected versions of failing test case\nfrom above ... I kept thinking it was working again :) ... the key is that one\nfile really is included by the other in a real web project (i.e. under web\ncontent). The exact starting format is also key. \n\ntest.jsp:\n\u003chtml\u003e\n\u003cbody\u003e\n\u003c%@include file\u003d\"test2.jsp\"%\u003e\n\u003c% System.out.println(\"test\"); %\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n\ntest2.jsp:\n\u003c%@page import\u003d\"java.lang.*\"%\u003e\n\u003cp\u003esample header\u003c/p\u003e\n",
    "I think this problem is specific to the \u003c%@page import\u003d\"java.lang.*\"%\u003e\ntag in the included JSP file.\n\nImports were not being handled correctly from included files.\nThey were being treated just like imports in the root JSP file (the file\nwhich includes another JSP file), and being added to the JSP\u003c-\u003eJava mapping.\n\nI think it\u0027s safe to ignore these import statements in the mapping, since\nthey come from an included file.",
    "It appears there is also an off by one error here.\nIf there is an indirect JSP mapping preceding a direct mapping,\nthen the direct mapping would be ignored (and not formatted)\n\n\u003c%@include file\u003d\"test2.jsp\"%\u003e\n\u003c%\n\t\tSystem.\nout.\nprintln(\"test\");\n\t\tString test2 \u003d \"testswt\";\n\n\t%\u003e\n\nThis can be fixed by not including the end offset of a range\nwhen checking if an offset is an \"indirect\" mapped range (like an include).\n",
    "checked fixes into HEAD",
    "this should be in 1/6 I build or later."
  ],
  "commentCreationDates": [
    "2004-12-20T21:50:16+01:00",
    "2004-12-21T07:18:37+01:00",
    "2004-12-22T05:23:35+01:00",
    "2004-12-23T07:27:54+01:00",
    "2005-01-03T21:44:18+01:00",
    "2005-01-04T17:57:40+01:00",
    "2005-01-04T18:06:40+01:00",
    "2005-01-11T22:23:29+01:00"
  ],
  "traces": [
    {
      "exceptionType": "java.lang.NullPointerException",
      "elements": [
        {
          "method": "org.eclipse.wst.sse.ui.StructuredTextReconciler.partitionChanged",
          "source": "StructuredTextReconciler.java:468"
        },
        {
          "method": "org.eclipse.wst.sse.ui.StructuredTextReconciler.nodesReplaced",
          "source": "StructuredTextReconciler.java:440"
        },
        {
          "method": "org.eclipse.wst.sse.core.internal.text.BasicStructuredDocument._fireEvent",
          "source": "BasicStructuredDocument.java:590"
        },
        {
          "method": "org.eclipse.wst.sse.core.internal.text.BasicStructuredDocument.fireStructuredDocumentEvent",
          "source": "BasicStructuredDocument.java:1190"
        },
        {
          "method": "org.eclipse.wst.sse.core.internal.text.BasicStructuredDocument.internalReplaceText",
          "source": "BasicStructuredDocument.java:1849"
        },
        {
          "method": "org.eclipse.wst.sse.core.internal.text.BasicStructuredDocument.replaceText",
          "source": "BasicStructuredDocument.java:2266"
        },
        {
          "method": "org.eclipse.wst.sse.core.internal.text.JobSafeStructuredDocument.access$0",
          "source": "JobSafeStructuredDocument.java:1"
        },
        {
          "method": "org.eclipse.wst.sse.core.internal.text.JobSafeStructuredDocument$1.run",
          "source": "JobSafeStructuredDocument.java:100"
        },
        {
          "method": "org.eclipse.wst.sse.ui.internal.editor.EditorExecutionContext.execute",
          "source": "EditorExecutionContext.java:43"
        },
        {
          "method": "org.eclipse.wst.sse.core.internal.text.JobSafeStructuredDocument.replaceText",
          "source": "JobSafeStructuredDocument.java:110"
        },
        {
          "method": "org.eclipse.wst.sse.core.internal.text.BasicStructuredDocument.replaceText",
          "source": "BasicStructuredDocument.java:2262"
        },
        {
          "method": "org.eclipse.wst.sse.core.internal.text.BasicStructuredDocument.replace",
          "source": "BasicStructuredDocument.java:2225"
        },
        {
          "method": "org.eclipse.text.edits.ReplaceEdit.performDocumentUpdating",
          "source": "ReplaceEdit.java:81"
        },
        {
          "method": "org.eclipse.text.edits.TextEdit.traverseDocumentUpdating",
          "source": "TextEdit.java:850"
        },
        {
          "method": "org.eclipse.text.edits.TextEdit.traverseDocumentUpdating",
          "source": "TextEdit.java:843"
        },
        {
          "method": "org.eclipse.text.edits.TextEditProcessor.executeDo",
          "source": "TextEditProcessor.java:185"
        },
        {
          "method": "org.eclipse.text.edits.TextEdit.dispatchPerformEdits",
          "source": "TextEdit.java:704"
        },
        {
          "method": "org.eclipse.text.edits.TextEditProcessor.performEdits",
          "source": "TextEditProcessor.java:153"
        },
        {
          "method": "org.eclipse.text.edits.TextEdit.apply",
          "source": "TextEdit.java:676"
        },
        {
          "method": "org.eclipse.text.edits.TextEdit.apply",
          "source": "TextEdit.java:700"
        },
        {
          "method": "org.eclipse.jst.jsp.ui.format.FormattingStrategyJSPJava.format",
          "source": "FormattingStrategyJSPJava.java:69"
        },
        {
          "method": "org.eclipse.jface.text.formatter.MultiPassContentFormatter.formatSlave",
          "source": "MultiPassContentFormatter.java:220"
        },
        {
          "method": "org.eclipse.jface.text.formatter.MultiPassContentFormatter.formatSlaves",
          "source": "MultiPassContentFormatter.java:267"
        },
        {
          "method": "org.eclipse.jface.text.formatter.MultiPassContentFormatter.format",
          "source": "MultiPassContentFormatter.java:143"
        },
        {
          "method": "org.eclipse.wst.sse.ui.StructuredTextViewer.doOperation",
          "source": "StructuredTextViewer.java:575"
        },
        {
          "method": "org.eclipse.ui.texteditor.TextOperationAction$1.run",
          "source": "TextOperationAction.java:122"
        },
        {
          "method": "org.eclipse.swt.custom.BusyIndicator.showWhile",
          "source": "BusyIndicator.java:69"
        },
        {
          "method": "org.eclipse.ui.texteditor.TextOperationAction.run",
          "source": "TextOperationAction.java:120"
        },
        {
          "method": "org.eclipse.jface.action.Action.runWithEvent",
          "source": "Action.java:989"
        },
        {
          "method": "org.eclipse.ui.commands.ActionHandler.execute",
          "source": "ActionHandler.java:188"
        },
        {
          "method": "org.eclipse.ui.internal.commands.Command.execute",
          "source": "Command.java:130"
        },
        {
          "method": "org.eclipse.ui.internal.keys.WorkbenchKeyboard.executeCommand",
          "source": "WorkbenchKeyboard.java:445"
        },
        {
          "method": "org.eclipse.ui.internal.keys.WorkbenchKeyboard.press",
          "source": "WorkbenchKeyboard.java:724"
        },
        {
          "method": "org.eclipse.ui.internal.keys.WorkbenchKeyboard.processKeyEvent",
          "source": "WorkbenchKeyboard.java:767"
        },
        {
          "method": "org.eclipse.ui.internal.keys.WorkbenchKeyboard.filterKeySequenceBindings",
          "source": "WorkbenchKeyboard.java:536"
        },
        {
          "method": "org.eclipse.ui.internal.keys.WorkbenchKeyboard.access$2",
          "source": "WorkbenchKeyboard.java:479"
        },
        {
          "method": "org.eclipse.ui.internal.keys.WorkbenchKeyboard$1.handleEvent",
          "source": "WorkbenchKeyboard.java:221"
        },
        {
          "method": "org.eclipse.swt.widgets.EventTable.sendEvent",
          "source": "EventTable.java:82"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.filterEvent",
          "source": "Display.java:752"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:832"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:857"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:842"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendKeyEvent",
          "source": "Widget.java:870"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendKeyEvent",
          "source": "Widget.java:866"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.wmChar",
          "source": "Widget.java:1171"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.WM_CHAR",
          "source": "Control.java:3109"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.windowProc",
          "source": "Control.java:3012"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.windowProc",
          "source": "Display.java:3370"
        },
        {
          "method": "org.eclipse.swt.internal.win32.OS.DispatchMessageW",
          "source": "Native Method"
        },
        {
          "method": "org.eclipse.swt.internal.win32.OS.DispatchMessage",
          "source": "OS.java:1570"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.readAndDispatch",
          "source": "Display.java:2446"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runEventLoop",
          "source": "Workbench.java:1569"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runUI",
          "source": "Workbench.java:1540"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.createAndRunWorkbench",
          "source": "Workbench.java:285"
        },
        {
          "method": "org.eclipse.ui.PlatformUI.createAndRunWorkbench",
          "source": "PlatformUI.java:144"
        },
        {
          "method": "org.eclipse.ui.internal.ide.IDEApplication.run",
          "source": "IDEApplication.java:102"
        },
        {
          "method": "org.eclipse.core.internal.runtime.PlatformActivator$1.run",
          "source": "PlatformActivator.java:220"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:273"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:129"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "NativeMethodAccessorImpl.java:39"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "DelegatingMethodAccessorImpl.java:25"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Method.java:324"
        },
        {
          "method": "org.eclipse.core.launcher.Main.basicRun",
          "source": "Main.java:185"
        },
        {
          "method": "org.eclipse.core.launcher.Main.run",
          "source": "Main.java:710"
        },
        {
          "method": "org.eclipse.core.launcher.Main.main",
          "source": "Main.java:694"
        }
      ],
      "number": 0,
      "commentIndex": 0,
      "bugId": "81687",
      "date": "2004-12-20T21:50:16+01:00",
      "product": "Web Tools",
      "component": "jst.jsp",
      "severity": "major"
    }
  ],
  "groupId": "81687",
  "bugId": "81687",
  "date": "2004-12-20T21:50:16+01:00",
  "product": "Web Tools",
  "component": "jst.jsp",
  "severity": "major"
}