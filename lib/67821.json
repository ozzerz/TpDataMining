{
  "comments": [
    "Eclipse RC2.\nif you copy a read-only file and paste it on top of another read-only file all \nfrom the package explorer you get an exception in the log but the operation \nsucceeds:\n\njava.lang.reflect.InvocationTargetException\n\tat org.eclipse.jface.operation.ModalContext.runInCurrentThread\n(ModalContext.java:314)\n\tat org.eclipse.jface.operation.ModalContext.run(ModalContext.java:253)\n\tat org.eclipse.jface.dialogs.ProgressMonitorDialog.run\n(ProgressMonitorDialog.java:397)\n\tat \norg.eclipse.jdt.internal.ui.refactoring.RefactoringExecutionHelper.perform\n(RefactoringExecutionHelper.java:116)\n\tat org.eclipse.jdt.internal.ui.refactoring.reorg.ReorgCopyStarter.run\n(ReorgCopyStarter.java:70)\n\tat \norg.eclipse.jdt.internal.ui.refactoring.reorg.PasteAction$JavaElementAndResourc\nePaster.paste(PasteAction.java:405)\n\tat org.eclipse.jdt.internal.ui.refactoring.reorg.PasteAction.run\n(PasteAction.java:192)\n\tat org.eclipse.jdt.ui.actions.SelectionDispatchAction.dispatchRun\n(SelectionDispatchAction.java:212)\n\tat org.eclipse.jdt.ui.actions.SelectionDispatchAction.run\n(SelectionDispatchAction.java:188)\n\tat org.eclipse.jface.action.Action.runWithEvent(Action.java:881)\n\tat org.eclipse.ui.actions.RetargetAction.runWithEvent\n(RetargetAction.java:212)\n\tat org.eclipse.ui.commands.ActionHandler.execute\n(ActionHandler.java:141)\n\tat org.eclipse.ui.internal.commands.Command.execute(Command.java:132)\n\tat org.eclipse.ui.internal.keys.WorkbenchKeyboard.executeCommand\n(WorkbenchKeyboard.java:469)\n\tat org.eclipse.ui.internal.keys.WorkbenchKeyboard.press\n(WorkbenchKeyboard.java:887)\n\tat org.eclipse.ui.internal.keys.WorkbenchKeyboard.processKeyEvent\n(WorkbenchKeyboard.java:928)\n\tat \norg.eclipse.ui.internal.keys.WorkbenchKeyboard.filterKeySequenceBindings\n(WorkbenchKeyboard.java:546)\n\tat org.eclipse.ui.internal.keys.WorkbenchKeyboard.access$2\n(WorkbenchKeyboard.java:494)\n\tat org.eclipse.ui.internal.keys.WorkbenchKeyboard$1.handleEvent\n(WorkbenchKeyboard.java:259)\n\tat org.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:82)\n\tat org.eclipse.swt.widgets.Display.filterEvent(Display.java:714)\n\tat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:795)\n\tat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:820)\n\tat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:805)\n\tat org.eclipse.swt.widgets.Control.sendKeyEvent(Control.java:1729)\n\tat org.eclipse.swt.widgets.Control.sendKeyEvent(Control.java:1725)\n\tat org.eclipse.swt.widgets.Control.WM_CHAR(Control.java:3053)\n\tat org.eclipse.swt.widgets.Tree.WM_CHAR(Tree.java:1372)\n\tat org.eclipse.swt.widgets.Control.windowProc(Control.java:2956)\n\tat org.eclipse.swt.widgets.Display.windowProc(Display.java:3298)\n\tat org.eclipse.swt.internal.win32.OS.DispatchMessageW(Native Method)\n\tat org.eclipse.swt.internal.win32.OS.DispatchMessage(OS.java:1460)\n\tat org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:2396)\n\tat org.eclipse.ui.internal.Workbench.runEventLoop(Workbench.java:1362)\n\tat org.eclipse.ui.internal.Workbench.runUI(Workbench.java:1333)\n\tat org.eclipse.ui.internal.Workbench.createAndRunWorkbench\n(Workbench.java:252)\n\tat org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:141)\n\tat org.eclipse.ui.internal.ide.IDEApplication.run\n(IDEApplication.java:96)\n\tat org.eclipse.core.internal.runtime.PlatformActivator$1.run\n(PlatformActivator.java:334)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run\n(EclipseStarter.java:272)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run\n(EclipseStarter.java:128)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke\n(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke\n(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:582)\n\tat org.eclipse.core.launcher.Main.basicRun(Main.java:185)\n\tat org.eclipse.core.launcher.Main.run(Main.java:638)\n\tat org.eclipse.core.launcher.Main.main(Main.java:622)\nCaused by: java.lang.NullPointerException\n\tat \norg.eclipse.ltk.internal.core.refactoring.DirtyBufferValidationState.dispose\n(BufferValidationState.java:175)\n\tat org.eclipse.ltk.core.refactoring.UndoTextFileChange.dispose\n(UndoTextFileChange.java:183)\n\tat org.eclipse.ltk.internal.core.refactoring.UndoManager.sendDispose\n(UndoManager.java:348)\n\tat org.eclipse.ltk.internal.core.refactoring.UndoManager.flushUndo\n(UndoManager.java:135)\n\tat org.eclipse.ltk.internal.core.refactoring.UndoManager.flush\n(UndoManager.java:129)\n\tat org.eclipse.ltk.core.refactoring.PerformChangeOperation$1.run\n(PerformChangeOperation.java:254)\n\tat org.eclipse.core.internal.resources.Workspace.run\n(Workspace.java:1673)\n\tat org.eclipse.core.internal.resources.Workspace.run\n(Workspace.java:1693)\n\tat \norg.eclipse.ltk.core.refactoring.PerformChangeOperation.executeChange\n(PerformChangeOperation.java:267)\n\tat \norg.eclipse.ltk.internal.ui.refactoring.UIPerformChangeOperation.executeChange\n(UIPerformChangeOperation.java:86)\n\tat org.eclipse.ltk.core.refactoring.PerformChangeOperation.run\n(PerformChangeOperation.java:190)\n\tat \norg.eclipse.jdt.internal.ui.refactoring.RefactoringExecutionHelper$Operation.ru\nn(RefactoringExecutionHelper.java:76)\n\tat org.eclipse.jdt.internal.core.BatchOperation.executeOperation\n(BatchOperation.java:34)\n\tat org.eclipse.jdt.internal.core.JavaModelOperation.run\n(JavaModelOperation.java:700)\n\tat org.eclipse.core.internal.resources.Workspace.run\n(Workspace.java:1673)\n\tat org.eclipse.jdt.core.JavaCore.run(JavaCore.java:3246)\n\tat org.eclipse.jdt.internal.ui.actions.WorkbenchRunnableAdapter.run\n(WorkbenchRunnableAdapter.java:65)\n\tat org.eclipse.jface.operation.ModalContext.runInCurrentThread\n(ModalContext.java:303)\n\t... 47 more",
    "The trace shows a NullPointerException coming from LTK refactoring.",
    "Can\u0027t reproduce the bug using the following scenario:\n\n- Test project\n- package p1 containing A.java, read-only\n- package p2 containing A.java, read-only\n\n- copy A.java form p1\n- paste with package p2 selected.\n\nNickoly, do you have any further steps you can provide. Can you reproduce the \nbug ?\n",
    "Looking at the stack trace and the code the following happens:\n\n- during change execution a runtime exception gets thrown\n- the PerformChangeOperation catches the exception to do some\n  clean-up and then rethrows the exception after doing the clean-up.\n- unfortunatelly, the clean-up fails as well, which could be a side effect\n  of the first runtime exception, but since I don\u0027t have the trace nor\n  a reproducable case I don\u0027t know what is going wrong.\n\n",
    "The NPE is created by a UndoTextChange sitting on the undo stack. This change \nis connected to a dirty buffer, but somehow the underlying document doesn\u0027t \nexist anymore.\n\nNikolay, can you remember if you did a extract method, local, field, constant \nbefore in a Compilation unit that is dirty before doing the copy paste.",
    "Nikolay, \n\nwas there anything else in the log before this exception belonging to the same \nsession. If so, can you please attach it as well. ",
    "Looking at the code this is what DirtyBufferValidationState does\n\n- register a listener on teh dirty document when it is created\n- unregisteres the listener on dispose\n\n- unregisters the listener when the file buffer infrastructure sends a\n  bufferDisposed (e.g. the document goes away)\n\n- registers the listener when the file buffer infrastrcuture sends a\n  bufferCreated\n\nWhat can happen is that I don\u0027t get the bufferDisposed due to other runtime \nexception, hence hanging onto a stale ITextFileBuffer which doesn\u0027t have a\ndocument anymore.",
    "I am sorry for the slow response. \nI just tried to recreate the problem and it didn\u0027t happen.\nI forgot to mention that the files I was copying were in fact .xml files and \nnot .java files.\nI do tend to use the \"Extract local variable\" refactoring quite extensively so \nit is very possible that I had a dirty editor with that refactoring.\nThe log only contains 3 of the exception traces given in the original report. \nThat is because I copied 3 different .xml files as described.\nI hope this helps!",
    "Nikolay,\n\none more question. Do you have any XML tooling installed ?",
    "the only plugins I have are installed are CDT Checkstyle (java syntax \nchecker), Implementors (find implmentations of an interface) and AllTheNews \n(RSS reader).",
    "I am able to reproduce the problem. It has nothing to do with XML file and \nonly indirectly with copy/paste. Here are steps to reproduce:\n\n- open a Java file.\n- cut a method in that file from the outliner using the cut action from\n  the context menu.\n- paste the cutted method onto the type from which it was cutted (any other\n  refactoring that work with drty buffers like extract method and extract\n  local will cause the same problem).\n- save the file and close it\n- select some other package\n- delete the package (any other refactoring that doesn\u0027t provide a undo (like\n  copy/paste will cause the same failure).\n\nYou get the NPE exception. Here is what\u0027s happening:\n\n- when the methods gets pasted a DirtyBufferValidationState object is created\n  to track changes to the document to flag the Paste/Undo as invalid when the\n  content of the buffer changes.\n- when the editor gets closed the DirtyBufferValidationState doesn\u0027t handle\n  the buffer disposed correctly, hence still hanging onto the text buffer\n- when a refactoring gets executed for which no undo exists the undo stack\n  gets flushed. This call dispose on DirtyBufferValidationState which then\n  accesses the non existing document. \u003d\u003d\u003e NPE\n- this NPS then gets caught by the refactoring infrastructure. Since for \n  the infrastructure the refactoring failed, it flushes the undo stack, which\n  causes the same exception again.\n\nThe problem is critical due to the following reasons:\n\n- exceptions during refactoring execution which give the impression that the\n  refactoring failed.\n- stale undo stack which can cause exception when an undo gets executed\n- exception can occur when the undo stack gets flushed due to a Java delta.\n- the code that causes this problem is public API. Although this problem \n  only occurs for refactorings in JDT/UI which work on dirty buffers (which\n  are paste and extract refactorings) other non Eclipse refactorings might\n  be affected as well.\n",
    "Created an attachment (id\u003d12554)\nPatch\n\nThe fix is low/middle risk:\n\n- now uses the file path to detect if the buffer is the one we are interested\n  in. This is saver anyways.\n- added two finally blocks and a safe runnable to do proper clean-up if a\n  undo stack flush fails.\n\nThe code changes are well understood and can be tested.",
    "Created an attachment (id\u003d12629)\nImproved patch\n",
    "Approved for RC4.",
    "Fix got reviewed by Andre Weinand and Daniel Megert. The fix only contains the \ncorrect buffer handling in DirtyBufferValidationState. No additional clean-up \ncode has been added to the UndoManager to keep the change minimal.\n\nReleased for RC4.",
    "Verified for I20040625\n\nfollowed the steps in #10 but could not reproduce the NPE."
  ],
  "commentCreationDates": [
    "2004-06-18T16:48:38+02:00",
    "2004-06-18T17:13:19+02:00",
    "2004-06-18T17:38:36+02:00",
    "2004-06-18T17:55:47+02:00",
    "2004-06-18T18:18:30+02:00",
    "2004-06-18T19:09:12+02:00",
    "2004-06-18T21:14:22+02:00",
    "2004-06-18T23:43:48+02:00",
    "2004-06-19T10:18:49+02:00",
    "2004-06-19T13:12:45+02:00",
    "2004-06-20T13:23:25+02:00",
    "2004-06-20T13:59:51+02:00",
    "2004-06-22T11:02:50+02:00",
    "2004-06-22T17:54:08+02:00",
    "2004-06-22T17:55:49+02:00",
    "2004-06-25T11:59:53+02:00"
  ],
  "traces": [
    {
      "exceptionType": "java.lang.reflect.InvocationTargetException",
      "elements": [
        {
          "method": "org.eclipse.jface.operation.ModalContext.runInCurrentThread",
          "source": "ModalContext.java:314"
        },
        {
          "method": "org.eclipse.jface.operation.ModalContext.run",
          "source": "ModalContext.java:253"
        },
        {
          "method": "org.eclipse.jface.dialogs.ProgressMonitorDialog.run",
          "source": "ProgressMonitorDialog.java:397"
        },
        {
          "method": "org.eclipse.jdt.internal.ui.refactoring.RefactoringExecutionHelper.perform",
          "source": "RefactoringExecutionHelper.java:116"
        },
        {
          "method": "org.eclipse.jdt.internal.ui.refactoring.reorg.ReorgCopyStarter.run",
          "source": "ReorgCopyStarter.java:70"
        },
        {
          "method": "org.eclipse.jdt.internal.ui.refactoring.reorg.PasteAction$JavaElementAndResourcePaster.paste",
          "source": "PasteAction.java:405"
        },
        {
          "method": "org.eclipse.jdt.internal.ui.refactoring.reorg.PasteAction.run",
          "source": "PasteAction.java:192"
        },
        {
          "method": "org.eclipse.jdt.ui.actions.SelectionDispatchAction.dispatchRun",
          "source": "SelectionDispatchAction.java:212"
        },
        {
          "method": "org.eclipse.jdt.ui.actions.SelectionDispatchAction.run",
          "source": "SelectionDispatchAction.java:188"
        },
        {
          "method": "org.eclipse.jface.action.Action.runWithEvent",
          "source": "Action.java:881"
        },
        {
          "method": "org.eclipse.ui.actions.RetargetAction.runWithEvent",
          "source": "RetargetAction.java:212"
        },
        {
          "method": "org.eclipse.ui.commands.ActionHandler.execute",
          "source": "ActionHandler.java:141"
        },
        {
          "method": "org.eclipse.ui.internal.commands.Command.execute",
          "source": "Command.java:132"
        },
        {
          "method": "org.eclipse.ui.internal.keys.WorkbenchKeyboard.executeCommand",
          "source": "WorkbenchKeyboard.java:469"
        },
        {
          "method": "org.eclipse.ui.internal.keys.WorkbenchKeyboard.press",
          "source": "WorkbenchKeyboard.java:887"
        },
        {
          "method": "org.eclipse.ui.internal.keys.WorkbenchKeyboard.processKeyEvent",
          "source": "WorkbenchKeyboard.java:928"
        },
        {
          "method": "org.eclipse.ui.internal.keys.WorkbenchKeyboard.filterKeySequenceBindings",
          "source": "WorkbenchKeyboard.java:546"
        },
        {
          "method": "org.eclipse.ui.internal.keys.WorkbenchKeyboard.access$2",
          "source": "WorkbenchKeyboard.java:494"
        },
        {
          "method": "org.eclipse.ui.internal.keys.WorkbenchKeyboard$1.handleEvent",
          "source": "WorkbenchKeyboard.java:259"
        },
        {
          "method": "org.eclipse.swt.widgets.EventTable.sendEvent",
          "source": "EventTable.java:82"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.filterEvent",
          "source": "Display.java:714"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:795"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:820"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:805"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.sendKeyEvent",
          "source": "Control.java:1729"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.sendKeyEvent",
          "source": "Control.java:1725"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.WM_CHAR",
          "source": "Control.java:3053"
        },
        {
          "method": "org.eclipse.swt.widgets.Tree.WM_CHAR",
          "source": "Tree.java:1372"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.windowProc",
          "source": "Control.java:2956"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.windowProc",
          "source": "Display.java:3298"
        },
        {
          "method": "org.eclipse.swt.internal.win32.OS.DispatchMessageW",
          "source": "Native Method"
        },
        {
          "method": "org.eclipse.swt.internal.win32.OS.DispatchMessage",
          "source": "OS.java:1460"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.readAndDispatch",
          "source": "Display.java:2396"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runEventLoop",
          "source": "Workbench.java:1362"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runUI",
          "source": "Workbench.java:1333"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.createAndRunWorkbench",
          "source": "Workbench.java:252"
        },
        {
          "method": "org.eclipse.ui.PlatformUI.createAndRunWorkbench",
          "source": "PlatformUI.java:141"
        },
        {
          "method": "org.eclipse.ui.internal.ide.IDEApplication.run",
          "source": "IDEApplication.java:96"
        },
        {
          "method": "org.eclipse.core.internal.runtime.PlatformActivator$1.run",
          "source": "PlatformActivator.java:334"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:272"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:128"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "NativeMethodAccessorImpl.java:39"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "DelegatingMethodAccessorImpl.java:25"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Method.java:582"
        },
        {
          "method": "org.eclipse.core.launcher.Main.basicRun",
          "source": "Main.java:185"
        },
        {
          "method": "org.eclipse.core.launcher.Main.run",
          "source": "Main.java:638"
        },
        {
          "method": "org.eclipse.core.launcher.Main.main",
          "source": "Main.java:622"
        }
      ],
      "causedBy": {
        "exceptionType": "java.lang.NullPointerException",
        "elements": [
          {
            "method": "org.eclipse.ltk.internal.core.refactoring.DirtyBufferValidationState.dispose",
            "source": "BufferValidationState.java:175"
          },
          {
            "method": "org.eclipse.ltk.core.refactoring.UndoTextFileChange.dispose",
            "source": "UndoTextFileChange.java:183"
          },
          {
            "method": "org.eclipse.ltk.internal.core.refactoring.UndoManager.sendDispose",
            "source": "UndoManager.java:348"
          },
          {
            "method": "org.eclipse.ltk.internal.core.refactoring.UndoManager.flushUndo",
            "source": "UndoManager.java:135"
          },
          {
            "method": "org.eclipse.ltk.internal.core.refactoring.UndoManager.flush",
            "source": "UndoManager.java:129"
          },
          {
            "method": "org.eclipse.ltk.core.refactoring.PerformChangeOperation$1.run",
            "source": "PerformChangeOperation.java:254"
          },
          {
            "method": "org.eclipse.core.internal.resources.Workspace.run",
            "source": "Workspace.java:1673"
          },
          {
            "method": "org.eclipse.core.internal.resources.Workspace.run",
            "source": "Workspace.java:1693"
          },
          {
            "method": "org.eclipse.ltk.core.refactoring.PerformChangeOperation.executeChange",
            "source": "PerformChangeOperation.java:267"
          },
          {
            "method": "org.eclipse.ltk.internal.ui.refactoring.UIPerformChangeOperation.executeChange",
            "source": "UIPerformChangeOperation.java:86"
          },
          {
            "method": "org.eclipse.ltk.core.refactoring.PerformChangeOperation.run",
            "source": "PerformChangeOperation.java:190"
          },
          {
            "method": "org.eclipse.jdt.internal.ui.refactoring.RefactoringExecutionHelper$Operation.run",
            "source": "RefactoringExecutionHelper.java:76"
          },
          {
            "method": "org.eclipse.jdt.internal.core.BatchOperation.executeOperation",
            "source": "BatchOperation.java:34"
          },
          {
            "method": "org.eclipse.jdt.internal.core.JavaModelOperation.run",
            "source": "JavaModelOperation.java:700"
          },
          {
            "method": "org.eclipse.core.internal.resources.Workspace.run",
            "source": "Workspace.java:1673"
          },
          {
            "method": "org.eclipse.jdt.core.JavaCore.run",
            "source": "JavaCore.java:3246"
          },
          {
            "method": "org.eclipse.jdt.internal.ui.actions.WorkbenchRunnableAdapter.run",
            "source": "WorkbenchRunnableAdapter.java:65"
          },
          {
            "method": "org.eclipse.jface.operation.ModalContext.runInCurrentThread",
            "source": "ModalContext.java:303"
          }
        ],
        "number": 0,
        "commentIndex": 0
      },
      "number": 0,
      "commentIndex": 0,
      "bugId": "67821",
      "date": "2004-06-18T16:48:38+02:00",
      "product": "JDT",
      "component": "UI",
      "severity": "critical"
    }
  ],
  "groupId": "67821",
  "bugId": "67821",
  "date": "2004-06-18T16:48:38+02:00",
  "product": "JDT",
  "component": "UI",
  "severity": "critical"
}