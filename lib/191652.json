{
  "comments": [
    "a) a bundle may contain Bundle-NativeCode header which describes which files from within of the bundle should be treated as native libraries and should be extracted to some location on filesystem to make them available for loading by the bundles classes; in Eclipse this native code is extracted to: conf\\org.eclipse.osgi\\bundles\\[bundle_id]\\[bundle_generation]\\.cp\nb) whenever a bundle is updated (using OSGi bundle upgrade mechanism) a new \"generation\" is created - the generation index is increased by one and a seperate dir for bundle\u0027s classloader and and native libs storage is created. e.g. if before update the generation\u0027s dir was conf\\org.eclipse.osgi\\bundles\\[bundle_id]\\1 then the update operation will create conf\\org.eclipse.osgi\\bundles\\[bundle_id]\\2\nc) during update this what is defined in Bundle-NativeCode header of a bundle\u0027s new version should be extracted to a new generation dir, while in Eclipse it\u0027s the old bundle and old storage to/from which the extract takes place!!!  and after the update the old generstion dir is removed or marked for deletion and the native code libs are not available any longer for the bundle in new version\n\nthe location of bugged source files (I\u0027m referring to eclipse sources tagged in Eclipse CVS with r31x_v20060106):\n\norg.eclipse.osgi\\core\\framework\\org\\eclipse\\osgi\\framework\\internal\\core\\AbstractBundle.java - line 703:\nbundledata.installNativeCode(nativepaths); \n\nin my opinion should be changed to:\t\t\nnewBundleData.installNativeCode(nativepaths);\n\n\nThe steps to reproduce:\n\nI prepared 2 examples (I\u0027m not sure how to attach them here though):\na) when the new bundle version cotains a native code with different filenames:\n\n1) install bundle NativeBundle_1.0.0.jar \n2) update bundle with NativeBundle_1.1.0.jar\n3) an exception is thrown \norg.osgi.framework.BundleException: The Bundle-NativeCode file nativefile2.txt could not be not found\n        at org.eclipse.osgi.framework.adaptor.core.AbstractBundleData.installNativeCode(AbstractBundleData.java:818)\n        at org.eclipse.osgi.framework.internal.core.AbstractBundle.updateWorkerPrivileged(AbstractBundle.java:703)\n        at org.eclipse.osgi.framework.internal.core.AbstractBundle$3.run(AbstractBundle.java:645)\n        at java.security.AccessController.doPrivileged1(Native Method)\n        at java.security.AccessController.doPrivileged(AccessController.java:351)\n        at org.eclipse.osgi.framework.internal.core.AbstractBundle.updateWorker(AbstractBundle.java:672)\n        at org.eclipse.osgi.framework.internal.core.AbstractBundle.update(AbstractBundle.java:640)\n        at org.eclipse.osgi.framework.internal.core.FrameworkCommandProvider._update(FrameworkCommandProvider.java:348)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:85)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:58)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:60)\n        at java.lang.reflect.Method.invoke(Method.java:391)\n        at org.eclipse.osgi.framework.internal.core.FrameworkCommandInterpreter.execute(FrameworkCommandInterpreter.java:145)\n        at org.eclipse.osgi.framework.internal.core.FrameworkConsole.docommand(FrameworkConsole.java:293)\n        at org.eclipse.osgi.framework.internal.core.FrameworkConsole.console(FrameworkConsole.java:278)\n        at org.eclipse.osgi.framework.internal.core.FrameworkConsole.run(FrameworkConsole.java:213)\n        at java.lang.Thread.run(Thread.java:570)\n\n\nb) when the new bundle version contains a native code with same filenames:\n\n1) install bundle NativeBundle_2.0.0.jar \n2) update bundle with NativeBundle_2.1.0.jar \n3) the native entry is missing\n4) when you start the bundle the entry will appear because the activator contains the following code:\n\tBundleClassLoader bcl \u003d (BundleClassLoader) this.getClass().getClassLoader();\n\tSystem.out.println(bcl.getDelegate().findLibrary(\"nativefile.txt\");\n\tthis will create the native path entry",
    "Created an attachment (id\u003d70648)\nAn example bundle\n\nFile for 1st test case",
    "Created an attachment (id\u003d70649)\nan example bundle\n\nBundle for the 1st testcase",
    "Created an attachment (id\u003d70650)\nan example bundle v2\n\nA bundle for the 2nd testcase",
    "Created an attachment (id\u003d70651)\nAnd example bundle v2\n\nA bundle for 2nd testcase",
    "Reproduced.  It does look like we should be calling newBundleData.installNativeCode.",
    "Created an attachment (id\u003d70683)\n3.3.1 patch\n\nHere is the 3.3.1 fix.  I will attach a patch for 3.1.x and 3.2.x but there are no plans on releasing new versions of 3.1.x or 3.2.x.\n\nI still need to verify this fix passes the OSGi TCK.",
    "Created an attachment (id\u003d70692)\n3.2.x patch\n\n",
    "Created an attachment (id\u003d70693)\n3.1.x patch\n\n",
    "Fix and new testcases released to HEAD (for 3.4).  Leaving bug open to release fix to 3.3.1.",
    "Thomas, I verified that 3.1.x patch fixes the problem. I do not plan to verify in later versions. Should I resolve the bug?",
    "Please leave the bug open.  I will resolve as fixed when the fix is released to 3.3.1.",
    "DJ, please review for 3.3.1 release.",
    "Fix released to 3.3.1."
  ],
  "commentCreationDates": [
    "2007-06-08T10:46:45+02:00",
    "2007-06-08T10:48:27+02:00",
    "2007-06-08T10:49:47+02:00",
    "2007-06-08T10:50:42+02:00",
    "2007-06-08T10:51:31+02:00",
    "2007-06-08T15:50:40+02:00",
    "2007-06-08T16:00:14+02:00",
    "2007-06-08T16:39:34+02:00",
    "2007-06-08T16:40:03+02:00",
    "2007-06-20T18:46:16+02:00",
    "2007-06-21T08:44:42+02:00",
    "2007-06-21T14:53:16+02:00",
    "2007-07-18T20:59:25+02:00",
    "2007-07-19T20:14:33+02:00"
  ],
  "traces": [
    {
      "exceptionType": "org.osgi.framework.BundleException",
      "message": "The Bundle-NativeCode file nativefile2.txt could not be not found",
      "elements": [
        {
          "method": "org.eclipse.osgi.framework.adaptor.core.AbstractBundleData.installNativeCode",
          "source": "AbstractBundleData.java:818"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.AbstractBundle.updateWorkerPrivileged",
          "source": "AbstractBundle.java:703"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.AbstractBundle$3.run",
          "source": "AbstractBundle.java:645"
        },
        {
          "method": "java.security.AccessController.doPrivileged1",
          "source": "Native Method"
        },
        {
          "method": "java.security.AccessController.doPrivileged",
          "source": "AccessController.java:351"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.AbstractBundle.updateWorker",
          "source": "AbstractBundle.java:672"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.AbstractBundle.update",
          "source": "AbstractBundle.java:640"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.FrameworkCommandProvider._update",
          "source": "FrameworkCommandProvider.java:348"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "NativeMethodAccessorImpl.java:85"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "NativeMethodAccessorImpl.java:58"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "DelegatingMethodAccessorImpl.java:60"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Method.java:391"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.FrameworkCommandInterpreter.execute",
          "source": "FrameworkCommandInterpreter.java:145"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.FrameworkConsole.docommand",
          "source": "FrameworkConsole.java:293"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.FrameworkConsole.console",
          "source": "FrameworkConsole.java:278"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.FrameworkConsole.run",
          "source": "FrameworkConsole.java:213"
        },
        {
          "method": "java.lang.Thread.run",
          "source": "Thread.java:570"
        }
      ],
      "number": 0,
      "commentIndex": 0,
      "bugId": "191652",
      "date": "2007-06-08T10:46:45+02:00",
      "product": "Equinox",
      "component": "Framework",
      "severity": "blocker"
    }
  ],
  "groupId": "191652",
  "bugId": "191652",
  "date": "2007-06-08T10:46:45+02:00",
  "product": "Equinox",
  "component": "Framework",
  "severity": "blocker"
}