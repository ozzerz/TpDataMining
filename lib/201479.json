{
  "comments": [
    "When parent files are changed such that non-source generated files are no longer generated, a NegativeArraySizeException is thrown from the Java Builder.\n\nThe test that currently tests this, apt.tests.FileGenerationTests.testTextGen, is defective: it calls fullBuild() rather than incrementalBuild(), clearing the state of the file system before the Builder has anything to do and therefore preventing the failure.  This is true of many other tests in our suite too, and should probably be looked into.\n\nIn this case, the problem is that when the GeneratedFileManager calculates what files to delete at the end of a build, and reports those files back to JDT Core, it is reporting all the files it deleted rather than just those files that JDT actually compiled.  That causes JDT to try to delete .class files for .java files that don\u0027t exist, and it fails.  The correct fix is probably to track non-source files separately from source files, and not report them to JDT at all.\n\nThis is a fairly serious failure, and should be fixed in 3.3.x as well as in HEAD.\n\nHere\u0027s the stack trace of the failure that occurs when fullBuild() is changed to incrementalBuild() in testTextGen:\n\norg.eclipse.core.runtime.AssertionFailedException: assertion failed: Core exception in testing environment: Errors running builder \u0027Java Builder\u0027 on project \u0027org.eclipse.jdt.apt.tests.FileGenerationTestsProject\u0027.\njava.lang.NegativeArraySizeException encountered while running Java Builder.\n\n\tat org.eclipse.core.runtime.Assert.isTrue(Assert.java:109)\n\tat org.eclipse.jdt.core.tests.builder.TestingEnvironment.handleCoreException(TestingEnvironment.java:714)\n\tat org.eclipse.jdt.core.tests.builder.TestingEnvironment.handle(TestingEnvironment.java:687)\n\tat org.eclipse.jdt.core.tests.builder.TestingEnvironment.incrementalBuild(TestingEnvironment.java:739)\n\tat org.eclipse.jdt.core.tests.builder.BuilderTests.incrementalBuild(BuilderTests.java:400)\n\tat org.eclipse.jdt.apt.tests.FileGenerationTests.testTextFileGen(FileGenerationTests.java:184)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:597)\n\tat junit.framework.TestCase.runTest(TestCase.java:164)\n\tat junit.framework.TestCase.runBare(TestCase.java:130)\n\tat junit.framework.TestResult$1.protect(TestResult.java:106)\n\tat junit.framework.TestResult.runProtected(TestResult.java:124)\n\tat junit.framework.TestResult.run(TestResult.java:109)\n\tat junit.framework.TestCase.run(TestCase.java:120)\n\tat junit.framework.TestSuite.runTest(TestSuite.java:230)\n\tat junit.framework.TestSuite.run(TestSuite.java:225)\n\tat org.eclipse.jdt.internal.junit.runner.junit3.JUnit3TestReference.run(JUnit3TestReference.java:130)\n\tat org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:460)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:673)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:386)\n\tat org.eclipse.pde.internal.junit.runtime.RemotePluginTestRunner.main(RemotePluginTestRunner.java:58)\n\tat org.eclipse.pde.internal.junit.runtime.CoreTestApplication.run(CoreTestApplication.java:24)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:597)\n\tat org.eclipse.equinox.internal.app.EclipseAppContainer.callMethod(EclipseAppContainer.java:533)\n\tat org.eclipse.equinox.internal.app.EclipseAppHandle.run(EclipseAppHandle.java:155)\n\tat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(EclipseAppLauncher.java:106)\n\tat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(EclipseAppLauncher.java:76)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:363)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:176)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:597)\n\tat org.eclipse.equinox.launcher.Main.invokeFramework(Main.java:504)\n\tat org.eclipse.equinox.launcher.Main.basicRun(Main.java:443)\n\tat org.eclipse.equinox.launcher.Main.run(Main.java:1169)\n\tat org.eclipse.equinox.launcher.Main.main(Main.java:1144)",
    "Created an attachment (id\u003d77180)\ntest case\n\nPatch for test case, that causes this bug to manifest.",
    "Created an attachment (id\u003d77190)\nproposed patch\n\nProposed patch adds a _nonSourceFiles set to GeneratedFileManager.  When computing obsolete files, we now return a \"toReport\" list as well as the list of files to be physically deleted.  The toReport list only includes source files, not non-source files.  With this patch, the test case (as well as all other APT tests) passes.",
    "The proposed patch fails to handle serialization of the dependency state.  A replacement which does is just about ready.",
    "Created an attachment (id\u003d77348)\nproposed patch\n\nProposed patch including serialization of build state.  With this patch, it is possible to generate a text file; exit the workspace; restart the workspace; delete the annotation that caused the text file to be generated; rebuild; and have the file be properly deleted as expected.\n\nThis patch also changes the severity of the \"couldn\u0027t (de)serialize build dependencies\" error to be a warning, rather than an error.  This reflects that fact that the only consequence is that no-longer-generated files may not be deleted until the next clean.",
    "Created an attachment (id\u003d77349)\nproposed patch\n\nLike the previous one, but also fixes a comment.",
    "Jess, please review for inclusion in 3.3.1 and HEAD.",
    "+1",
    "Released proposed patch #3, and test case, to HEAD and 3.3.1."
  ],
  "commentCreationDates": [
    "2007-08-28T23:00:48+02:00",
    "2007-08-28T23:03:26+02:00",
    "2007-08-29T01:01:00+02:00",
    "2007-08-29T17:22:51+02:00",
    "2007-08-30T07:41:59+02:00",
    "2007-08-30T07:50:24+02:00",
    "2007-08-30T07:51:13+02:00",
    "2007-08-30T18:54:57+02:00",
    "2007-08-30T19:24:00+02:00"
  ],
  "traces": [
    {
      "exceptionType": "org.eclipse.core.runtime.AssertionFailedException",
      "message": "assertion failed: Core exception in testing environment: Errors running builder \u0027Java Builder\u0027 on project \u0027org.eclipse.jdt.apt.tests.FileGenerationTestsProject\u0027. java.lang.NegativeArraySizeException encountered while running Java Builder.",
      "elements": [
        {
          "method": "org.eclipse.core.runtime.Assert.isTrue",
          "source": "Assert.java:109"
        },
        {
          "method": "org.eclipse.jdt.core.tests.builder.TestingEnvironment.handleCoreException",
          "source": "TestingEnvironment.java:714"
        },
        {
          "method": "org.eclipse.jdt.core.tests.builder.TestingEnvironment.handle",
          "source": "TestingEnvironment.java:687"
        },
        {
          "method": "org.eclipse.jdt.core.tests.builder.TestingEnvironment.incrementalBuild",
          "source": "TestingEnvironment.java:739"
        },
        {
          "method": "org.eclipse.jdt.core.tests.builder.BuilderTests.incrementalBuild",
          "source": "BuilderTests.java:400"
        },
        {
          "method": "org.eclipse.jdt.apt.tests.FileGenerationTests.testTextFileGen",
          "source": "FileGenerationTests.java:184"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "NativeMethodAccessorImpl.java:39"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "DelegatingMethodAccessorImpl.java:25"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Method.java:597"
        },
        {
          "method": "junit.framework.TestCase.runTest",
          "source": "TestCase.java:164"
        },
        {
          "method": "junit.framework.TestCase.runBare",
          "source": "TestCase.java:130"
        },
        {
          "method": "junit.framework.TestResult$1.protect",
          "source": "TestResult.java:106"
        },
        {
          "method": "junit.framework.TestResult.runProtected",
          "source": "TestResult.java:124"
        },
        {
          "method": "junit.framework.TestResult.run",
          "source": "TestResult.java:109"
        },
        {
          "method": "junit.framework.TestCase.run",
          "source": "TestCase.java:120"
        },
        {
          "method": "junit.framework.TestSuite.runTest",
          "source": "TestSuite.java:230"
        },
        {
          "method": "junit.framework.TestSuite.run",
          "source": "TestSuite.java:225"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.junit3.JUnit3TestReference.run",
          "source": "JUnit3TestReference.java:130"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.TestExecution.run",
          "source": "TestExecution.java:38"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests",
          "source": "RemoteTestRunner.java:460"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests",
          "source": "RemoteTestRunner.java:673"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run",
          "source": "RemoteTestRunner.java:386"
        },
        {
          "method": "org.eclipse.pde.internal.junit.runtime.RemotePluginTestRunner.main",
          "source": "RemotePluginTestRunner.java:58"
        },
        {
          "method": "org.eclipse.pde.internal.junit.runtime.CoreTestApplication.run",
          "source": "CoreTestApplication.java:24"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "NativeMethodAccessorImpl.java:39"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "DelegatingMethodAccessorImpl.java:25"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Method.java:597"
        },
        {
          "method": "org.eclipse.equinox.internal.app.EclipseAppContainer.callMethod",
          "source": "EclipseAppContainer.java:533"
        },
        {
          "method": "org.eclipse.equinox.internal.app.EclipseAppHandle.run",
          "source": "EclipseAppHandle.java:155"
        },
        {
          "method": "org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication",
          "source": "EclipseAppLauncher.java:106"
        },
        {
          "method": "org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start",
          "source": "EclipseAppLauncher.java:76"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:363"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:176"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "NativeMethodAccessorImpl.java:39"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "DelegatingMethodAccessorImpl.java:25"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Method.java:597"
        },
        {
          "method": "org.eclipse.equinox.launcher.Main.invokeFramework",
          "source": "Main.java:504"
        },
        {
          "method": "org.eclipse.equinox.launcher.Main.basicRun",
          "source": "Main.java:443"
        },
        {
          "method": "org.eclipse.equinox.launcher.Main.run",
          "source": "Main.java:1169"
        },
        {
          "method": "org.eclipse.equinox.launcher.Main.main",
          "source": "Main.java:1144"
        }
      ],
      "number": 0,
      "commentIndex": 0,
      "bugId": "201479",
      "date": "2007-08-28T23:00:48+02:00",
      "product": "JDT",
      "component": "APT",
      "severity": "normal"
    }
  ],
  "groupId": "201479",
  "bugId": "201479",
  "date": "2007-08-28T23:00:48+02:00",
  "product": "JDT",
  "component": "APT",
  "severity": "normal"
}