{
  "comments": [
    "Driver:  M 0124_0254 + applied patch for jst.cons.ui in bug 117930\n\nScenario:\n\n- Create a Web service client. Select to \"test Web service\"\n- You can use any WSDL file or this URL:\nhttp://www.xmethods.net/sd/2001/TemperatureService.wsdl\n- On the 3rd page, type in a Java project (say \"j4\"), select \"Java Utility project\".\n\nThe wizard would create a Web project \"j4Sample\" and put j4.jar in the WEB-INF/lib directory.\n\nThe scenario is fine the first time.  However, if I repeat on a started server a second time, I would get:\n\n\nPublishing failed\n  Error creating zip file j4.jar: Error deleting D:\\eclipse311\\eclipse\\runtime-workspace_release0127a\\.metadata\\.plugins\\org.eclipse.wst.server.core\\tmp0\\webapps\\j4Sample\\WEB-INF\\lib\\j4.jar\n      java.lang.Exception: Error deleting D:\\eclipse311\\eclipse\\runtime-workspace_release0127a\\.metadata\\.plugins\\org.eclipse.wst.server.core\\tmp0\\webapps\\j4Sample\\WEB-INF\\lib\\j4.jar\n      at org.eclipse.jst.server.core.PublishUtil.createZipFile(PublishUtil.java:407)\n      at org.eclipse.jst.server.tomcat.core.internal.PublishOperation2.publishJar(PublishOperation2.java:108)\n      at org.eclipse.jst.server.tomcat.core.internal.PublishOperation2.execute(PublishOperation2.java:53)\n      at org.eclipse.wst.server.core.model.ServerBehaviourDelegate.performTasks(ServerBehaviourDelegate.java:797)\n      at org.eclipse.wst.server.core.model.ServerBehaviourDelegate.publish(ServerBehaviourDelegate.java:586)\n      at org.eclipse.wst.server.core.internal.Server.doPublish(Server.java:801)\n      at org.eclipse.wst.server.core.internal.Server.publish(Server.java:789)\n      at org.eclipse.jst.ws.internal.consumption.ui.command.StartServerCommand$1.run(StartServerCommand.java:129)\n      at org.eclipse.jface.operation.ModalContext$ModalContextThread.run(ModalContext.java:113)\n\nI checked and see that the j4.jar is not in the workspace but in the .metadata directory.  If I try to delete it, it would say another process is using the file.\n\nI tried a few other times and sometimes got:\n\nPublishing failed\n  Error creating zip file j1.jar: Error deleting D:\\eclipse311\\eclipse\\runtime-workspace_release0127a\\.metadata\\.plugins\\org.eclipse.wst.server.core\\tmp0\\webapps\\j1Sample\\WEB-INF\\lib\\j1.jar\n  Error creating zip file j2.jar: ZIP file must have at least one entry\n\nPlease let me know if you need help reproducing the problem.  We don\u0027t want to check in the fix for 117930 until this can be resolved.",
    "Added to the 1.5 hot list. Setting priority to P2.",
    "assuming will be addressed next milestone. If I\u0027m mistaken, please correct. ",
    "ETA: Will work on it over the next couple weeks.",
    "Will be addressed by \"friendly publishing\", where we\u0027ll try multiple times to do the publish and will give a better error message if it still fails. There is a chance this will still cause the problem (e.g. if the server has locked the file and never lets go) but it will solve problems with temporary locks and will provide better feedback.",
    "Tim, any updates on this hot bug?",
    "Fix checked into HEAD. Will release for 1.5 once I-build is declared.",
    "*** Bug 120709 has been marked as a duplicate of this bug. ***",
    "Update all 1.5 hot bugs to use the new hot bug process.",
    "Released to 1.5 stream.",
    "I retried the scenario with WTP 1.5 06150639 driver and a similar problem is still there.  Here\u0027s the trace (note that \"u1\" is the name of the utility Jar the Web project is dependent on):\n\nPublishing failed\n  Error creating zip file u1.jar: Could not delete previous copy, which may be locked by another process.\n      java.lang.Exception: Could not delete previous copy, which may be locked by another process.\n      at org.eclipse.jst.server.core.PublishUtil.moveTempFile(PublishUtil.java:476)\n      at org.eclipse.jst.server.core.PublishUtil.createZipFile(PublishUtil.java:407)\n      at org.eclipse.jst.server.tomcat.core.internal.PublishOperation2.publishJar(PublishOperation2.java:108)\n      at org.eclipse.jst.server.tomcat.core.internal.PublishOperation2.execute(PublishOperation2.java:53)\n      at org.eclipse.wst.server.core.model.ServerBehaviourDelegate.performTasks(ServerBehaviourDelegate.java:801)\n      at org.eclipse.wst.server.core.model.ServerBehaviourDelegate.publish(ServerBehaviourDelegate.java:590)\n      at org.eclipse.wst.server.core.internal.Server.doPublish(Server.java:803)\n      at org.eclipse.wst.server.core.internal.Server.publish(Server.java:791)\n      at org.eclipse.jst.ws.internal.consumption.ui.command.StartServerCommand$1.run(StartServerCommand.java:129)\n      at org.eclipse.jface.operation.ModalContext$ModalContextThread.run(ModalContext.java:113)\n",
    "If WTP can\u0027t delete the file, it probably means that the server is actually locking the file. If that\u0027s true, it\u0027s regular Tomcat behaviour and nothing WTP can do about it - can you show anything that would prove this is a WTP problem?",
    "I can\u0027t at the moment speak about class files, but I know for certain that Windows locks the file handle for jars while the JarFile is kept open by Tomcat\u0027s webapp classloader.  The jar can\u0027t be deleted until Tomcat is shutdown.  However, even though it can\u0027t be deleted, it *can* be rewritten.  For consideration, I\u0027m attaching a patch that works around this issue by rewritting the jar file with the contents of the temp file if the jar can\u0027t be deleted.\n\nThis particular patch goes the whole nine yards by adding a boolean \"allowRewrite\" argument to more than just the jar related methods.  Old public methods are preserved with new versions added with the new argument, in case some adopter determined to use internal API might want the choice.  The patch also updates the Tomcat plug-in to specify allowRewrite true.  This fixes the publish issue for me on Windows, at least for updating utility projects used by a webapp that is published to a running Tomcat server.  I would expect it to fix this bug as well with respect to jars.\nI\u0027m not aware of the same kind of locking problem for class files, which has been mentioned in other bugs, so I\u0027m not sure if this would help in those cases.\n\nThis patch could be scaled down to just address jar file replacement if desired.  Let me know if you want me to create a smaller version of the patch.",
    "Created an attachment (id\u003d47122)\nPatch to rewrite files during publish if they can\u0027t be deleted\n\nThis patch was developed for 1.5.1.  I haven\u0027t checked it against 2.0 yet, but I\u0027ll do so and attach another patch for 2.0 if necessary.",
    "Thanks for the patch, Larry. The 2.0 stream is identical to 1.5.1 right now, so no additional work needs to be done. I\u0027ll review the patch and check the changes in.",
    "I may be wrong, but I think Larry\u0027s patch is great and I can\u0027t see any reason why someone wouldn\u0027t want to use it. Therefore, I\u0027m skipping duplicating all of the API and putting the fix directly into the main stream so that all servers will take advantage of it. I hope everyone is ok with this and I\u0027m not missing any reason why a server wouldn\u0027t want to try this behaviour.\n\nFix dropped to HEAD. I can\u0027t claim we don\u0027t have any bugs or are still missing something, but at this point we try several different methods and are bending over backwards attempting to work with files locked by the server. If a publish still fails after this fix, it seems likely that the file is simply locked and it will be a limitation of the server.",
    "Fix released to 1.5.1 and 2.0 streams.",
    "I tried the original scenarios a few times on WTP 1.5.1 200609220504 and the problem has not surface. Thanks Tim and Larry for the fix.",
    "Closing.",
    "This is part of a \"mass update\" where bugs showing \"fixed\" between 7/1/2006 and 9/27/2006 are assumed fixed in WTP 1.5.1. feel free to change the target milestone if you know a more accurate setting. ",
    "Darryl Miles raised an issue on the newsgroup about rewriting jars causing JVM problems.  I had tested the rewriting with a utility jar with multiple classes and verified that with Tomcat, changes to all classes in the jar occurred successfully.  Darryl\u0027s post reminded me that for this to succeed, automatic reloading of the web application has to occur.  I had intended to eventually set the \"allowRewrite\" argument in my patch based on the auto-reload setting on the web application.  This seemed too big a change for WTP 1.5.x, but I failed to mention it in comments.  Since this argument wasn\u0027t included in the released changes, at some point I\u0027ll create an enhancement request to consider adding the \"allowRewrite\" argument to some extent in WTP 2.0 to better address this issue.\n\nAt the moment for jars, I believe the Tomcat plug-in is the only consumer so this shouldn\u0027t be a problem in general.  However, we should be watchful concerning any new uses of jar publishing.  As Darryl points out, it\u0027s probably a bad idea to rewrite the jar in situations where there isn\u0027t good chance that stale classes will be discarded.  "
  ],
  "commentCreationDates": [
    "2006-01-27T18:29:23+01:00",
    "2006-02-09T15:21:22+01:00",
    "2006-03-02T19:43:31+01:00",
    "2006-03-09T19:40:03+01:00",
    "2006-03-09T19:41:08+01:00",
    "2006-04-21T23:58:15+02:00",
    "2006-04-28T06:19:46+02:00",
    "2006-04-28T06:21:27+02:00",
    "2006-04-28T17:26:08+02:00",
    "2006-05-01T06:28:49+02:00",
    "2006-06-15T16:50:21+02:00",
    "2006-06-15T16:57:12+02:00",
    "2006-08-01T02:32:46+02:00",
    "2006-08-01T02:37:50+02:00",
    "2006-08-01T15:06:20+02:00",
    "2006-08-10T04:12:35+02:00",
    "2006-08-10T04:19:01+02:00",
    "2006-09-22T17:43:45+02:00",
    "2006-09-26T19:04:06+02:00",
    "2006-09-27T15:06:26+02:00",
    "2006-09-29T02:47:21+02:00"
  ],
  "traces": [
    {
      "exceptionType": "java.lang.Exception",
      "message": "Error deleting D:\\eclipse311\\eclipse\\runtime-workspace_release0127a\\.metadata\\.plugins\\org.eclipse.wst.server.core\\tmp0\\webapps\\j4Sample\\WEB-INF\\lib\\j4.jar",
      "elements": [
        {
          "method": "org.eclipse.jst.server.core.PublishUtil.createZipFile",
          "source": "PublishUtil.java:407"
        },
        {
          "method": "org.eclipse.jst.server.tomcat.core.internal.PublishOperation2.publishJar",
          "source": "PublishOperation2.java:108"
        },
        {
          "method": "org.eclipse.jst.server.tomcat.core.internal.PublishOperation2.execute",
          "source": "PublishOperation2.java:53"
        },
        {
          "method": "org.eclipse.wst.server.core.model.ServerBehaviourDelegate.performTasks",
          "source": "ServerBehaviourDelegate.java:797"
        },
        {
          "method": "org.eclipse.wst.server.core.model.ServerBehaviourDelegate.publish",
          "source": "ServerBehaviourDelegate.java:586"
        },
        {
          "method": "org.eclipse.wst.server.core.internal.Server.doPublish",
          "source": "Server.java:801"
        },
        {
          "method": "org.eclipse.wst.server.core.internal.Server.publish",
          "source": "Server.java:789"
        },
        {
          "method": "org.eclipse.jst.ws.internal.consumption.ui.command.StartServerCommand$1.run",
          "source": "StartServerCommand.java:129"
        },
        {
          "method": "org.eclipse.jface.operation.ModalContext$ModalContextThread.run",
          "source": "ModalContext.java:113"
        }
      ],
      "number": 0,
      "commentIndex": 0,
      "bugId": "125524",
      "date": "2006-01-27T18:29:23+01:00",
      "product": "Web Tools",
      "component": "jst.server",
      "severity": "major"
    },
    {
      "exceptionType": "java.lang.Exception",
      "message": "Could not delete previous copy, which may be locked by another process.",
      "elements": [
        {
          "method": "org.eclipse.jst.server.core.PublishUtil.moveTempFile",
          "source": "PublishUtil.java:476"
        },
        {
          "method": "org.eclipse.jst.server.core.PublishUtil.createZipFile",
          "source": "PublishUtil.java:407"
        },
        {
          "method": "org.eclipse.jst.server.tomcat.core.internal.PublishOperation2.publishJar",
          "source": "PublishOperation2.java:108"
        },
        {
          "method": "org.eclipse.jst.server.tomcat.core.internal.PublishOperation2.execute",
          "source": "PublishOperation2.java:53"
        },
        {
          "method": "org.eclipse.wst.server.core.model.ServerBehaviourDelegate.performTasks",
          "source": "ServerBehaviourDelegate.java:801"
        },
        {
          "method": "org.eclipse.wst.server.core.model.ServerBehaviourDelegate.publish",
          "source": "ServerBehaviourDelegate.java:590"
        },
        {
          "method": "org.eclipse.wst.server.core.internal.Server.doPublish",
          "source": "Server.java:803"
        },
        {
          "method": "org.eclipse.wst.server.core.internal.Server.publish",
          "source": "Server.java:791"
        },
        {
          "method": "org.eclipse.jst.ws.internal.consumption.ui.command.StartServerCommand$1.run",
          "source": "StartServerCommand.java:129"
        },
        {
          "method": "org.eclipse.jface.operation.ModalContext$ModalContextThread.run",
          "source": "ModalContext.java:113"
        }
      ],
      "number": 1,
      "commentIndex": 10,
      "bugId": "125524",
      "date": "2006-06-15T16:50:21+02:00",
      "product": "Web Tools",
      "component": "jst.server",
      "severity": "major"
    }
  ],
  "groupId": "125524",
  "bugId": "125524",
  "date": "2006-01-27T18:29:23+01:00",
  "product": "Web Tools",
  "component": "jst.server",
  "severity": "major"
}