{
  "comments": [
    "N20070707-0010\n\nThis is somewhat hard to reproduce, seams to be a timing issue:\n1. Go to org.eclipse.jdt.internal.ui.fix.CleanUpSaveParticipantConfigurationModifyDialog.createDialogArea(Composite)\nrev 1.4\n2. Select composite.getFont()\n3. Ctrl-1\n4. Select \u0027Extract to local variable\u0027 and while the operation runs press \u0027Del\u0027\nIs:\n org.eclipse.core.runtime.CoreException[4]: org.eclipse.jface.text.BadLocationException: First position: \u0027font\u0027 at 4592, this position: \u0027);\n\u0027 at 4641\n        at org.eclipse.jface.text.link.LinkedPositionGroup.enforceEqualContent(LinkedPositionGroup.java:130)\n        at org.eclipse.jface.text.link.LinkedPositionGroup.addPosition(LinkedPositionGroup.java:111)\n        at org.eclipse.jdt.internal.ui.text.correction.CUCorrectionProposal.enterLinkedMode(CUCorrectionProposal.java:348)\n        at org.eclipse.jdt.internal.ui.text.correction.CUCorrectionProposal.performChange(CUCorrectionProposal.java:313)\n        at org.eclipse.jdt.internal.ui.text.correction.CUCorrectionProposal.apply(CUCorrectionProposal.java:282)\n        at org.eclipse.jface.text.contentassist.CompletionProposalPopup.insertProposal(CompletionProposalPopup.java:811)\n        at org.eclipse.jface.text.contentassist.CompletionProposalPopup.insertSelectedProposalWithMask(CompletionProposalPopup.java:757)\n        at org.eclipse.jface.text.contentassist.CompletionProposalPopup.verifyKey(CompletionProposalPopup.java:1165)\n        at org.eclipse.jface.text.contentassist.ContentAssistant$InternalListener.verifyKey(ContentAssistant.java:788)\n        at org.eclipse.jface.text.TextViewer$VerifyKeyListenersManager.verifyKey(TextViewer.java:460)\n        at org.eclipse.swt.custom.StyledTextListener.handleEvent(StyledTextListener.java:60)\n        at org.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:66)\n        at org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:938)\n        at org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:962)\n        at org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:947)\n        at org.eclipse.swt.widgets.Widget.notifyListeners(Widget.java:706)\n        at org.eclipse.swt.custom.StyledText.handleKeyDown(StyledText.java:5052)\n        at org.eclipse.swt.custom.StyledText$7.handleEvent(StyledText.java:4800)\n        at org.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:66)\n        at org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:938)\n        at org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:962)\n        at org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:947)\n        at org.eclipse.swt.widgets.Widget.sendKeyEvent(Widget.java:975)\n        at org.eclipse.swt.widgets.Widget.sendKeyEvent(Widget.java:971)\n        at org.eclipse.swt.widgets.Widget.wmChar(Widget.java:1285)\n        at org.eclipse.swt.widgets.Control.WM_CHAR(Control.java:3772)\n        at org.eclipse.swt.widgets.Control.windowProc(Control.java:3672)\n        at org.eclipse.swt.widgets.Canvas.windowProc(Canvas.java:291)\n        at org.eclipse.swt.widgets.Display.windowProc(Display.java:4350)\n        at org.eclipse.swt.internal.win32.OS.$$YJP$$DispatchMessageW(Native Method)\n        at org.eclipse.swt.internal.win32.OS.DispatchMessageW(OS.java)\n        at org.eclipse.swt.internal.win32.OS.DispatchMessage(OS.java:2264)\n        at org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:3290)\n        at org.eclipse.ui.internal.Workbench.runEventLoop(Workbench.java:2389)\n        at org.eclipse.ui.internal.Workbench.runUI(Workbench.java:2353)\n        at org.eclipse.ui.internal.Workbench.access$4(Workbench.java:2219)\n        at org.eclipse.ui.internal.Workbench$4.run(Workbench.java:466)\n        at org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:289)\n        at org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:461)\n        at org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:149)\n        at org.eclipse.ui.internal.ide.application.IDEApplication.start(IDEApplication.java:106)\n        at org.eclipse.equinox.internal.app.EclipseAppHandle.run(EclipseAppHandle.java:153)\n        at org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(EclipseAppLauncher.java:106)\n        at org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(EclipseAppLauncher.java:76)\n        at org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:363)\n        at org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:176)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.eclipse.equinox.launcher.Main.invokeFramework(Main.java:504)\n        at org.eclipse.equinox.launcher.Main.basicRun(Main.java:443)\n        at org.eclipse.equinox.launcher.Main.run(Main.java:1169)\n        at org.eclipse.equinox.launcher.Main.main(Main.java:1144)\n        at org.eclipse.core.launcher.Main.main(Main.java:30)\n\nNow Undo works not correct anymore.",
    "I also could not reproduce in a runtime workbench, but it often happens when I try it in the host workbench. When I attached a debugger and halted in the BadLocationException, I saw that the document contained\n\n\t\tFont font\u003d composite.getFont();\n\t\tfTabFolder.setFont();\n\n..., i.e. the argument to setFont(Font) has already been deleted. It looks like the document has been changed some time after the refactoring changes have been applied (in ChangeCorrectionProposal.performChange(..)) and before we try to add linked positions.\n\nFrom looking at the code, this can only happen if either the Delete key changes the document in another thread, or if the event loop is driven somewhere.",
    "Found the culprit by setting a breakpoint at the beginning of StyledText#handleKeyDown(Event) with this condition ...\n\nint kc\u003d event.keyCode;\nSystem.out.println(\"keyCode: \" + kc);\nreturn kc \u003d\u003d 120;\n\n... and then quickly pressing the \"x\" key (not Delete) after selecting the quick fix with Enter. At this time, stdout ends with ...\n\nkeyCode: 13\nkeyCode: 120\n\n... and the stack looks like the one below. The problem is that the EventLoopProgressMonitor runs the event loop after the change has been performed but before the linked mode is set up.\n\nStyledText.handleKeyDown(Event) line: 5047\t\nStyledText$7.handleEvent(Event) line: 4800\t\nEventTable.sendEvent(Event) line: 66\t\nStyledText(Widget).sendEvent(Event) line: 938\t\nStyledText(Widget).sendEvent(int, Event, boolean) line: 962\t\nStyledText(Widget).sendEvent(int, Event) line: 947\t\nStyledText(Widget).sendKeyEvent(int, int, int, int, Event) line: 975\t\nStyledText(Widget).sendKeyEvent(int, int, int, int) line: 971\t\nStyledText(Widget).wmChar(int, int, int) line: 1285\t\nStyledText(Control).WM_CHAR(int, int) line: 3772\t\nStyledText(Control).windowProc(int, int, int, int) line: 3672\t\nStyledText(Canvas).windowProc(int, int, int, int) line: 291\t\nDisplay.windowProc(int, int, int, int) line: 4350\t\nOS.$$YJP$$DispatchMessageW(MSG) line: not available [native method]\t\nOS.DispatchMessageW(MSG) line: not available\t\nOS.DispatchMessage(MSG) line: 2264\t\nDisplay.readAndDispatch() line: 3290\t\nEventLoopProgressMonitor.runEventLoop() line: 123\t\nEventLoopProgressMonitor.isCanceled() line: 97\t\nThreadJob.isCanceled(IProgressMonitor) line: 132\t\nThreadJob.joinRun(IProgressMonitor) line: 167\t\nImplicitJobs.begin(ISchedulingRule, IProgressMonitor, boolean) line: 87\t\nJobManager.beginRule(ISchedulingRule, IProgressMonitor) line: 225\t\nWorkManager.checkIn(ISchedulingRule, IProgressMonitor) line: 117\t\nWorkspace.prepareOperation(ISchedulingRule, IProgressMonitor) line: 1744\t\nWorkspace.checkpoint(boolean) line: 363\t\nUndoableOperation2ChangeAdapter.aboutToNotify(OperationHistoryEvent) line: 277\t\nTriggeredOperations.aboutToNotify(OperationHistoryEvent) line: 362\t\nDefaultOperationHistory$1.run() line: 911\t\nSafeRunner.run(ISafeRunnable) line: 37\t\nDefaultOperationHistory.notifyListeners(OperationHistoryEvent) line: 900\t\nDefaultOperationHistory.notifyDone(IUndoableOperation) line: 992\t\nDefaultOperationHistory.closeOperation(boolean, boolean, int) line: 1359\t\nUndoManager2.changePerformed(Change, boolean) line: 149\t\nQuickAssistProcessor$1(ChangeCorrectionProposal).performChange(IEditorPart, IDocument) line: 124\t\nQuickAssistProcessor$1(CUCorrectionProposal).performChange(IEditorPart, IDocument) line: 304\t\nQuickAssistProcessor$1(CUCorrectionProposal).apply(IDocument) line: 282\t\nCompletionProposalPopup.insertProposal(ICompletionProposal, char, int, int) line: 811\t\nCompletionProposalPopup.insertSelectedProposalWithMask(int) line: 757\t\nCompletionProposalPopup.verifyKey(VerifyEvent) line: 1165\t\nContentAssistant$InternalListener.verifyKey(VerifyEvent) line: 788\t\nTextViewer$VerifyKeyListenersManager.verifyKey(VerifyEvent) line: 460\t\nStyledTextListener.handleEvent(Event) line: 60\t\nEventTable.sendEvent(Event) line: 66\t\nStyledText(Widget).sendEvent(Event) line: 938\t\nStyledText(Widget).sendEvent(int, Event, boolean) line: 962\t\nStyledText(Widget).sendEvent(int, Event) line: 947\t\nStyledText(Widget).notifyListeners(int, Event) line: 706\t\nStyledText.handleKeyDown(Event) line: 5052\t\n...\n",
    "I guess we should not get an EventLoopProgressMonitor any more when changes are executed in a non-UI thread, see bug 175733."
  ],
  "commentCreationDates": [
    "2007-07-09T16:42:45+02:00",
    "2007-07-09T19:48:07+02:00",
    "2007-07-09T19:59:39+02:00",
    "2007-07-10T10:32:33+02:00"
  ],
  "traces": [
    {
      "exceptionType": "org.eclipse.jface.text.BadLocationException",
      "message": "First position: \u0027font\u0027 at 4592, this position: \u0027); \u0027",
      "elements": [
        {
          "method": "4641atorg.eclipse.jface.text.link.LinkedPositionGroup.enforceEqualContent",
          "source": "LinkedPositionGroup.java:130"
        },
        {
          "method": "org.eclipse.jface.text.link.LinkedPositionGroup.addPosition",
          "source": "LinkedPositionGroup.java:111"
        },
        {
          "method": "org.eclipse.jdt.internal.ui.text.correction.CUCorrectionProposal.enterLinkedMode",
          "source": "CUCorrectionProposal.java:348"
        },
        {
          "method": "org.eclipse.jdt.internal.ui.text.correction.CUCorrectionProposal.performChange",
          "source": "CUCorrectionProposal.java:313"
        },
        {
          "method": "org.eclipse.jdt.internal.ui.text.correction.CUCorrectionProposal.apply",
          "source": "CUCorrectionProposal.java:282"
        },
        {
          "method": "org.eclipse.jface.text.contentassist.CompletionProposalPopup.insertProposal",
          "source": "CompletionProposalPopup.java:811"
        },
        {
          "method": "org.eclipse.jface.text.contentassist.CompletionProposalPopup.insertSelectedProposalWithMask",
          "source": "CompletionProposalPopup.java:757"
        },
        {
          "method": "org.eclipse.jface.text.contentassist.CompletionProposalPopup.verifyKey",
          "source": "CompletionProposalPopup.java:1165"
        },
        {
          "method": "org.eclipse.jface.text.contentassist.ContentAssistant$InternalListener.verifyKey",
          "source": "ContentAssistant.java:788"
        },
        {
          "method": "org.eclipse.jface.text.TextViewer$VerifyKeyListenersManager.verifyKey",
          "source": "TextViewer.java:460"
        },
        {
          "method": "org.eclipse.swt.custom.StyledTextListener.handleEvent",
          "source": "StyledTextListener.java:60"
        },
        {
          "method": "org.eclipse.swt.widgets.EventTable.sendEvent",
          "source": "EventTable.java:66"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:938"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:962"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:947"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.notifyListeners",
          "source": "Widget.java:706"
        },
        {
          "method": "org.eclipse.swt.custom.StyledText.handleKeyDown",
          "source": "StyledText.java:5052"
        },
        {
          "method": "org.eclipse.swt.custom.StyledText$7.handleEvent",
          "source": "StyledText.java:4800"
        },
        {
          "method": "org.eclipse.swt.widgets.EventTable.sendEvent",
          "source": "EventTable.java:66"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:938"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:962"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:947"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendKeyEvent",
          "source": "Widget.java:975"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendKeyEvent",
          "source": "Widget.java:971"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.wmChar",
          "source": "Widget.java:1285"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.WM_CHAR",
          "source": "Control.java:3772"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.windowProc",
          "source": "Control.java:3672"
        },
        {
          "method": "org.eclipse.swt.widgets.Canvas.windowProc",
          "source": "Canvas.java:291"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.windowProc",
          "source": "Display.java:4350"
        },
        {
          "method": "org.eclipse.swt.internal.win32.OS.$$YJP$$DispatchMessageW",
          "source": "Native Method"
        },
        {
          "method": "org.eclipse.swt.internal.win32.OS.DispatchMessageW",
          "source": "OS.java"
        },
        {
          "method": "org.eclipse.swt.internal.win32.OS.DispatchMessage",
          "source": "OS.java:2264"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.readAndDispatch",
          "source": "Display.java:3290"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runEventLoop",
          "source": "Workbench.java:2389"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runUI",
          "source": "Workbench.java:2353"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.access$4",
          "source": "Workbench.java:2219"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench$4.run",
          "source": "Workbench.java:466"
        },
        {
          "method": "org.eclipse.core.databinding.observable.Realm.runWithDefault",
          "source": "Realm.java:289"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.createAndRunWorkbench",
          "source": "Workbench.java:461"
        },
        {
          "method": "org.eclipse.ui.PlatformUI.createAndRunWorkbench",
          "source": "PlatformUI.java:149"
        },
        {
          "method": "org.eclipse.ui.internal.ide.application.IDEApplication.start",
          "source": "IDEApplication.java:106"
        },
        {
          "method": "org.eclipse.equinox.internal.app.EclipseAppHandle.run",
          "source": "EclipseAppHandle.java:153"
        },
        {
          "method": "org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication",
          "source": "EclipseAppLauncher.java:106"
        },
        {
          "method": "org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start",
          "source": "EclipseAppLauncher.java:76"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:363"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:176"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "NativeMethodAccessorImpl.java:39"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "DelegatingMethodAccessorImpl.java:25"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Method.java:597"
        },
        {
          "method": "org.eclipse.equinox.launcher.Main.invokeFramework",
          "source": "Main.java:504"
        },
        {
          "method": "org.eclipse.equinox.launcher.Main.basicRun",
          "source": "Main.java:443"
        },
        {
          "method": "org.eclipse.equinox.launcher.Main.run",
          "source": "Main.java:1169"
        },
        {
          "method": "org.eclipse.equinox.launcher.Main.main",
          "source": "Main.java:1144"
        },
        {
          "method": "org.eclipse.core.launcher.Main.main",
          "source": "Main.java:30"
        }
      ],
      "number": 0,
      "commentIndex": 0,
      "bugId": "195834",
      "date": "2007-07-09T16:42:45+02:00",
      "product": "JDT",
      "component": "UI",
      "severity": "normal"
    }
  ],
  "groupId": "195834",
  "bugId": "195834",
  "date": "2007-07-09T16:42:45+02:00",
  "product": "JDT",
  "component": "UI",
  "severity": "normal"
}