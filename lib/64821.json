{
  "comments": [
    "build I20040529-0105\n\n- ran the browser example under debug\n- exited\n- saw the following in the log\n\nIn this case, the decoration scheduler should not have even been running since\nthere were no installed decorators.\n\njava.lang.NoClassDefFoundError: org/eclipse/ui/internal/progress/SubTaskInfo\n\tat java.lang.ClassLoader.defineClass0(Native Method)\n\tat java.lang.ClassLoader.defineClass(ClassLoader.java:537)\n\tat\norg.eclipse.osgi.framework.internal.defaultadaptor.DefaultClassLoader.defineClass(DefaultClassLoader.java:298)\n\tat\norg.eclipse.core.runtime.adaptor.EclipseClassLoader.defineClass(EclipseClassLoader.java:213)\n\tat\norg.eclipse.osgi.framework.internal.defaultadaptor.DefaultClassLoader.findClassImpl(DefaultClassLoader.java:281)\n\tat\norg.eclipse.osgi.framework.internal.defaultadaptor.DefaultClassLoader.findClass(DefaultClassLoader.java:172)\n\tat\norg.eclipse.osgi.framework.adaptor.core.AbstractClassLoader.findLocalClass(AbstractClassLoader.java:220)\n\tat\norg.eclipse.core.runtime.adaptor.EclipseClassLoader.basicFindLocalClass(EclipseClassLoader.java:132)\n\tat\norg.eclipse.core.runtime.adaptor.EclipseClassLoader.findLocalClass(EclipseClassLoader.java:60)\n\tat\norg.eclipse.osgi.framework.internal.core.BundleLoader.findLocalClass(BundleLoader.java:371)\n\tat\norg.eclipse.osgi.framework.internal.core.BundleLoader.findClass(BundleLoader.java:402)\n\tat\norg.eclipse.osgi.framework.adaptor.core.AbstractClassLoader.loadClass(AbstractClassLoader.java:93)\n\tat java.lang.ClassLoader.loadClass(ClassLoader.java:235)\n\tat java.lang.ClassLoader.loadClassInternal(ClassLoader.java:302)\n\tat org.eclipse.ui.internal.progress.JobInfo.beginTask(JobInfo.java:150)\n\tat\norg.eclipse.ui.internal.progress.ProgressManager$JobMonitor.beginTask(ProgressManager.java:167)\n\tat\norg.eclipse.ui.internal.decorators.DecorationScheduler$1.run(DecorationScheduler.java:220)\n\tat org.eclipse.core.internal.jobs.Worker.run(Worker.java:66)",
    "I was running a slightly modified version of the browser example, with a PDE\nsample view added, but this does nothing with decorators eitehr.\n",
    "The decoration scheduler is getting created on shutdown:\n\nThread [main] (Suspended (breakpoint at line 63 in DecorationScheduler))\n\tDecorationScheduler.\u003cinit\u003e(DecoratorManager) line: 63\n\tDecoratorManager.\u003cinit\u003e() line: 112\n\tWorkbenchPlugin.getDecoratorManager() line: 599\n\tWorkbench.getDecoratorManager() line: 1652\n\tWorkbench.shutdown() line: 1635\n\tWorkbench.busyClose(boolean) line: 468\n\tWorkbench.access$8(Workbench, boolean) line: 399\n\tWorkbench$12.run() line: 571\n\tBusyIndicator.showWhile(Display, Runnable) line: 69\n\tWorkbench.close(int, boolean) line: 569\n\tWorkbench.close() line: 545\n\tWorkbenchWindow.busyClose() line: 463\n\tWorkbenchWindow.access$0(WorkbenchWindow) line: 448\n\tWorkbenchWindow$1.run() line: 536\n\tBusyIndicator.showWhile(Display, Runnable) line: 69\n\tWorkbenchWindow.close() line: 534\n\tWorkbenchWindow(Window).handleShellCloseEvent() line: 593\n\tWindow$2.shellClosed(ShellEvent) line: 544\n\tTypedListener.handleEvent(Event) line: 158\n\tEventTable.sendEvent(Event) line: 82\n\tShell(Widget).sendEvent(Event) line: 796\n\tShell(Widget).sendEvent(int, Event, boolean) line: 820\n\tShell(Widget).sendEvent(int, Event) line: 805\n\tShell(Decorations).WM_CLOSE(int, int) line: 1487\n\tShell(Control).windowProc(int, int, int, int) line: 2953\n\tShell(Decorations).windowProc(int, int, int, int) line: 1430\n\tDisplay.windowProc(int, int, int, int) line: 3282\n\tOS.DefWindowProcW(int, int, int, int) line: not available [native method]\n\tOS.DefWindowProc(int, int, int, int) line: 1454\n\tShell.callWindowProc(int, int, int) line: 398\n\tShell(Control).windowProc(int, int, int, int) line: 3031\n\tShell(Decorations).windowProc(int, int, int, int) line: 1430\n\tDisplay.windowProc(int, int, int, int) line: 3282\n\tOS.DispatchMessageW(MSG) line: not available [native method]\n\tOS.DispatchMessage(MSG) line: 1459\n\tDisplay.readAndDispatch() line: 2380\n\tWorkbench.runEventLoop(Window$IExceptionHandler, Display) line: 1363\n\tWorkbench.runUI() line: 1334\n\tWorkbench.createAndRunWorkbench(Display, WorkbenchAdvisor) line: 253\n\tPlatformUI.createAndRunWorkbench(Display, WorkbenchAdvisor) line: 141\n\tBrowserApp.run(Object) line: 52\n\tPlatformActivator$1.run(Object) line: 334\n\tEclipseStarter.run(Object) line: 273\n\tEclipseStarter.run(String[], Runnable) line: 128\n\tNativeMethodAccessorImpl.invoke0(Method, Object, Object[]) line: not available\n[native method]\n\tNativeMethodAccessorImpl.invoke(Object, Object[]) line: 39\n\tDelegatingMethodAccessorImpl.invoke(Object, Object[]) line: 25\n\tMethod.invoke(Object, Object[]) line: 324\n\tMain.basicRun(String[]) line: 185\n\tMain.run(String[]) line: 638\n\tMain.main(String[]) line: 622\n",
    "WorkbenchPlugin.reset() already disposes the decoratorManager, if non-null.  But\nthis occurs after Workbench.shutdown() calls\nProgressManager.getInstance().shutdown();\n\nNot sure if there\u0027s an order dependency here.\n",
    "There are two issues here\n\n1) Osgi cannot find classes in the same package on shutdown - adding Pascal to \ncomment on this.\n2) We need to optimize out for the case where there is no scheduler.",
    "Nick do you *always* have the NoClassDefFoundError?\n",
    "No, it is intermittent.  It happens about half the time.\n\n",
    "The ProgressManager is also getting lazily created on shutdown.\nWorkbench.shutdown() does:\n\t\tProgressManager.getInstance().shutdown();\n",
    "I think there is a deeper problem here in that the workbench can be shut down\nwhile there are still jobs running.\nEven if we fix up the initialization of the decorator manager on shutdown, the\nmore general problem will still remain.\n\nMore steps are needed to reproduce this:\n\n- before running, delete BrowserAdvisor.createWindowContents \n  - so it uses the default window contents\n- in BrowserAdvisor.preWindowOpen, add: configurer.setShowProgressIndicator(true)\n  - this causes the progress manager to be initialized before shutdown (it\u0027s not\notherwise)\n\n- to ensure that the race condition happens:\n  - set a breakpoint in Workbench.shutdown() before it disposes the decorator\nmanager.\n  - set a breakpoint on the first line of the run method of the nested job class\nin DecorationSchedule.createDecorationJob\n\n- run the browser example under debug, then close it\n- the first breakpoint is hit, in the UI thread\n- step over\n- the second breakpoint is hit, in a job thread\n- keep stepping in the UI thread until you get to EclipseStarter.shutdown()\n- go through this\n- runtime is now shutdown\n- now step through the job thread\n- you get a NoClassDefFoundError when it tries to resolve classes needed by the\nprogress monitor\n\n\n\n\n",
    "Tod and John, let me know if you\u0027d like me to discuss this further, or if you\nwant me to demo this.\n",
    "Fixed with Nick for build \u003e20040408",
    "Verified in 20040609"
  ],
  "commentCreationDates": [
    "2004-05-31T21:50:31+02:00",
    "2004-05-31T21:51:26+02:00",
    "2004-05-31T21:53:11+02:00",
    "2004-05-31T21:56:50+02:00",
    "2004-05-31T21:58:27+02:00",
    "2004-05-31T22:24:14+02:00",
    "2004-05-31T23:16:44+02:00",
    "2004-06-01T16:27:09+02:00",
    "2004-06-01T17:02:21+02:00",
    "2004-06-01T17:26:08+02:00",
    "2004-06-08T21:05:59+02:00",
    "2004-06-09T17:35:14+02:00"
  ],
  "traces": [
    {
      "exceptionType": "java.lang.NoClassDefFoundError",
      "message": "org/eclipse/ui/internal/progress/SubTaskInfo",
      "elements": [
        {
          "method": "java.lang.ClassLoader.defineClass0",
          "source": "Native Method"
        },
        {
          "method": "java.lang.ClassLoader.defineClass",
          "source": "ClassLoader.java:537"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.defaultadaptor.DefaultClassLoader.defineClass",
          "source": "DefaultClassLoader.java:298"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseClassLoader.defineClass",
          "source": "EclipseClassLoader.java:213"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.defaultadaptor.DefaultClassLoader.findClassImpl",
          "source": "DefaultClassLoader.java:281"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.defaultadaptor.DefaultClassLoader.findClass",
          "source": "DefaultClassLoader.java:172"
        },
        {
          "method": "org.eclipse.osgi.framework.adaptor.core.AbstractClassLoader.findLocalClass",
          "source": "AbstractClassLoader.java:220"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseClassLoader.basicFindLocalClass",
          "source": "EclipseClassLoader.java:132"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseClassLoader.findLocalClass",
          "source": "EclipseClassLoader.java:60"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleLoader.findLocalClass",
          "source": "BundleLoader.java:371"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleLoader.findClass",
          "source": "BundleLoader.java:402"
        },
        {
          "method": "org.eclipse.osgi.framework.adaptor.core.AbstractClassLoader.loadClass",
          "source": "AbstractClassLoader.java:93"
        },
        {
          "method": "java.lang.ClassLoader.loadClass",
          "source": "ClassLoader.java:235"
        },
        {
          "method": "java.lang.ClassLoader.loadClassInternal",
          "source": "ClassLoader.java:302"
        },
        {
          "method": "org.eclipse.ui.internal.progress.JobInfo.beginTask",
          "source": "JobInfo.java:150"
        },
        {
          "method": "org.eclipse.ui.internal.progress.ProgressManager$JobMonitor.beginTask",
          "source": "ProgressManager.java:167"
        },
        {
          "method": "org.eclipse.ui.internal.decorators.DecorationScheduler$1.run",
          "source": "DecorationScheduler.java:220"
        },
        {
          "method": "org.eclipse.core.internal.jobs.Worker.run",
          "source": "Worker.java:66"
        }
      ],
      "number": 0,
      "commentIndex": 0,
      "bugId": "64821",
      "date": "2004-05-31T21:50:31+02:00",
      "product": "Platform",
      "component": "UI",
      "severity": "major"
    }
  ],
  "groupId": "64821",
  "bugId": "64821",
  "date": "2004-05-31T21:50:31+02:00",
  "product": "Platform",
  "component": "UI",
  "severity": "major"
}