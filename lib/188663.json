{
  "comments": [
    "Seen with 3.3 M7\n\nI have a virtual TreeViewer/ILazyTreeContentProvider with multiple columns.\nUpon setting new input, the first row stays blank with the exception of the first cell. And the last row shows the labels of the first row, with the exception of the first cell.\n\nThe attached plugin shows the problem: When opening the view, the second column\u0027s label is blank on the first row, and the third row\u0027s second column shows the label that should be in the first row. Pressing refresh makes the problem go away. Pressing \u0027New Input\u0027 shows the problem again.\n\nI did some debugging and here\u0027s what I can come up with: When an empty tree is populated, setting an image into the first column on the first row will create a new image list in Tree#imageIndex(Image, int). The call to OS.SendMessage (handle, OS.TVM_SETIMAGELIST, OS.TVSIL_NORMAL, hImageList); somehow causes all following SWT.SetData events to be handled before the first one that was about to set the image into the tree item.\n\nThe attached SWT snippet shows this clearer (logged on the console).\n\nOnce the first SetData callback gets control again, ColumnViewer\u0027s cached cell already points to the last row, which would explain why the first one stays empty and the last one gets the first row\u0027s labels.",
    "Created an attachment (id\u003d68360)\nViewer sample illustrating the problem\n\n",
    "Created an attachment (id\u003d68362)\nSWT snippet showing the order of SetData events\n\n",
    "Moving to SWT for comment.  When running the SWT-only snippet, you can see that a nested SetData callback is happening as a result of calling TreeItem.setIndex. Is this a bug, or should JFace protect itself against nested events like that (e.g. by not caching)? This is a stack trace of when it happens:\n\njava.lang.Exception: Stack trace\n\tat java.lang.Thread.dumpStack(Unknown Source)\n\tat Test$3.handleEvent(Test.java:82)\n\tat org.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:66)\n\tat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:938)\n\tat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:962)\n\tat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:947)\n\tat org.eclipse.swt.widgets.Tree.checkData(Tree.java:1596)\n\tat org.eclipse.swt.widgets.Tree.checkData(Tree.java:1584)\n\tat org.eclipse.swt.widgets.Tree.wmNotifyChild(Tree.java:6714)\n\tat org.eclipse.swt.widgets.Control.wmNotify(Control.java:4555)\n\tat org.eclipse.swt.widgets.Composite.wmNotify(Composite.java:1581)\n\tat org.eclipse.swt.widgets.Control.WM_NOTIFY(Control.java:4208)\n\tat org.eclipse.swt.widgets.Control.windowProc(Control.java:3716)\n\tat org.eclipse.swt.widgets.Decorations.windowProc(Decorations.java:1584)\n\tat org.eclipse.swt.widgets.Shell.windowProc(Shell.java:1753)\n\tat org.eclipse.swt.widgets.Display.windowProc(Display.java:4342)\n\tat org.eclipse.swt.internal.win32.OS.CallWindowProcW(Native Method)\n\tat org.eclipse.swt.internal.win32.OS.CallWindowProc(OS.java:2177)\n\tat org.eclipse.swt.widgets.Tree.callWindowProc(Tree.java:1501)\n\tat org.eclipse.swt.widgets.Control.windowProc(Control.java:3752)\n\tat org.eclipse.swt.widgets.Tree.windowProc(Tree.java:5275)\n\tat org.eclipse.swt.widgets.Display.windowProc(Display.java:4342)\n\tat org.eclipse.swt.internal.win32.OS.SendMessageW(Native Method)\n\tat org.eclipse.swt.internal.win32.OS.SendMessage(OS.java:2899)\n\tat org.eclipse.swt.widgets.Tree.imageIndex(Tree.java:3417)\n\tat org.eclipse.swt.widgets.TreeItem.setImage(TreeItem.java:1685)\n\tat Test$3.handleEvent(Test.java:86)\n\tat org.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:66)\n\tat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:938)\n\tat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:962)\n\tat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:947)\n\tat org.eclipse.swt.widgets.Tree.checkData(Tree.java:1596)\n\tat org.eclipse.swt.widgets.Tree.checkData(Tree.java:1584)\n\tat org.eclipse.swt.widgets.Tree.wmNotifyChild(Tree.java:6714)\n\tat org.eclipse.swt.widgets.Control.wmNotify(Control.java:4555)\n\tat org.eclipse.swt.widgets.Composite.wmNotify(Composite.java:1581)\n\tat org.eclipse.swt.widgets.Control.WM_NOTIFY(Control.java:4208)\n\tat org.eclipse.swt.widgets.Control.windowProc(Control.java:3716)\n\tat org.eclipse.swt.widgets.Decorations.windowProc(Decorations.java:1584)\n\tat org.eclipse.swt.widgets.Shell.windowProc(Shell.java:1753)\n\tat org.eclipse.swt.widgets.Display.windowProc(Display.java:4342)\n\tat org.eclipse.swt.internal.win32.OS.CallWindowProcW(Native Method)\n\tat org.eclipse.swt.internal.win32.OS.CallWindowProc(OS.java:2177)\n\tat org.eclipse.swt.widgets.Tree.callWindowProc(Tree.java:1501)\n\tat org.eclipse.swt.widgets.Tree.WM_PAINT(Tree.java:6169)\n\tat org.eclipse.swt.widgets.Control.windowProc(Control.java:3717)\n\tat org.eclipse.swt.widgets.Tree.windowProc(Tree.java:5275)\n\tat org.eclipse.swt.widgets.Display.windowProc(Display.java:4355)\n\tat org.eclipse.swt.internal.win32.OS.DispatchMessageW(Native Method)\n\tat org.eclipse.swt.internal.win32.OS.DispatchMessage(OS.java:2263)\n\tat org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:3282)\n\tat Test.main(Test.java:31)\n",
    "Darin, have you seen anything like this, or is this not an issue for you because of the async-ness?",
    "I have not seen this... it could be that our async-ness works around the problem.",
    "When the first image is set into a tree item, the tree needs to redraw and determine the height of the tree items, update the scroll bars etc.  When a tree needs the text and image for an item, it calls WM_NOTIFY.  We have no control over when (and why) this is called (but it is most often called when a tree needs to be painted).\n\nI\u0027m leaning towards WONTFIX on this one.  Please advise.",
    "We\u0027ll have to look at our cake and fix the caching problems resulting from this. Moving back to UI.",
    "Keep me in the loop.",
    "Created an attachment (id\u003d68596)\nJFace-only snippet showing the problem\n\n",
    "Created an attachment (id\u003d68607)\nIt is even worse when you add background colors\n\n",
    "Created an attachment (id\u003d68609)\npatch\n\n",
    "I only need two of you to review this, but I would like to get this into a build as soon as possible so that this can be verified.\n\nThe patch avoids caching if the tree is virtual. Caching does not work because of the recursive back-call that can happen, see the stack trace from comment #3.\n\nThe caching was put in to get the JFace performance tests back to a green state. My hope is that after fixing this, the performance tests will still be green, since they don\u0027t use SWT.VIRTUAL.\n\nI have applied the same changes to table since I suspect a similar thing could happen there as well.",
    "\nOk by me... +1\n",
    "Released \u003e20070524.  Tom, could you please double-check the patch even though Kim and Eric +1ed it already? Thanks.",
    "Another possibility would be if we have a method:\n\u003d\u003e ViewerRow#setTextImage(String,Image,int) this would make cloning needless because we can keep a local-copy of item in the method and are not affected by underlying change ViewerCell.",
    "(In reply to comment #15)\n\u003e Another possibility would be if we have a method:\n\u003e \u003d\u003e ViewerRow#setTextImage(String,Image,int) this would make cloning needless\n\u003e because we can keep a local-copy of item in the method and are not affected by\n\u003e underlying change ViewerCell.\n\nGood idea - but: We are (currently) setting the text, the image, the background colour, the foreground colour, and the font. Any of these (most likely: image, font) could cause further SetData events in the virtual case.  So this method would have to have more arguments, and we would have to extend the argument list whenever SWT adds new capabilities.",
    "Thanks for taking care of this so quickly. It\u0027s highly appreciated.",
    "Well what I don\u0027t like it is that we are fixing an SWT-Control problem in a generic class where e.g. Nebula-Virtual-Controls might not have this problem. I know there are currently no implementors providing Virtual-Widgets but if we could somehow move the work-around to the concrete implementation class it would be better.",
    "Verified using I20070525-0010 on Windows XP."
  ],
  "commentCreationDates": [
    "2007-05-23T17:16:54+02:00",
    "2007-05-23T17:18:46+02:00",
    "2007-05-23T17:20:45+02:00",
    "2007-05-23T20:33:18+02:00",
    "2007-05-23T20:50:18+02:00",
    "2007-05-23T21:10:49+02:00",
    "2007-05-24T14:25:04+02:00",
    "2007-05-24T14:58:24+02:00",
    "2007-05-24T15:41:59+02:00",
    "2007-05-24T17:39:38+02:00",
    "2007-05-24T18:01:45+02:00",
    "2007-05-24T18:06:46+02:00",
    "2007-05-24T18:13:33+02:00",
    "2007-05-24T18:22:35+02:00",
    "2007-05-24T18:24:24+02:00",
    "2007-05-25T10:06:15+02:00",
    "2007-05-25T15:03:50+02:00",
    "2007-05-25T15:13:21+02:00",
    "2007-05-25T16:42:16+02:00",
    "2007-05-25T18:55:30+02:00"
  ],
  "traces": [
    {
      "exceptionType": "java.lang.Exception",
      "message": "Stack trace",
      "elements": [
        {
          "method": "java.lang.Thread.dumpStack",
          "source": "Unknown Source"
        },
        {
          "method": "Test$3.handleEvent",
          "source": "Test.java:82"
        },
        {
          "method": "org.eclipse.swt.widgets.EventTable.sendEvent",
          "source": "EventTable.java:66"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:938"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:962"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:947"
        },
        {
          "method": "org.eclipse.swt.widgets.Tree.checkData",
          "source": "Tree.java:1596"
        },
        {
          "method": "org.eclipse.swt.widgets.Tree.checkData",
          "source": "Tree.java:1584"
        },
        {
          "method": "org.eclipse.swt.widgets.Tree.wmNotifyChild",
          "source": "Tree.java:6714"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.wmNotify",
          "source": "Control.java:4555"
        },
        {
          "method": "org.eclipse.swt.widgets.Composite.wmNotify",
          "source": "Composite.java:1581"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.WM_NOTIFY",
          "source": "Control.java:4208"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.windowProc",
          "source": "Control.java:3716"
        },
        {
          "method": "org.eclipse.swt.widgets.Decorations.windowProc",
          "source": "Decorations.java:1584"
        },
        {
          "method": "org.eclipse.swt.widgets.Shell.windowProc",
          "source": "Shell.java:1753"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.windowProc",
          "source": "Display.java:4342"
        },
        {
          "method": "org.eclipse.swt.internal.win32.OS.CallWindowProcW",
          "source": "Native Method"
        },
        {
          "method": "org.eclipse.swt.internal.win32.OS.CallWindowProc",
          "source": "OS.java:2177"
        },
        {
          "method": "org.eclipse.swt.widgets.Tree.callWindowProc",
          "source": "Tree.java:1501"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.windowProc",
          "source": "Control.java:3752"
        },
        {
          "method": "org.eclipse.swt.widgets.Tree.windowProc",
          "source": "Tree.java:5275"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.windowProc",
          "source": "Display.java:4342"
        },
        {
          "method": "org.eclipse.swt.internal.win32.OS.SendMessageW",
          "source": "Native Method"
        },
        {
          "method": "org.eclipse.swt.internal.win32.OS.SendMessage",
          "source": "OS.java:2899"
        },
        {
          "method": "org.eclipse.swt.widgets.Tree.imageIndex",
          "source": "Tree.java:3417"
        },
        {
          "method": "org.eclipse.swt.widgets.TreeItem.setImage",
          "source": "TreeItem.java:1685"
        },
        {
          "method": "Test$3.handleEvent",
          "source": "Test.java:86"
        },
        {
          "method": "org.eclipse.swt.widgets.EventTable.sendEvent",
          "source": "EventTable.java:66"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:938"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:962"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:947"
        },
        {
          "method": "org.eclipse.swt.widgets.Tree.checkData",
          "source": "Tree.java:1596"
        },
        {
          "method": "org.eclipse.swt.widgets.Tree.checkData",
          "source": "Tree.java:1584"
        },
        {
          "method": "org.eclipse.swt.widgets.Tree.wmNotifyChild",
          "source": "Tree.java:6714"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.wmNotify",
          "source": "Control.java:4555"
        },
        {
          "method": "org.eclipse.swt.widgets.Composite.wmNotify",
          "source": "Composite.java:1581"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.WM_NOTIFY",
          "source": "Control.java:4208"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.windowProc",
          "source": "Control.java:3716"
        },
        {
          "method": "org.eclipse.swt.widgets.Decorations.windowProc",
          "source": "Decorations.java:1584"
        },
        {
          "method": "org.eclipse.swt.widgets.Shell.windowProc",
          "source": "Shell.java:1753"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.windowProc",
          "source": "Display.java:4342"
        },
        {
          "method": "org.eclipse.swt.internal.win32.OS.CallWindowProcW",
          "source": "Native Method"
        },
        {
          "method": "org.eclipse.swt.internal.win32.OS.CallWindowProc",
          "source": "OS.java:2177"
        },
        {
          "method": "org.eclipse.swt.widgets.Tree.callWindowProc",
          "source": "Tree.java:1501"
        },
        {
          "method": "org.eclipse.swt.widgets.Tree.WM_PAINT",
          "source": "Tree.java:6169"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.windowProc",
          "source": "Control.java:3717"
        },
        {
          "method": "org.eclipse.swt.widgets.Tree.windowProc",
          "source": "Tree.java:5275"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.windowProc",
          "source": "Display.java:4355"
        },
        {
          "method": "org.eclipse.swt.internal.win32.OS.DispatchMessageW",
          "source": "Native Method"
        },
        {
          "method": "org.eclipse.swt.internal.win32.OS.DispatchMessage",
          "source": "OS.java:2263"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.readAndDispatch",
          "source": "Display.java:3282"
        },
        {
          "method": "Test.main",
          "source": "Test.java:31"
        }
      ],
      "number": 0,
      "commentIndex": 3,
      "bugId": "188663",
      "date": "2007-05-23T20:33:18+02:00",
      "product": "Platform",
      "component": "UI",
      "severity": "major"
    }
  ],
  "groupId": "188663",
  "bugId": "188663",
  "date": "2007-05-23T17:16:54+02:00",
  "product": "Platform",
  "component": "UI",
  "severity": "major"
}