{
  "comments": [
    "We saw the following NPE during a run of bea internal tests.\n\n\n\n     [java] !ENTRY org.eclipse.jst.jsp.core 4 4 2005-11-09 12:48:45.469\n     [java] !MESSAGE JSPIndexer problem\nindexing:/customerCareWebProject/web/customerManagementPageFlow/customers.jsp\n     [java] !STACK 0\n     [java] java.lang.NullPointerException\n     [java] \tat\njava.util.Hashtable.get(Ljava.lang.Object;)Ljava.lang.Object;(Unknown Source)\n     [java] \tat\norg.eclipse.wst.sse.core.internal.FileBufferModelManager.releaseModel(FileBufferModelManager.java:597)\n     [java] \tat\norg.eclipse.wst.sse.core.internal.model.ModelManagerImpl.discardModel(ModelManagerImpl.java:1370)\n     [java] \tat\norg.eclipse.wst.sse.core.internal.model.ModelManagerImpl.releaseFromRead(ModelManagerImpl.java:1397)\n     [java] \tat\norg.eclipse.wst.sse.core.internal.model.AbstractStructuredModel.releaseFromRead(AbstractStructuredModel.java:1067)\n     [java] \tat\norg.eclipse.wst.xml.core.internal.document.DOMModelImpl.releaseFromRead(DOMModelImpl.java:806)\n     [java] \tat\norg.eclipse.wst.html.core.internal.document.DOMStyleModelImpl.releaseFromRead(DOMStyleModelImpl.java:44)\n     [java] \tat\norg.eclipse.jst.jsp.core.internal.java.search.JSPSearchDocument.getJSPTranslation(JSPSearchDocument.java:128)\n     [java] \tat\norg.eclipse.jst.jsp.core.internal.java.search.JSPSearchDocument.getPath(JSPSearchDocument.java:149)\n     [java] \tat\norg.eclipse.jst.jsp.core.internal.java.search.JavaSearchDocumentDelegate.\u003cinit\u003e(JavaSearchDocumentDelegate.java:30)\n     [java] \tat\norg.eclipse.jst.jsp.core.internal.java.search.JSPSearchSupport.createSearchDocument(JSPSearchSupport.java:426)\n     [java] \tat\norg.eclipse.jst.jsp.core.internal.java.search.JSPSearchSupport.addJspFile(JSPSearchSupport.java:320)\n     [java] \tat\norg.eclipse.jst.jsp.core.internal.java.search.JSPIndexManager$ProcessFilesJob.run(JSPIndexManager.java:251)\n     [java] \tat org.eclipse.core.internal.jobs.Worker.run(Worker.java:76)",
    "Were there other files or Jobs running?  Does it happen consistently?  Is this\nreproducable with the latest integration build?",
    "1. Were there other files or Jobs running?  \nSorry, we don\u0027t know\n\n2. Does it happen consistently?  \nNo.\n\n3. Is this reproducable with the latest integration build?\nAgain sorry, we don\u0027t know yet\n\n\n\nAfter the initial NPE, there were all sorts of other problems, probably all\nrelated to the first NPE. However for completeness I will list them all here:\n\nfirst the npe:\n     [java] !ENTRY org.eclipse.jst.jsp.core 4 4 2005-11-09 12:48:45.469\n     [java] !MESSAGE JSPIndexer problem\nindexing:/customerCareWebProject/web/customerManagementPageFlow/customers.jsp\n     [java] !STACK 0\n     [java] java.lang.NullPointerException\n     [java]     at\njava.util.Hashtable.get(Ljava.lang.Object;)Ljava.lang.Object;(Unknown Source)\n     [java]     at\norg.eclipse.wst.sse.core.internal.FileBufferModelManager.releaseModel(FileBufferModelManager.java:597)\n     [java]     at\norg.eclipse.wst.sse.core.internal.model.ModelManagerImpl.discardModel(ModelManagerImpl.java:1370)\n     [java]     at\norg.eclipse.wst.sse.core.internal.model.ModelManagerImpl.releaseFromRead(ModelManagerImpl.java:1397)\n     [java]     at\norg.eclipse.wst.sse.core.internal.model.AbstractStructuredModel.releaseFromRead(AbstractStructuredModel.java:1067)\n     [java]     at\norg.eclipse.wst.xml.core.internal.document.DOMModelImpl.releaseFromRead(DOMModelImpl.java:806)\n     [java]     at\norg.eclipse.wst.html.core.internal.document.DOMStyleModelImpl.releaseFromRead(DOMStyleModelImpl.java:44)\n     [java]     at\norg.eclipse.jst.jsp.core.internal.java.search.JSPSearchDocument.getJSPTranslation(JSPSearchDocument.java:128)\n     [java]     at\norg.eclipse.jst.jsp.core.internal.java.search.JSPSearchDocument.getPath(JSPSearchDocument.java:149)\n     [java]     at\norg.eclipse.jst.jsp.core.internal.java.search.JavaSearchDocumentDelegate.\u003cinit\u003e(JavaSearchDocumentDelegate.java:30)\n     [java]     at\norg.eclipse.jst.jsp.core.internal.java.search.JSPSearchSupport.createSearchDocument(JSPSearchSupport.java:426)\n     [java]     at\norg.eclipse.jst.jsp.core.internal.java.search.JSPSearchSupport.addJspFile(JSPSearchSupport.java:320)\n     [java]     at\norg.eclipse.jst.jsp.core.internal.java.search.JSPIndexManager$ProcessFilesJob.run(JSPIndexManager.java:251)\n     [java]     at org.eclipse.core.internal.jobs.Worker.run(Worker.java:76)\n\nThen the same NPE but coming from a different caller:\n\n     [java] !ENTRY org.eclipse.core.runtime 4 2 2005-11-09 12:48:45.531\n     [java] !MESSAGE An internal error occurred during: \"Model structure\nbuilder: PageModel:\n/customerCareWebProject/web/customerManagementPageFlow/customers.jsp\".\n     [java] !STACK 0\n     [java] java.lang.NullPointerException\n     [java]     at\njava.util.Hashtable.get(Ljava.lang.Object;)Ljava.lang.Object;(Unknown Source)\n     [java]     at\norg.eclipse.wst.sse.core.internal.FileBufferModelManager.releaseModel(FileBufferModelManager.java:597)\n     [java]     at\norg.eclipse.wst.sse.core.internal.model.ModelManagerImpl.discardModel(ModelManagerImpl.java:1370)\n     [java]     at\norg.eclipse.wst.sse.core.internal.model.ModelManagerImpl.releaseFromRead(ModelManagerImpl.java:1397)\n     [java]     at\norg.eclipse.wst.sse.core.internal.model.AbstractStructuredModel.releaseFromRead(AbstractStructuredModel.java:1067)\n     [java]     at\norg.eclipse.wst.xml.core.internal.document.DOMModelImpl.releaseFromRead(DOMModelImpl.java:806)\n     [java]     at\norg.eclipse.wst.html.core.internal.document.DOMStyleModelImpl.releaseFromRead(DOMStyleModelImpl.java:44)\n     [java]     at\ncom.bea.wlw.netui.core.page.structure.PageStructureBuilder.build(PageStructureBuilder.java:152)\n     [java]     at\ncom.bea.wlw.common.core.model.AbstractExternalEventAdapter$StructureBuilderJob.run(AbstractExternalEventAdapter.java:285)\n     [java]     at org.eclipse.core.internal.jobs.Worker.run(Worker.java:76)\n\nThen the following assert:\n\n     [java] !ENTRY org.eclipse.wst.sse.ui 4 4 2005-11-09 12:48:56.641\n     [java] !MESSAGE problem with as-you-type validation\n     [java] !STACK 0\n     [java] org.eclipse.jface.text.Assert$AssertionFailedException: Assertion\nfailed: wrong model\n     [java]     at org.eclipse.jface.text.Assert.isTrue(Assert.java:189)\n     [java]     at\norg.eclipse.jst.jsp.ui.internal.reconcile.ReconcileStepForJava.reconcileModel(ReconcileStepForJava.java:81)\n     [java]     at\norg.eclipse.jface.text.reconciler.AbstractReconcileStep.reconcile(AbstractReconcileStep.java:96)\n     [java]     at\norg.eclipse.jface.text.reconciler.AbstractReconcileStep.reconcile(AbstractReconcileStep.java:99)\n     [java]     at\norg.eclipse.wst.sse.ui.internal.reconcile.AbstractStructuredTextReconcilingStrategy.reconcile(AbstractStructuredTextReconcilingStrategy.java:368)\n     [java]     at\norg.eclipse.jst.jsp.ui.internal.reconcile.StructuredTextReconcilingStrategyForJSP.reconcile(StructuredTextReconcilingStrategyForJSP.java:149)\n     [java]     at\norg.eclipse.wst.sse.ui.internal.reconcile.StructuredRegionProcessor.process(StructuredRegionProcessor.java:170)\n     [java]     at\norg.eclipse.wst.sse.ui.internal.reconcile.DirtyRegionProcessor.run(DirtyRegionProcessor.java:412)\n     [java]     at org.eclipse.core.internal.jobs.Worker.run(Worker.java:76)\n\nThen the following NPE:\n\n     [java] !ENTRY org.eclipse.core.filebuffers 4 2 2005-11-09 12:49:57.547\n     [java] !MESSAGE Problems occurred when invoking code from plug-in:\n\"org.eclipse.core.filebuffers\".\n     [java] !STACK 0\n     [java] java.lang.NullPointerException\n     [java]     at\norg.eclipse.wst.sse.core.internal.model.AbstractStructuredModel.setDirtyState(AbstractStructuredModel.java:1337)\n     [java]     at\norg.eclipse.wst.sse.core.internal.FileBufferModelManager$FileBufferMapper.dirtyStateChanged(FileBufferModelManager.java:282)\n     [java]     at\norg.eclipse.core.internal.filebuffers.TextFileBufferManager$3.run(TextFileBufferManager.java:374)\n     [java]     at\norg.eclipse.core.internal.runtime.InternalPlatform.run(InternalPlatform.java:1044)\n     [java]     at org.eclipse.core.runtime.Platform.run(Platform.java:783)\n     [java]     at\norg.eclipse.core.internal.filebuffers.TextFileBufferManager.fireDirtyStateChanged(TextFileBufferManager.java:372)\n     [java]     at\norg.eclipse.core.internal.filebuffers.ResourceFileBuffer.commit(ResourceFileBuffer.java:327)\n     [java]     at\ncom.bea.wlw.template.textinserter.TextInserter.insertText(TextInserter.java:75)\n     [java]     at\ncom.bea.wlw.jsp.core.commands.GenericTagCommand.performInsert(GenericTagCommand.java:189)\n     [java]     at\ncom.bea.wlw.jsp.core.commands.GenericTagCommand.execute(GenericTagCommand.java:118)\n     [java]     at\ncom.bea.wlw.netui.ui.jsp.commands.BaseDialogCommand.execute(BaseDialogCommand.java:53)\n     [java]     at\norg.eclipse.ui.internal.handlers.HandlerProxy.execute(HandlerProxy.java:151)\n     [java]     at org.eclipse.core.commands.Command.execute(Command.java:311)\n     [java]     at\ncom.bea.wlw.netui.ui.jsp.commands.DataPaletteTagCommand.execute(DataPaletteTagCommand.java:120)\n     [java]     at\norg.eclipse.ui.internal.handlers.HandlerProxy.execute(HandlerProxy.java:151)\n     [java]     at org.eclipse.core.commands.Command.execute(Command.java:311)\n     [java]     at\ncom.bea.wlw.common.ui.palette.dnd.DelegatingCommandDropAction.execute(DelegatingCommandDropAction.java:97)\n     [java]     at\ncom.bea.wlw.common.ui.palette.design.DelegatingCommandDropActionAdapter.execute(DelegatingCommandDropActionAdapter.java:50)\n     [java]     at\ncom.bea.wlw.common.ui.palette.design.DesignPalette$InsertMouseListener.mouseDoubleClick(DesignPalette.java:586)\n     [java]     at\norg.eclipse.swt.widgets.TypedListener.handleEvent(TypedListener.java:141)\n     [java]     at org.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:66)\n     [java]     at org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:843)\n     [java]     at\norg.eclipse.swt.widgets.Display.runDeferredEvents(Display.java:3080)\n     [java]     at\norg.eclipse.swt.widgets.Display.readAndDispatch(Display.java:2713)\n     [java]     at abbot.swt.Robot.delay(Robot.java:232)\n     [java]     at abbot.tester.swt.Robot.delay(Robot.java:387)\n     [java]     at abbot.tester.swt.Robot.wait(Robot.java:1447)\n     [java]     at\ncom.bea.test.common.testers.AbstractDialogTester.runDialog(AbstractDialogTester.java:402)\n     [java]     at\ncom.bea.test.wlw.netui.ui.jsp.testers.PageInputsDataGridDialogTester.invokeDialog(PageInputsDataGridDialogTester.java:57)\n     [java]     at\ncom.bea.test.common.testers.AbstractDialogTester.runDialog(AbstractDialogTester.java:392)\n     [java]     at\ncom.bea.test.wlw.scenario.tests.BasicDataScenarioDRT.addCustomerGrid(BasicDataScenarioDRT.java:678)\n     [java]     at\ncom.bea.test.wlw.scenario.tests.BasicDataScenarioDRT.testBasicDataScenario(BasicDataScenarioDRT.java:212)\n\nThen this one:\n\n     [java] !ENTRY org.eclipse.jst.jsp.core 4 4 2005-11-09 12:49:57.562\n     [java] !MESSAGE JSPIndexer problem\nindexing:/customerCareWebProject/web/customerManagementPageFlow/customers.jsp\n     [java] !STACK 0\n     [java] java.lang.NullPointerException\n     [java]     at\norg.eclipse.jst.jsp.core.internal.java.JSPTranslator.reset(JSPTranslator.java:324)\n     [java]     at\norg.eclipse.jst.jsp.core.internal.java.JSPTranslationAdapter.getTranslator(JSPTranslationAdapter.java:171)\n     [java]     at\norg.eclipse.jst.jsp.core.internal.java.JSPTranslationAdapter.getJSPTranslation(JSPTranslationAdapter.java:130)\n     [java]     at\norg.eclipse.jst.jsp.core.internal.java.search.JSPSearchDocument.getJSPTranslation(JSPSearchDocument.java:112)\n     [java]     at\norg.eclipse.jst.jsp.core.internal.java.search.JSPSearchDocument.getPath(JSPSearchDocument.java:149)\n     [java]     at\norg.eclipse.jst.jsp.core.internal.java.search.JavaSearchDocumentDelegate.\u003cinit\u003e(JavaSearchDocumentDelegate.java:30)\n     [java]     at\norg.eclipse.jst.jsp.core.internal.java.search.JSPSearchSupport.createSearchDocument(JSPSearchSupport.java:426)\n     [java]     at\norg.eclipse.jst.jsp.core.internal.java.search.JSPSearchSupport.addJspFile(JSPSearchSupport.java:320)\n     [java]     at\norg.eclipse.jst.jsp.core.internal.java.search.JSPIndexManager$ProcessFilesJob.run(JSPIndexManager.java:251)\n     [java]     at org.eclipse.core.internal.jobs.Worker.run(Worker.java:76)",
    "There\u0027s many possiblities of error here. \n\nOther than the flaky stuff I know about, an intersting part of this use case \nis this part of the stack trace: \n\norg.eclipse.core.internal.filebuffers.ResourceFileBuffer.commit(ResourceFileBuffer.java:327)\n     [java]     at\ncom.bea.wlw.template.textinserter.TextInserter.insertText(TextInserter.java:75)\n     [java]     at\ncom.bea.wlw.jsp.core.commands.GenericTagCommand.performInsert(GenericTagCommand.java:189)\n     [java]     at\ncom.bea.wlw.jsp.core.commands.GenericTagCommand.execute(GenericTagCommand.java:118)\n     [java]     at\ncom.bea.wlw.netui.ui.jsp.commands.BaseDialogCommand.execute(BaseDialogCommand.java:53)\n\nIts not that this part causes the problem per se, but hints that some previous\nuse of ResouceBuffer, Document, and/or Model (actually, their interactions) that\nmay have left things in a bad state. \n\nIronically, this appears to be using as we intend ... but ... we do not do so\nmuch, in this way, at this point, and there\u0027s likely thread coordination issues\nwe have planned, but have not put in place. \n\nSo, here\u0027s some off hand questions on the general case ... \nDo the resource being used exist ahead of time, or is it sometimes completely\nnew? (You\u0027ll be more likely to see problems for completely new resources,\nespecially if the are saved, and then processed some more. (There\u0027s some issues\nwhere the \"ID\" we use internally is miscomputed, some would say, for completely\nnew resources, and some parts of the \"system\" thinks there\u0027s two documents, when\nthere\u0027s really just one. \n\nDo you directly use our model or Document *and* the resouce buffer ... or just\nthe buffer? (and model and document just used indirectly? ) \n\n\n",
    "What our code is doing here is inserting a tag based on a drag/drop gesture from\na design palette. The tag itself is generated from a template, and inserted as\ntext into the file buffer, at the current caret offset in the editor. The\nTextInserter code gets an ITextFileBuffer from the buffer manager, connects to\nit, gets the buffer\u0027s IDocument, then creates and applies an InsertEdit. After\napplying the edit, if the buffer was not previously dirty, it calls commit on\nthe buffer.\n\nRight before doing the text insert, we do access the structured model to look\nfor taglib imports of the tag we are generating, so that we can use the right\nprefix. We do this by calling\nStructuredModelManager.getModelManager().getModelForRead( jspFile ) where\njspFile is the IFile, to get the IStructureModel, then get a DOM by calling\nstructuredModel.getAdapter( Document.class ), and iterating through the import\ntags until we find one with the right uri. We call releaseFromRead on the\nstructured model in a finally block.\n\nOne thing I just noticed while looking back through the code is that we get the\nElement for the taglib import, release the model from read, and then get the\nprefix attribute from that element. It happens after the model\u0027s been released,\nbut before the text insertion. I\u0027m not sure if that could be a problem...?\n\nAfter we do the text insert, if we couldn\u0027t find an import for the tag, we get\nthe structured model again by calling getModelForEdit(), and then create and\ninsert the taglib nodes (but that hasn\u0027t happened by the time this NPE hit). It\nis done in this order because we found that if we added the nodes to the DOM\nbefore doing the text insert, sometimes one or the other would get \"lost\", as if\nthe text insert and the DOM node insert were applied to different internal\ninstances, and one would \"win\" over the other when the actual text buffer was\nupdated.\n\nI hope that wasn\u0027t too much detail :-)",
    "Definitly not too much detail! In fact, with that much detail, sounds like\nyou\u0027re close to providing a standalone JUnit test :) \n\nThere are a large number of issues going on here, and while I don\u0027t\nknow/understand them all ... I\u0027ll post notes as I gain understanding, and\nperhaps that will at least keep progress moving forward. \n\n\u003eWhat our code is doing here is inserting a tag based on a drag/drop gesture from\n\u003ea design palette. The tag itself is generated from a template, and inserted as\n\u003etext into the file buffer, at the current caret offset in the editor. The\n\u003eTextInserter code gets an ITextFileBuffer from the buffer manager, connects to\n\u003eit, gets the buffer\u0027s IDocument, then creates and applies an InsertEdit. After\n\u003eapplying the edit, if the buffer was not previously dirty, it calls commit on\n\u003ethe buffer.\n\nThe thing that stands out here is the end: \"calls commit on the buffer\". \nIf you call commit directly on the buffer, do you first get (compute) the\ncommitSchedulingRule? Even if you \"might\" commit, \nyou should get that scheduling rule first and, I think, before any part of the\noperations in this paragraph! Granted, this may cause some cases, such as if\nautobuild is in progress, there the drag/drop from pallette will cause a dialog\nto pop up that says \"user operation is blocked by backgroud job\" ... but ..\nthat\u0027s the idea to gaurd data. And, improvements in this \"user experience\" will\ntake some deeper work. \n[I\u0027m not sure this is the cause of this particular bug ... I\u0027m just trying to \noutline \"correct client behavior\" ... just in case]. \n\n\n\u003eOne thing I just noticed while looking back through the code is that we get the\n\u003eElement for the taglib import, release the model from read, and then get the\n\u003eprefix attribute from that element. It happens after the model\u0027s been released,\n\u003ebut before the text insertion. I\u0027m not sure if that could be a problem...?\n\nIn general, yes, this is incorrrect client behavior ... once released, nothing\nshould be done with any part of the model. [Again, not sure if this is cause of\nthis bug, but could be related]. \n\n\n\n\nI\u0027m (still) guessing part of this bug is due to the \"new file vs. existing file\"\nbugs that are resulting due to some behavior in text buffer manager we did not\nwell anticipate ... and related to bugs 107311, 107316, and 107320 .... so I\u0027ll\ntake a look at those this weekend. \n\nI expect, however, in the complex case you\u0027ve detailed, it will take a fair\namount of work to track down and fix all the scheduling and thread issues. \n",
    "Interesting! I don\u0027t think we are getting the commit scheduling rule, I\u0027ll look\ninto that; and to keeping the DOM element after releasing the model.\n\nI forgot one of your original questions - in this case, the file was already\nexisting. This didn\u0027t happen while creating a new file.\n\nAlso, as far as I know, this particular NPE was only reported once; and these\ntests are run continuously every day. So it\u0027s definitely much less common than\nsome of the other threading issues we\u0027ve run into. (mostly involving usage of EMF)",
    "*** Bug 102223 has been marked as a duplicate of this bug. ***",
    "Decreasing priority.  If anyone is able to consistently reproduce this and/or has a JUnit test for it, we\u0027ll bump it back up."
  ],
  "commentCreationDates": [
    "2005-11-09T22:37:48+01:00",
    "2005-11-10T05:57:29+01:00",
    "2005-11-10T18:59:17+01:00",
    "2005-11-12T06:57:06+01:00",
    "2005-11-19T16:27:19+01:00",
    "2005-11-19T23:41:08+01:00",
    "2005-11-19T23:50:30+01:00",
    "2006-04-20T22:48:30+02:00",
    "2006-06-01T19:03:46+02:00"
  ],
  "traces": [
    {
      "exceptionType": "org.eclipse.jface.text.Assert$AssertionFailedException",
      "message": "Assertion failed: wrong model      [java]",
      "elements": [
        {
          "method": "org.eclipse.jface.text.Assert.isTrue",
          "source": "Assert.java:189"
        }
      ],
      "number": 0,
      "commentIndex": 2,
      "bugId": "115714",
      "date": "2005-11-10T18:59:17+01:00",
      "product": "Web Tools",
      "component": "wst.sse",
      "severity": "major"
    }
  ],
  "groupId": "115714",
  "bugId": "115714",
  "date": "2005-11-09T22:37:48+01:00",
  "product": "Web Tools",
  "component": "wst.sse",
  "severity": "major"
}