{
  "comments": [
    "I am a WAS devleoper and we use Eclipse in a headless environment.  When we have multiple JVMs that are sharing a single OSGi configuration, we have seen the bundle  cahce get corrupted.  The corruption happens when we are starting a JVM with the Eclipse -clean option, while we are simultaneously stopping a JVM.  It appears that the stopping of the JVM will cause a writing of in-memory cache to disk, while the starting with -clean will be simultaneously erasing the bundle cache in disk.  This leads to out of sync bundle cache and problems completing the stopping of the JVM.\n\nWhen this happens we have seen this error on the Stop JVM:\njava.io.FileNotFoundException: /opt/IBM/WebSphere/AppServer/profiles/AppSrv02/configuration/org.eclipse.osgi/.lazy.1 (No such file or directory)\n        at java.io.FileInputStream.open(Native Method)\n        at java.io.FileInputStream.\u003cinit\u003e(FileInputStream.java:135)\n        at org.eclipse.osgi.framework.util.SecureAction.getFileInputStream(SecureAction.java:98)\n        at org.eclipse.osgi.internal.resolver.StateReader.readState(StateReader.java:111)\n        at org.eclipse.osgi.internal.resolver.StateReader.loadState(StateReader.java:434)\n        at org.eclipse.osgi.internal.resolver.StateObjectFactoryImpl.readSystemState(StateObjectFactoryImpl.java:178)\n        at org.eclipse.osgi.framework.adaptor.core.StateManager.readSystemState(StateManager.java:116)\n        at org.eclipse.osgi.framework.adaptor.core.StateManager.readSystemState(StateManager.java:180)\n        at org.eclipse.core.runtime.adaptor.EclipseAdaptor.createStateManager(EclipseAdaptor.java:242)\n        at org.eclipse.osgi.framework.adaptor.core.AbstractFrameworkAdaptor.frameworkStart(AbstractFrameworkAdaptor.java:330)\n        at org.eclipse.core.runtime.adaptor.EclipseAdaptor.frameworkStart(EclipseAdaptor.java:332)\n        at org.eclipse.osgi.framework.internal.core.SystemBundleActivator.start(SystemBundleActivator.java:55)\n        at org.eclipse.osgi.framework.internal.core.BundleContextImpl$2.run(BundleContextImpl.java:994)\n        at java.security.AccessController.doPrivileged(AccessController.java:241)\n        at org.eclipse.osgi.framework.internal.core.BundleContextImpl.startActivator(BundleContextImpl.java:988)\n        at org.eclipse.osgi.framework.internal.core.BundleContextImpl.start(BundleContextImpl.java:969)\n        at org.eclipse.osgi.framework.internal.core.StartLevelManager.resumeBundles(StartLevelManager.java:550)\n        at org.eclipse.osgi.framework.internal.core.StartLevelManager.incFWSL(StartLevelManager.java:485)\n        at org.eclipse.osgi.framework.internal.core.StartLevelManager.doSetStartLevel(StartLevelManager.java:275)\n        at org.eclipse.osgi.framework.internal.core.StartLevelManager.launch(StartLevelManager.java:245)\n        at org.eclipse.osgi.framework.internal.core.SystemBundle.resume(SystemBundle.java:155)\n        at org.eclipse.osgi.framework.internal.core.Framework.launch(Framework.java:503)\n        at org.eclipse.osgi.framework.internal.core.OSGi.launch(OSGi.java:51)\n        at org.eclipse.core.runtime.adaptor.EclipseStarter.startup(EclipseStarter.java:275)\n        at org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:159)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:64)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:615)\n        at org.eclipse.core.launcher.Main.invokeFramework(Main.java:334)\n        at org.eclipse.core.launcher.Main.basicRun(Main.java:278)\n        at org.eclipse.core.launcher.Main.run(Main.java:973)\n        at com.ibm.wsspi.bootstrap.WSPreLauncher.launchEclipse(WSPreLauncher.java:329)\n        at com.ibm.wsspi.bootstrap.WSPreLauncher.main(WSPreLauncher.java:91)\n\n\nand in the logs we also see many errors.  SOme look like this:\n!SESSION 2006-11-09 16:50:52.747 -----------------------------------------------\neclipse.buildId\u003dM20060118-1600\njava.fullversion\u003dJ2RE 1.5.0 IBM J9 2.3 Linux x86-32 j9vmxi3223-20060504 (JIT enabled)\nJ9VM - 20060501_06428_lHdSMR\nJIT  - 20060428_1800_r8\nGC   - 20060501_AA\nBootLoader constants: OS\u003dlinux, ARCH\u003dx86, WS\u003dmotif, NL\u003den_US\nFramework arguments:  -application com.ibm.ws.bootstrap.WSLauncher\nCommand-line arguments:  -clean -application com.ibm.ws.bootstrap.WSLauncher\n\n!ENTRY System Bundle 0 0 2006-11-09 16:52:40.669\n!MESSAGE FrameworkEvent.ERROR\n!STACK 0\njava.io.IOException: File update failed on one or more files.\nat org.eclipse.core.runtime.adaptor.FileManager.update(FileManager.java:263)\nat org.eclipse.core.runtime.adaptor.EclipseAdaptor.shutdownStateManager(EclipseAdaptor.java:280)\nat org.eclipse.osgi.framework.adaptor.core.AbstractFrameworkAdaptor.frameworkStop(AbstractFrameworkAdaptor.java:343)\nat org.eclipse.core.runtime.adaptor.EclipseAdaptor.frameworkStop(EclipseAdaptor.java:439)\nat org.eclipse.osgi.framework.internal.core.SystemBundleActivator.stop(SystemBundleActivator.java:64)\nat org.eclipse.osgi.framework.internal.core.BundleContextImpl$3.run(BundleContextImpl.java:1035)\nat java.security.AccessController.doPrivileged(AccessController.java:241)\nat org.eclipse.osgi.framework.internal.core.BundleContextImpl.stop(BundleContextImpl.java:1031)\nat org.eclipse.osgi.framework.internal.core.StartLevelManager.suspendAllBundles(StartLevelManager.java:651)\nat org.eclipse.osgi.framework.internal.core.StartLevelManager.decFWSL(StartLevelManager.java:600)\nat org.eclipse.osgi.framework.internal.core.StartLevelManager.doSetStartLevel(StartLevelManager.java:283)\nat org.eclipse.osgi.framework.internal.core.StartLevelManager.shutdown(StartLevelManager.java:256)\nat org.eclipse.osgi.framework.internal.core.SystemBundle.suspend(SystemBundle.java:190)\nat org.eclipse.osgi.framework.internal.core.Framework.shutdown(Framework.java:536)\nat org.eclipse.osgi.framework.internal.core.SystemBundle$1.run(SystemBundle.java:171)\nat java.lang.Thread.run(Thread.java:797)",
    "Moving to Equinox/Framework.\n\nFrom my limited knowledge of this area:\n\nThe configuration area, as designed, can be shared only on \"static\" instances of Eclipse where none of the Eclipse instances using the shared config area modifies it while other instances are running.\n\n(It might be possible to add a lock preventing modifications to config area while other instances using it, but it probably going to create even more headache. For instance, if an instance crashed without a change to clean the lock.)\n",
    "Interesting bug.  This should in theory not happen because the configuration area has a file table structure that should result in \"atomic\" writes (loosely speaking).  Perhaps the -clean code is cavalier about toasting files...",
    "Yes that is what I think is happening here.\n\n- Instance X is in the process of shutting down.  It locks the StorageManager and starts to write its cache.\n\n- After instance X has save some of its files, instance Y start with -clean.  When launching with -clean we do not try to lock the StorageManager because we are about to delete the configuration which includes the files we use to lock the StorageManager.  This means we delete the files instance X just saved\n\n- Instance X finishes saving its cache.\n\n- Instance Y continues starting and finds half a cache available from instance X.  This is where the failure occurs."
  ],
  "commentCreationDates": [
    "2006-11-10T20:07:44+01:00",
    "2006-11-10T20:37:45+01:00",
    "2006-11-11T02:02:48+01:00",
    "2006-11-11T12:53:51+01:00"
  ],
  "traces": [
    {
      "exceptionType": "java.io.FileNotFoundException",
      "message": "/opt/IBM/WebSphere/AppServer/profiles/AppSrv02/configuration/org.eclipse.osgi/.lazy.1 (No such file or directory)",
      "elements": [
        {
          "method": "java.io.FileInputStream.open",
          "source": "Native Method"
        },
        {
          "method": "java.io.FileInputStream.\u003cinit\u003e",
          "source": "FileInputStream.java:135"
        },
        {
          "method": "org.eclipse.osgi.framework.util.SecureAction.getFileInputStream",
          "source": "SecureAction.java:98"
        },
        {
          "method": "org.eclipse.osgi.internal.resolver.StateReader.readState",
          "source": "StateReader.java:111"
        },
        {
          "method": "org.eclipse.osgi.internal.resolver.StateReader.loadState",
          "source": "StateReader.java:434"
        },
        {
          "method": "org.eclipse.osgi.internal.resolver.StateObjectFactoryImpl.readSystemState",
          "source": "StateObjectFactoryImpl.java:178"
        },
        {
          "method": "org.eclipse.osgi.framework.adaptor.core.StateManager.readSystemState",
          "source": "StateManager.java:116"
        },
        {
          "method": "org.eclipse.osgi.framework.adaptor.core.StateManager.readSystemState",
          "source": "StateManager.java:180"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseAdaptor.createStateManager",
          "source": "EclipseAdaptor.java:242"
        },
        {
          "method": "org.eclipse.osgi.framework.adaptor.core.AbstractFrameworkAdaptor.frameworkStart",
          "source": "AbstractFrameworkAdaptor.java:330"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseAdaptor.frameworkStart",
          "source": "EclipseAdaptor.java:332"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.SystemBundleActivator.start",
          "source": "SystemBundleActivator.java:55"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleContextImpl$2.run",
          "source": "BundleContextImpl.java:994"
        },
        {
          "method": "java.security.AccessController.doPrivileged",
          "source": "AccessController.java:241"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleContextImpl.startActivator",
          "source": "BundleContextImpl.java:988"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleContextImpl.start",
          "source": "BundleContextImpl.java:969"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.StartLevelManager.resumeBundles",
          "source": "StartLevelManager.java:550"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.StartLevelManager.incFWSL",
          "source": "StartLevelManager.java:485"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.StartLevelManager.doSetStartLevel",
          "source": "StartLevelManager.java:275"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.StartLevelManager.launch",
          "source": "StartLevelManager.java:245"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.SystemBundle.resume",
          "source": "SystemBundle.java:155"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.Framework.launch",
          "source": "Framework.java:503"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.OSGi.launch",
          "source": "OSGi.java:51"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.startup",
          "source": "EclipseStarter.java:275"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:159"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "NativeMethodAccessorImpl.java:64"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "DelegatingMethodAccessorImpl.java:43"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Method.java:615"
        },
        {
          "method": "org.eclipse.core.launcher.Main.invokeFramework",
          "source": "Main.java:334"
        },
        {
          "method": "org.eclipse.core.launcher.Main.basicRun",
          "source": "Main.java:278"
        },
        {
          "method": "org.eclipse.core.launcher.Main.run",
          "source": "Main.java:973"
        },
        {
          "method": "com.ibm.wsspi.bootstrap.WSPreLauncher.launchEclipse",
          "source": "WSPreLauncher.java:329"
        },
        {
          "method": "com.ibm.wsspi.bootstrap.WSPreLauncher.main",
          "source": "WSPreLauncher.java:91"
        }
      ],
      "number": 0,
      "commentIndex": 0,
      "bugId": "164167",
      "date": "2006-11-10T20:07:44+01:00",
      "product": "Equinox",
      "component": "Framework",
      "severity": "major"
    },
    {
      "exceptionType": "java.io.IOException",
      "message": "File update failed on one or more files.",
      "elements": [
        {
          "method": "org.eclipse.core.runtime.adaptor.FileManager.update",
          "source": "FileManager.java:263"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseAdaptor.shutdownStateManager",
          "source": "EclipseAdaptor.java:280"
        },
        {
          "method": "org.eclipse.osgi.framework.adaptor.core.AbstractFrameworkAdaptor.frameworkStop",
          "source": "AbstractFrameworkAdaptor.java:343"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseAdaptor.frameworkStop",
          "source": "EclipseAdaptor.java:439"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.SystemBundleActivator.stop",
          "source": "SystemBundleActivator.java:64"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleContextImpl$3.run",
          "source": "BundleContextImpl.java:1035"
        },
        {
          "method": "java.security.AccessController.doPrivileged",
          "source": "AccessController.java:241"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.BundleContextImpl.stop",
          "source": "BundleContextImpl.java:1031"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.StartLevelManager.suspendAllBundles",
          "source": "StartLevelManager.java:651"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.StartLevelManager.decFWSL",
          "source": "StartLevelManager.java:600"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.StartLevelManager.doSetStartLevel",
          "source": "StartLevelManager.java:283"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.StartLevelManager.shutdown",
          "source": "StartLevelManager.java:256"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.SystemBundle.suspend",
          "source": "SystemBundle.java:190"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.Framework.shutdown",
          "source": "Framework.java:536"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.SystemBundle$1.run",
          "source": "SystemBundle.java:171"
        },
        {
          "method": "java.lang.Thread.run",
          "source": "Thread.java:797"
        }
      ],
      "number": 1,
      "commentIndex": 0,
      "bugId": "164167",
      "date": "2006-11-10T20:07:44+01:00",
      "product": "Equinox",
      "component": "Framework",
      "severity": "major"
    }
  ],
  "groupId": "164167",
  "bugId": "164167",
  "date": "2006-11-10T20:07:44+01:00",
  "product": "Equinox",
  "component": "Framework",
  "severity": "major"
}