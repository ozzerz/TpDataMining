{
  "comments": [
    "With XMLResource.OPTION_CONFIGURATION_CACHE enabled, invoking XMLResource.save(Document, Map, DOMHandler) then Resource.save(OutputStream, Map) will receive NPE. The reason is the first save() called ConfigurationCache.releasePrinter() without getPrinter() so the printers cache got messed up.\n\nHere is the stack trace -\n\njava.lang.NullPointerException\n\tat org.eclipse.emf.ecore.xmi.impl.XMLSaveImpl.init(XMLSaveImpl.java:400)\n\tat org.eclipse.emf.ecore.xmi.impl.XMLSaveImpl.save(XMLSaveImpl.java:231)\n\tat org.eclipse.emf.ecore.xmi.impl.XMLResourceImpl.doSave(XMLResourceImpl.java:203)\n\tat org.eclipse.emf.ecore.resource.impl.ResourceImpl.save(ResourceImpl.java:993)\n\tat org.apache.tuscany.sdo.test.XMLHelperTestCase.testEMF(XMLHelperTestCase.java:254)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:64)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:615)\n\tat junit.framework.TestCase.runTest(TestCase.java:154)\n\tat junit.framework.TestCase.runBare(TestCase.java:127)\n\tat junit.framework.TestResult$1.protect(TestResult.java:106)\n\tat junit.framework.TestResult.runProtected(TestResult.java:124)\n\tat junit.framework.TestResult.run(TestResult.java:109)\n\tat junit.framework.TestCase.run(TestCase.java:118)\n\tat junit.framework.TestSuite.runTest(TestSuite.java:208)\n\tat junit.framework.TestSuite.run(TestSuite.java:203)\n\tat org.eclipse.jdt.internal.junit.runner.junit3.JUnit3TestReference.run(JUnit3TestReference.java:128)\n\tat org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:460)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:673)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:386)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:196)\n\nHere is the test case -\n\nFuhwei Lwo/Beaverton/IBM@IBMUS \n04/27/2007 07:39 PM\t\n\tTo\n\tEd Merks/Toronto/IBM@IBMCA\n\tcc\n\tfrankb@ca.ibm.com\n\tSubject\n\tAnother EMF Bug?\n\t\n\t\n\t\n\t\n\nHi Ed,\n\nI am currently running against EMF 2.2.3 and found an NPE when XMLResource.OPTION_CONFIGURATION_CACHE was turned on and XMLResource.save(Document, Map, DOMHandler) was called before Resource.save(OutputStream, Map) was called. After debugging into it, I found the statement in red below called ConfigurationCache.releasePrinter() without getPrinter() so the printers cache got messed up.  Let me know whether my test case is valid.  Thanks.\n\njava.lang.NullPointerException\n at org.eclipse.emf.ecore.xmi.impl.XMLSaveImpl.init(XMLSaveImpl.java:400)\n at org.eclipse.emf.ecore.xmi.impl.XMLSaveImpl.save(XMLSaveImpl.java:231)\n at org.eclipse.emf.ecore.xmi.impl.XMLResourceImpl.doSave(XMLResourceImpl.java:203)\n at org.eclipse.emf.ecore.resource.impl.ResourceImpl.save(ResourceImpl.java:993)\n at org.apache.tuscany.sdo.test.XMLHelperTestCase.testEMF(XMLHelperTestCase.java:254)\n at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:64)\n at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n at java.lang.reflect.Method.invoke(Method.java:615)\n at junit.framework.TestCase.runTest(TestCase.java:154)\n at junit.framework.TestCase.runBare(TestCase.java:127)\n at junit.framework.TestResult$1.protect(TestResult.java:106)\n at junit.framework.TestResult.runProtected(TestResult.java:124)\n at junit.framework.TestResult.run(TestResult.java:109)\n at junit.framework.TestCase.run(TestCase.java:118)\n at junit.framework.TestSuite.runTest(TestSuite.java:208)\n at junit.framework.TestSuite.run(TestSuite.java:203)\n at org.eclipse.jdt.internal.junit.runner.junit3.JUnit3TestReference.run(JUnit3TestReference.java:128)\n at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)\n at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:460)\n at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:673)\n at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:386)\n at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:196)\n\n\nprivate String quoteXML \u003d\n      \"\u003c?xml version\u003d\\\"1.0\\\" encoding\u003d\\\"ASCII\\\"?\u003e\" +\n      \"\u003csimple:stockQuote xmlns:simple\u003d\\\"http://www.example.com/simple\\\"\u003e\" +\n          \"\u003csymbol\u003efbnt\u003c/symbol\u003e\" +\n          \"\u003ccompanyName\u003eFlyByNightTechnology\u003c/companyName\u003e\" +\n          \"\u003cprice\u003e1000.0\u003c/price\u003e\" +\n          \"\u003copen1\u003e1000.0\u003c/open1\u003e\" +\n          \"\u003chigh\u003e1000.0\u003c/high\u003e\" +\n          \"\u003clow\u003e1000.0\u003c/low\u003e\" +\n          \"\u003cvolume\u003e1000.0\u003c/volume\u003e\" +\n          \"\u003cchange1\u003e1000.0\u003c/change1\u003e\" +\n          \"\u003cquotes\u003e\" +\n              \"\u003cprice\u003e2000.0\u003c/price\u003e\" +\n          \"\u003c/quotes\u003e\" +\n      \"\u003c/simple:stockQuote\u003e\";\n\npublic void testEMF() throws IOException, ParserConfigurationException, SAXException {\n      URL url \u003d getClass().getResource(\"/simple.xsd\");\n      \n      XSDEcoreBuilder xsdEcoreBuilder \u003d new XSDEcoreBuilder();\n      ResourceSet resourceSet \u003d new ResourceSetImpl();\n//    Register XML resource factory\n      resourceSet.getResourceFactoryRegistry().getExtensionToFactoryMap().put(\"xml\", \n                                            new XMLResourceFactoryImpl());\n      \n      URI uri \u003d URI.createURI(url.toString());\n      System.out.println(uri.toFileString());\n      Collection ecorePackages \u003d xsdEcoreBuilder.generate(uri);\n      Object[] pkgs \u003d ecorePackages.toArray();\n      for (int i\u003d0; i\u003cpkgs.length; i++) {\n          EPackage pkg \u003d (EPackage)pkgs[i];\n//        register package in local resource registry\n          resourceSet.getPackageRegistry().put(pkg.getNsURI(), pkg);\n      }\n      \n      ByteArrayInputStream bais \u003d new ByteArrayInputStream(quoteXML.getBytes());\n      \n      DocumentBuilderFactory dFactory \u003d DocumentBuilderFactory.newInstance();\n      dFactory.setNamespaceAware(true);\n\n      DocumentBuilder dBuilder \u003d dFactory.newDocumentBuilder();\n      Document document \u003d dBuilder.parse(bais);\n\n      HashMap options \u003d new HashMap();\n      options.put(XMLResource.OPTION_EXTENDED_META_DATA, Boolean.TRUE);\n      XMLResource res \u003d (XMLResource)resourceSet.createResource(URI.createFileURI(\"dummy.xml\"));\n      \n      res.getDefaultSaveOptions().put(XMLResource.OPTION_CONFIGURATION_CACHE, Boolean.TRUE);\n      res.getDefaultLoadOptions().put(XMLResource.OPTION_CONFIGURATION_CACHE, Boolean.TRUE);\n      \n      // Load from DOM - working\n      res.load(document, options);\n      System.out.println(res.getContents().get(0));\n      \n      // Load from InputSource\n/*      InputSource inputSource \u003d new InputSource(new ByteArrayInputStream(quoteXML.getBytes()));\n      inputSource.setSystemId(\"http://www.example.com/simple\");\n      res.load(inputSource, options);*/\n      \n      Document newdocument \u003d dBuilder.newDocument();\n      res.save(newdocument, options, null);\n      \n      res.save(System.out, options);\n  }\n\nHere is the content of simple.xsd -\n\n\u003cxsd:schema \n  targetNamespace\u003d\"http://www.example.com/simple\"\n  xmlns:xsd\u003d\"http://www.w3.org/2001/XMLSchema\" \n  xmlns:simple\u003d\"http://www.example.com/simple\"\u003e \n  \n   \u003cxsd:element name\u003d\"stockQuote\" type\u003d\"simple:Quote\"/\u003e\n\n   \u003cxsd:complexType name\u003d\"Quote\"\u003e\n       \u003cxsd:sequence\u003e\n          \u003cxsd:element name\u003d\"symbol\" type\u003d\"xsd:string\"/\u003e\n          \u003cxsd:element name\u003d\"companyName\" type\u003d\"xsd:string\"/\u003e\n          \u003cxsd:element name\u003d\"price\" type\u003d\"xsd:decimal\"/\u003e\n          \u003cxsd:element name\u003d\"open1\" type\u003d\"xsd:decimal\"/\u003e\n          \u003cxsd:element name\u003d\"high\" type\u003d\"xsd:decimal\"/\u003e\n          \u003cxsd:element name\u003d\"low\" type\u003d\"xsd:decimal\"/\u003e\n          \u003cxsd:element name\u003d\"volume\" type\u003d\"xsd:double\"/\u003e\n          \u003cxsd:element name\u003d\"change1\" type\u003d\"xsd:double\"/\u003e\n          \u003cxsd:element name\u003d\"quotes\" type\u003d\"simple:Quote\" minOccurs\u003d\"0\" maxOccurs\u003d\"unbounded\"/\u003e\n       \u003c/xsd:sequence\u003e\n   \u003c/xsd:complexType\u003e\n\n\u003c/xsd:schema\u003e",
    "The fix is committed to CVS.",
    "Fixed in M200705020400."
  ],
  "commentCreationDates": [
    "2007-04-30T18:29:47+02:00",
    "2007-05-01T15:32:42+02:00",
    "2007-05-02T18:17:57+02:00"
  ],
  "traces": [
    {
      "exceptionType": "java.lang.NullPointerException",
      "elements": [
        {
          "method": "org.eclipse.emf.ecore.xmi.impl.XMLSaveImpl.init",
          "source": "XMLSaveImpl.java:400"
        },
        {
          "method": "org.eclipse.emf.ecore.xmi.impl.XMLSaveImpl.save",
          "source": "XMLSaveImpl.java:231"
        },
        {
          "method": "org.eclipse.emf.ecore.xmi.impl.XMLResourceImpl.doSave",
          "source": "XMLResourceImpl.java:203"
        },
        {
          "method": "org.eclipse.emf.ecore.resource.impl.ResourceImpl.save",
          "source": "ResourceImpl.java:993"
        },
        {
          "method": "org.apache.tuscany.sdo.test.XMLHelperTestCase.testEMF",
          "source": "XMLHelperTestCase.java:254"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "NativeMethodAccessorImpl.java:64"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "DelegatingMethodAccessorImpl.java:43"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Method.java:615"
        },
        {
          "method": "junit.framework.TestCase.runTest",
          "source": "TestCase.java:154"
        },
        {
          "method": "junit.framework.TestCase.runBare",
          "source": "TestCase.java:127"
        },
        {
          "method": "junit.framework.TestResult$1.protect",
          "source": "TestResult.java:106"
        },
        {
          "method": "junit.framework.TestResult.runProtected",
          "source": "TestResult.java:124"
        },
        {
          "method": "junit.framework.TestResult.run",
          "source": "TestResult.java:109"
        },
        {
          "method": "junit.framework.TestCase.run",
          "source": "TestCase.java:118"
        },
        {
          "method": "junit.framework.TestSuite.runTest",
          "source": "TestSuite.java:208"
        },
        {
          "method": "junit.framework.TestSuite.run",
          "source": "TestSuite.java:203"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.junit3.JUnit3TestReference.run",
          "source": "JUnit3TestReference.java:128"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.TestExecution.run",
          "source": "TestExecution.java:38"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests",
          "source": "RemoteTestRunner.java:460"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests",
          "source": "RemoteTestRunner.java:673"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run",
          "source": "RemoteTestRunner.java:386"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main",
          "source": "RemoteTestRunner.java:196"
        }
      ],
      "number": 0,
      "commentIndex": 0,
      "bugId": "184733",
      "date": "2007-04-30T18:29:47+02:00",
      "product": "EMF",
      "component": "Core",
      "severity": "major"
    },
    {
      "exceptionType": "java.lang.NullPointerException",
      "elements": [
        {
          "method": "org.eclipse.emf.ecore.xmi.impl.XMLSaveImpl.init",
          "source": "XMLSaveImpl.java:400"
        },
        {
          "method": "org.eclipse.emf.ecore.xmi.impl.XMLSaveImpl.save",
          "source": "XMLSaveImpl.java:231"
        },
        {
          "method": "org.eclipse.emf.ecore.xmi.impl.XMLResourceImpl.doSave",
          "source": "XMLResourceImpl.java:203"
        },
        {
          "method": "org.eclipse.emf.ecore.resource.impl.ResourceImpl.save",
          "source": "ResourceImpl.java:993"
        },
        {
          "method": "org.apache.tuscany.sdo.test.XMLHelperTestCase.testEMF",
          "source": "XMLHelperTestCase.java:254"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "NativeMethodAccessorImpl.java:64"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "DelegatingMethodAccessorImpl.java:43"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Method.java:615"
        },
        {
          "method": "junit.framework.TestCase.runTest",
          "source": "TestCase.java:154"
        },
        {
          "method": "junit.framework.TestCase.runBare",
          "source": "TestCase.java:127"
        },
        {
          "method": "junit.framework.TestResult$1.protect",
          "source": "TestResult.java:106"
        },
        {
          "method": "junit.framework.TestResult.runProtected",
          "source": "TestResult.java:124"
        },
        {
          "method": "junit.framework.TestResult.run",
          "source": "TestResult.java:109"
        },
        {
          "method": "junit.framework.TestCase.run",
          "source": "TestCase.java:118"
        },
        {
          "method": "junit.framework.TestSuite.runTest",
          "source": "TestSuite.java:208"
        },
        {
          "method": "junit.framework.TestSuite.run",
          "source": "TestSuite.java:203"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.junit3.JUnit3TestReference.run",
          "source": "JUnit3TestReference.java:128"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.TestExecution.run",
          "source": "TestExecution.java:38"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests",
          "source": "RemoteTestRunner.java:460"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests",
          "source": "RemoteTestRunner.java:673"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run",
          "source": "RemoteTestRunner.java:386"
        },
        {
          "method": "org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main",
          "source": "RemoteTestRunner.java:196"
        }
      ],
      "number": 1,
      "commentIndex": 0,
      "bugId": "184733",
      "date": "2007-04-30T18:29:47+02:00",
      "product": "EMF",
      "component": "Core",
      "severity": "major"
    }
  ],
  "groupId": "184733",
  "bugId": "184733",
  "date": "2007-04-30T18:29:47+02:00",
  "product": "EMF",
  "component": "Core",
  "severity": "major"
}