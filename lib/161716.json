{
  "comments": [
    "I\u0027m getting the following error when attempting to call the IPerspectiveRegistry.deletePerspective(IPerspectiveDescriptor persp) method to delete a cloned perspective:\n\n[Fatal Error] :-1:-1: Premature end of file. \n\nI used the \"RCP Application with a View\" wizard to create a basic RCP application with the name \"demo\".  The resulting perspective extension looks like this:\n\n   \u003cextension point\u003d\"org.eclipse.ui.perspectives\"\u003e\n      \u003cperspective\n            name\u003d\"Perspective\"\n            class\u003d\"demo.Perspective\"\n            id\u003d\"demo.perspective\"\u003e\n      \u003c/perspective\u003e\n   \u003c/extension\u003e\n\nThen in the View class that is generated by the wizard, I added the following in a MouseAdapter in the mouseUp method on the Table:\n\n// Clone the perspective\nString perspectiveId \u003d Perspective.ID + \".1\";\n\nIPerspectiveRegistry registry \u003d PlatformUI.getWorkbench().\n         getPerspectiveRegistry();\nregistry.clonePerspective(perspectiveId, perspectiveId, \n         registry.findPerspectiveWithId(Perspective.ID));\n\n// Set the perspective\nIWorkbench workbench \u003d PlatformUI.getWorkbench();\nIWorkbenchPage page \u003d workbench.getActiveWorkbenchWindow().getActivePage();\nIPerspectiveDescriptor desc \u003d workbench.getPerspectiveRegistry()\n          .findPerspectiveWithId(perspectiveId);\npage.setPerspective(desc);\n\n// Close the clone.\nworkbench.getActiveWorkbenchWindow().getActivePage().closePerspective(desc,  \n           false, false);\n\n// Attempt to delete it\nworkbench.getPerspectiveRegistry().deletePerspective(desc);\n\nThen by running the application and clicking inside the Table the code is executed and the error can be seen.  See attachment for the error message that appears.  The only message that appears in the console is:\n\n[Fatal Error] :-1:-1: Premature end of file. \n\nBased on the javadoc this doesn\u0027t seem like the incorrect use of this method.\n\n/** \n * Deletes a perspective. Has no effect if the perspective is defined in an extension. \n */ \n\nI stepped into the code a little bit and noticed that deletePerspective calls deleteCustomDefinition(PerspectiveDescriptor desc), which calls store.setToDefault(desc.getId() + PERSP), which somehow causes the error.",
    "Created an attachment (id\u003d52390)\nError message that appears when attempting call deletePerspective on a cloned perspective\n\n",
    "I also have found this bug.  It seems to occur because in PerspectiveRegistry \n\nif (event.getNewValue() \u003d\u003d null) should also have || event.getNewValue().equals(\"\") - to check the empty string.\n\nHowever even with adding this line the perspective does not seem to be deleted from the list or from the workbench.xml.\n\n",
    "Created an attachment (id\u003d52808)\nPerspective Registry merge\n\nIt looks like setToDefault(*) started firing a perspective change at the end of 3.2, and the PerspectiveRegistry merging\n\n1) only had that newValue()\u003d\u003dnull when it needed to check for \"\", and\n2) was using startWith(*) to match the ID ... when you use desc.getId()+\".1\", the original perspective descriptor matched as well.\n\nI\u0027ll run some more tests on the patch tomorrow.\n\nPW\n",
    "Released in HEAD \u003e20061027\n\nPW\n",
    "Verified in I20061031-0656\n\nPW\n",
    "Is it safe to back port this fix to 3.2.2 code stream ? I am looking at patching our 3.2.2 plugin with this fix and would appreciate your advice.\n\n",
    "(In reply to comment #6)\n\u003e Is it safe to back port this fix to 3.2.2 code stream ? I am looking at\n\u003e patching our 3.2.2 plugin with this fix and would appreciate your advice.\n\nI had a quick look and it seems pretty safe, since this fix was applied on the R3_2_2 version.  It\u0027s just a null check and a tightening up of a condition\n\nPW\n",
    "Created an attachment (id\u003d64468)\nLogs with registry errors\n\n",
    "Oops I am not sure what I happened to the text I typed in before I attached the logs.. \nI am now trying to backport the fix to 3.2.1. The patch installs fine with no errors. Next when I try to go and Install (using the standard install menu and panels) a new application from my workbench I get several registry errors. (See logs I attached on 4/20). I was wondering if replacing\n\nif (event.getProperty().startsWith(id)) {\n\nWITH\n\nif (event.getProperty().equals(id + PERSP)) {\n\nis not allowed on 3.2.1. \n\nAny ideas on why we are seeing all these errors will be appreciated.",
    "I found those logs impossible to read, but:\n\njava.lang.NullPointerException\u0026#xD;\u0026#xA;\u0026#x9;at com.ibm.rcp.propertybroker.internal.Activator.processDefinitions\n\nWhy is this getting an NPE (it\u0027s not part of eclipse)?\n\nThere\u0027s also stuff like:\njava.lang.ClassCastException: org.eclipse.ui.themes.RGBBlendColorFactory incompatible with org.eclipse.ui.themes.IColorFactory\u0026#xD;\u0026#xA;\u0026#x9;at org.eclipse.ui.internal.themes.ThemeRegistryReader.checkColorFactory(ThemeRegistryReader.java:405\n\n+ if (event.getProperty().equals(id + PERSP)) {\n\nThis shouldn\u0027t cause any kind of registry reader problems, it will restrict the perspectives that this method works on to matching IDs.\n\nPW\n",
    "To view the logs : Unzip. Double click trace-log-0.xml. (Sorry, should have mentioned that).\n\nThere are several of these in the trace log. Was not sure why this happens only when we apply the patch. We are continuing to do some investigation and was hoping you may have some ideas.\n\nInvalid registry object\norg.eclipse.core.runtime.InvalidRegistryObjectException: Invalid registry object\n\tat org.eclipse.core.internal.registry.RegistryObjectManager.basicGetObject(Unknown Source)\n\tat org.eclipse.core.internal.registry.RegistryObjectManager.getObject(Unknown Source)\n\tat org.eclipse.core.internal.registry.ConfigurationElementHandle.getConfigurationElement(Unknown Source)\n\tat org.eclipse.core.internal.registry.ConfigurationElementHandle.getAttribute(Unknown Source)\n\tat org.eclipse.ui.internal.PluginAction.createDelegate(PluginAction.java:136)\n\tat org.eclipse.ui.internal.PluginAction.runWithEvent(PluginAction.java:225)\n\tat org.eclipse.ui.internal.WWinPluginAction.runWithEvent(WWinPluginAction.java:229)\n\tat org.eclipse.jface.action.ActionContributionItem.handleWidgetSelection(Unknown Source)\n\tat org.eclipse.jface.action.ActionContributionItem.access$2(Unknown Source)\n\tat org.eclipse.jface.action.ActionContributionItem$5.handleEvent(Unknown Source)\n\tat org.eclipse.swt.widgets.EventTable.sendEvent(Unknown Source)\n\tat org.eclipse.swt.widgets.Widget.sendEvent(Unknown Source)\n\tat org.eclipse.swt.widgets.Display.runDeferredEvents(Unknown Source)\n\tat org.eclipse.swt.widgets.Display.readAndDispatch(Unknown Source)\n\tat org.eclipse.ui.internal.Workbench.runEventLoop(Workbench.java:1914)\n\tat org.eclipse.ui.internal.Workbench.runUI(Workbench.java:1878)\n\tat org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:419)\n\tat org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:149)\n\tat com.ibm.rcp.personality.framework.internal.RCPApplication.run(Unknown Source)\n\tat org.eclipse.core.internal.runtime.PlatformActivator$1.run(Unknown Source)\n\tat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(EclipseAppLauncher.java:92)\n\tat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(EclipseAppLauncher.java:68)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:400)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:177)\n\tat java.lang.reflect.AccessibleObject.invokeL(Unknown Source)\n\tat java.lang.reflect.Method.invoke(Unknown Source)\n\tat org.eclipse.core.launcher.Main.invokeFramework(Main.java:336)\n\tat org.eclipse.core.launcher.Main.basicRun(Main.java:280)\n\tat org.eclipse.core.launcher.Main.run(Main.java:977)\n\tat com.ibm.rcp.core.internal.launcher.Main.startLaunch(Main.java:868)\n\tat com.ibm.rcp.core.internal.launcher.Main.main(Main.java:1286)\n\tat java.lang.reflect.AccessibleObject.invokeV(Unknown Source)\n\tat java.lang.reflect.Method.invoke(Unknown Source)\n\tat com.ibm.oti.vm.JarRunner.main(Unknown Source)\n\n",
    "Further investigation has shown that the registry corruption is not due to this code change. It has to do with how we upgrade org.eclipse.ui.workbench in the field with patches. We are continuing to investigate with the help of other Eclipse developers. Thank you for your time and patience."
  ],
  "commentCreationDates": [
    "2006-10-20T15:25:31+02:00",
    "2006-10-20T15:27:08+02:00",
    "2006-10-26T12:43:34+02:00",
    "2006-10-27T04:21:23+02:00",
    "2006-10-27T16:37:31+02:00",
    "2006-10-31T15:24:04+01:00",
    "2007-03-18T01:23:45+01:00",
    "2007-03-21T12:12:20+01:00",
    "2007-04-20T18:59:35+02:00",
    "2007-04-22T20:45:33+02:00",
    "2007-04-22T21:56:45+02:00",
    "2007-04-23T19:08:15+02:00",
    "2007-04-25T19:32:05+02:00"
  ],
  "traces": [
    {
      "exceptionType": "org.eclipse.core.runtime.InvalidRegistryObjectException",
      "message": "Invalid registry object",
      "elements": [
        {
          "method": "org.eclipse.core.internal.registry.RegistryObjectManager.basicGetObject",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.internal.registry.RegistryObjectManager.getObject",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.internal.registry.ConfigurationElementHandle.getConfigurationElement",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.internal.registry.ConfigurationElementHandle.getAttribute",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.ui.internal.PluginAction.createDelegate",
          "source": "PluginAction.java:136"
        },
        {
          "method": "org.eclipse.ui.internal.PluginAction.runWithEvent",
          "source": "PluginAction.java:225"
        },
        {
          "method": "org.eclipse.ui.internal.WWinPluginAction.runWithEvent",
          "source": "WWinPluginAction.java:229"
        },
        {
          "method": "org.eclipse.jface.action.ActionContributionItem.handleWidgetSelection",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.jface.action.ActionContributionItem.access$2",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.jface.action.ActionContributionItem$5.handleEvent",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.swt.widgets.EventTable.sendEvent",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.runDeferredEvents",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.readAndDispatch",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runEventLoop",
          "source": "Workbench.java:1914"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runUI",
          "source": "Workbench.java:1878"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.createAndRunWorkbench",
          "source": "Workbench.java:419"
        },
        {
          "method": "org.eclipse.ui.PlatformUI.createAndRunWorkbench",
          "source": "PlatformUI.java:149"
        },
        {
          "method": "com.ibm.rcp.personality.framework.internal.RCPApplication.run",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.internal.runtime.PlatformActivator$1.run",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication",
          "source": "EclipseAppLauncher.java:92"
        },
        {
          "method": "org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start",
          "source": "EclipseAppLauncher.java:68"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:400"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:177"
        },
        {
          "method": "java.lang.reflect.AccessibleObject.invokeL",
          "source": "Unknown Source"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Unknown Source"
        },
        {
          "method": "org.eclipse.core.launcher.Main.invokeFramework",
          "source": "Main.java:336"
        },
        {
          "method": "org.eclipse.core.launcher.Main.basicRun",
          "source": "Main.java:280"
        },
        {
          "method": "org.eclipse.core.launcher.Main.run",
          "source": "Main.java:977"
        },
        {
          "method": "com.ibm.rcp.core.internal.launcher.Main.startLaunch",
          "source": "Main.java:868"
        },
        {
          "method": "com.ibm.rcp.core.internal.launcher.Main.main",
          "source": "Main.java:1286"
        },
        {
          "method": "java.lang.reflect.AccessibleObject.invokeV",
          "source": "Unknown Source"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Unknown Source"
        },
        {
          "method": "com.ibm.oti.vm.JarRunner.main",
          "source": "Unknown Source"
        }
      ],
      "number": 0,
      "commentIndex": 11,
      "bugId": "161716",
      "date": "2007-04-23T19:08:15+02:00",
      "product": "Platform",
      "component": "UI",
      "severity": "normal"
    }
  ],
  "groupId": "161716",
  "bugId": "161716",
  "date": "2006-10-20T15:25:31+02:00",
  "product": "Platform",
  "component": "UI",
  "severity": "normal"
}