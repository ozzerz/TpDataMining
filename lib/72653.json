{
  "comments": [
    "This problem was originally posted as a followup to Bug #70783, but Dorian\nrecommended that it be opened as a separate bug against Platform UI instead.  So\nhere it is.\n\nThe basic problem is that updating an application through the update site seems\nto work correctly, but on restart the error log has several messages and the\nproduct extension is now unusable.  However, restarting Eclipse with -clean\nresolves all issues and the application functions correctly.  Here are the\nentries from the log, followed by the steps to recreate the problem.\n\nLog caused by restart after product update:\n!SESSION Aug 25, 2004 20:18:15.463 --------------------------------------------\n-\neclipse.buildId\u003dI200406240800\njava.version\u003d1.4.2_03\njava.vendor\u003dSun Microsystems Inc.\nBootLoader constants: OS\u003dwin32, ARCH\u003dx86, WS\u003dwin32, NL\u003den_US\n\n!ENTRY System Bundle 0 0 Aug 25, 2004 20:18:15.463\n!MESSAGE FrameworkEvent.ERROR\n!STACK 0\norg.osgi.framework.BundleException: PackageAdmin.refreshPackages failed to \ncomplete\n\tat \norg.eclipse.osgi.framework.internal.core.PackageAdminImpl.processDelta\n(PackageAdminImpl.java:518)\n\tat \norg.eclipse.osgi.framework.internal.core.PackageAdminImpl.refreshPackages\n(PackageAdminImpl.java:352)\n\tat org.eclipse.osgi.framework.internal.core.PackageAdminImpl$1.run\n(PackageAdminImpl.java:321)\n\tat java.lang.Thread.run(Unknown Source)\nCaused by: org.osgi.framework.BundleException: Internal Error in the OSGi \nframework. Please report this problem.\n\tat \norg.eclipse.osgi.framework.internal.core.PackageAdminImpl.deleteRemovalPending\n(PackageAdminImpl.java:157)\n\tat \norg.eclipse.osgi.framework.internal.core.PackageAdminImpl.processDelta\n(PackageAdminImpl.java:454)\n\t... 3 more\nRoot exception:\norg.osgi.framework.BundleException: Internal Error in the OSGi framework. \nPlease report this problem.\n\tat \norg.eclipse.osgi.framework.internal.core.PackageAdminImpl.deleteRemovalPending\n(PackageAdminImpl.java:157)\n\tat \norg.eclipse.osgi.framework.internal.core.PackageAdminImpl.processDelta\n(PackageAdminImpl.java:454)\n\tat \norg.eclipse.osgi.framework.internal.core.PackageAdminImpl.refreshPackages\n(PackageAdminImpl.java:352)\n\tat org.eclipse.osgi.framework.internal.core.PackageAdminImpl$1.run\n(PackageAdminImpl.java:321)\n\tat java.lang.Thread.run(Unknown Source)\n\n!ENTRY org.eclipse.ui 4 4 Aug 25, 2004 20:18:18.617\n!MESSAGE Unable to find Action Set: com.genuitec.myeclipse.actions.deploytools\n\n!ENTRY org.eclipse.ui 4 4 Aug 25, 2004 20:18:18.627\n!MESSAGE Unable to find Action Set: com.genuitec.myeclipse.actions\n\n!ENTRY org.eclipse.ui 4 4 Aug 25, 2004 20:18:18.627\n!MESSAGE Unable to find Action Set: \ncom.genuitec.myeclipse.actions.hibernatetools\n\n!ENTRY org.eclipse.ui 4 4 Aug 25, 2004 20:18:18.637\n!MESSAGE Unable to find Action Set: com.genuitec.myeclipse.actions.webtools\n\n!ENTRY org.eclipse.ui 4 4 Aug 25, 2004 20:18:18.637\n!MESSAGE Unable to find Action Set: com.genuitec.myeclipse.actions.jsftools\n\n!ENTRY org.eclipse.ui 4 4 Aug 25, 2004 20:18:18.637\n!MESSAGE Unable to find Action Set: com.genuitec.myeclipse.actions.strutstools\n\n!ENTRY org.eclipse.ui 4 4 Aug 25, 2004 20:18:43.32\n!MESSAGE Category com.genuitec.eclipse.views.myEclipseCategory not found for \nview com.genuitec.eclipse.ui.HTMLView.  This view added to \u0027Other\u0027 category.\n\n\nPlease note that is is Dorians log with a later build of Eclipse 3.0.  However,\nthe same error exists in the 3.0 release of 6/25.\n\nHere are the steps to reproduce the problem.\n\n1) Install a clean version of Eclipse 3.0\n2) Download the MyEclipse 3.8.0 manual installation available here:\nhttp://www.myeclipseide.com/products/eworkbench/eclipse-bug70783-test/myeclipse_030800.zip\n3) Unzip the archive somewhere outside your Eclipse installation. \n4) Install it as a product extension through Help \u003e Manage Configuration...\n5) Restart\n6) Open Help \u003e About Eclipse and notice the five MyEclipse features are installed.\n7) Open the MyEclipse Perspective and the Error Log view\n8) Exit the workbench\n9) Update to version 3.8.1 by adding a new update site that points to:\nhttp://www.myeclipseide.com/products/eworkbench/updates-3.8.0to3.8.1\n10) Allow the workbench to restart\n11) Upon restart you\u0027ll get several errors about missing action sets and the\nneed to reset the perspective.\n12) The log will have several errors in it about missing functionality and most\nof the features are now unavailable even though 3.8.1 was only a bug-fix update.\n13) Clear the log file in the Error Log view and exit Eclipse\n14) Restart with the -clean option and notice that now MyEclipse 3.8.1 starts\nwithout error and all functionality is now available.\n\nNaturally, the lare number of errors in the log and multiple perspective reset\ndialogs do not enhance the end user experience.  The broken functionality after\nthe update only exacerbates the issue.  Again, all fixed with a -clean start. \nHope that helps.  Please let me know if you need any more information.",
    "The multiple prompts to the user to accept/deny perspective resets is likely \ncaused by the old plugins being uninstalled and the newer version being \ninstalled. This can be solved with a yes/no/always type of dialog, etc.\n\nAs far as I can tell, this does not appear to be an update bug, but rather a \nside effect of updating manifested in the UI.",
    "I\u0027m not concerned about the dialogs asking to reset the perspective.  What\nbothers me is that after all of that, most of the actions are disabled, as shown\nin the log.  Basically, the software is broken without a -clean restart.",
    "Moving to runtime for investigation (as per .log\u0027s entry:\nCaused by: org.osgi.framework.BundleException: Internal Error in the OSGi \nframework. Please report this problem.)",
    "This should be investigated for 3.0.1.\nCC\u0027ing Tom",
    "Do you have to use the -clean option.  When I restart eclipse a second time \nwithout the -clean option it looks like everything comes up fine.\n\nI\u0027m tracking down a bug in PackageAdmin.refreshPackages() now...",
    "Created an attachment (id\u003d14198)\nProposed fix to PackageAdmin\n\nThere is a bug in PackageAdmin when a fragment gets uninstalled.  In this case\nthe host bundle\u0027s classloader was getting pinned for removal pending which is\nneeded because a fragment got uninstalled so the content of the host changed. \nThe bug is in the processing of the graph of dependent bundles to refresh.  \n\nWhen processing the removal pending bundles the depenedents for the removal\npendings are not always added to the refresh graph.  In this case the host was\njface.text because the myeclipse product has a fragment to jface.text.\tSince\nthe dependents of jface.text were not added to the refresh graph this caused\nrefreshPackages to fail when it tried to remove the classloader of the old\njface.text host bundle.",
    "Thomas, -clean is exactly the issue.  You *have* to use the -clean option on the\nrestart.  However, telling users this is exceedingly problematic as they\nimmediately think the update broke their installation and become frantic.  \n\nI truly believe that when the configuration is changed, the restart should\n*always* be a clean restart to avoid this and any future problems.  Logically,\nthe configuration has been changed, so the cached configuration is trully\ninvalid, so the cached configuration should be dumped.  ",
    "OK, I understand now.  I thought you meant you had to run with the -clean \noption when you launched eclipse again after the original errors occurred to \nget it to work.  I had found that after the errors occurred I could simple \nrelaunch eclipse again (without the -clean option) and everything would be \nfine.\n\nRelauncher eclipse with -clean everytime update performs an \ninstall/update/uninstall would cause some other problems.  First of all, it \nwould prohibit us from supporting installs/updates/uninstalls without \nrestarting eclipse (which is a goal we want to accomplish but did not fully \nmake it for 3.0).  Also, it would prohibit any other management agent besides \nupdate from installing and managing other bundles installed in the Framework.  \nThe -clean option causes all bundles to be uninstalled and then update \ninstalls all the plugins on restart, but any other bundles that were installed \nby another management agent will have been lost.\n\nThe reason the problem outlined in this report occurred is because of a bug in \nPackageAdmin.  We should fix the bug in PackageAdmin and keep moving forward \nin making eclipse updatable without restarts.  I attached a patch that fixes \nthis bug and tested out with your scenario and everything works now.",
    "Thomas, that was a very well articulated explaination.  Thanks for the quick\nturnaround on the fix and for making it available for 3.0.1.",
    "Well I have not actually made it available for 3.0.1 yet ;-)\n\nNeed to get a code review.  Jeff, could you review the patch and get it \napproved to include in 3.0.1?  ",
    "changes look good to me.  ",
    "looks good to me too.",
    "At the very beginning of this method, in the refresh\u003d\u003dnull branch why don\u0027t we\nhave the same code pattern?\n",
    "Looks like this code could be cleaned up a bit.  We are doing some additional \nwork in the beginning of this method that will be taken care of later on when \nwe complete the graph in the do while loop.  When refresh \u003d\u003d null we really \njust want to prime the gragh with the removal pending bundles, the else \nstatements really are not even needed because fragments are take care of in \nthe do while loop later.\n\nWe should consider cleaning this up for 3.1.",
    "The patch has been checked into 3.0.1 and HEAD.  See bug 72877 to track \nadditional clean up of this code for 3.1 release.",
    "Thomas, Please mark as fixed before 3.0.1 RC1.",
    "The fix will be included in 3.0.1 RC1."
  ],
  "commentCreationDates": [
    "2004-08-26T02:44:20+02:00",
    "2004-08-26T04:34:51+02:00",
    "2004-08-26T05:25:25+02:00",
    "2004-08-26T06:16:38+02:00",
    "2004-08-26T15:45:46+02:00",
    "2004-08-26T17:29:41+02:00",
    "2004-08-26T18:39:40+02:00",
    "2004-08-26T18:41:40+02:00",
    "2004-08-26T19:55:21+02:00",
    "2004-08-26T20:16:34+02:00",
    "2004-08-26T21:15:21+02:00",
    "2004-08-30T15:46:56+02:00",
    "2004-08-30T16:04:55+02:00",
    "2004-08-30T16:08:23+02:00",
    "2004-08-30T16:34:17+02:00",
    "2004-08-30T16:57:50+02:00",
    "2004-08-30T17:41:19+02:00",
    "2004-08-30T18:11:58+02:00"
  ],
  "traces": [
    {
      "exceptionType": "org.osgi.framework.BundleException",
      "message": "PackageAdmin.refreshPackages failed to  complete",
      "elements": [
        {
          "method": "org.eclipse.osgi.framework.internal.core.PackageAdminImpl.processDelta",
          "source": "PackageAdminImpl.java:518"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.PackageAdminImpl.refreshPackages",
          "source": "PackageAdminImpl.java:352"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.PackageAdminImpl$1.run",
          "source": "PackageAdminImpl.java:321"
        },
        {
          "method": "java.lang.Thread.run",
          "source": "Unknown Source"
        }
      ],
      "causedBy": {
        "exceptionType": "org.osgi.framework.BundleException",
        "message": "Internal Error in the OSGi  framework. Please report this problem.",
        "elements": [
          {
            "method": "org.eclipse.osgi.framework.internal.core.PackageAdminImpl.deleteRemovalPending",
            "source": "PackageAdminImpl.java:157"
          },
          {
            "method": "org.eclipse.osgi.framework.internal.core.PackageAdminImpl.processDelta",
            "source": "PackageAdminImpl.java:454"
          }
        ],
        "number": 0,
        "commentIndex": 0
      },
      "number": 0,
      "commentIndex": 0,
      "bugId": "72653",
      "date": "2004-08-26T02:44:20+02:00",
      "product": "Platform",
      "component": "Runtime",
      "severity": "normal"
    },
    {
      "exceptionType": "org.osgi.framework.BundleException",
      "message": "Internal Error in the OSGi framework.  Please report this problem.",
      "elements": [
        {
          "method": "org.eclipse.osgi.framework.internal.core.PackageAdminImpl.deleteRemovalPending",
          "source": "PackageAdminImpl.java:157"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.PackageAdminImpl.processDelta",
          "source": "PackageAdminImpl.java:454"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.PackageAdminImpl.refreshPackages",
          "source": "PackageAdminImpl.java:352"
        },
        {
          "method": "org.eclipse.osgi.framework.internal.core.PackageAdminImpl$1.run",
          "source": "PackageAdminImpl.java:321"
        },
        {
          "method": "java.lang.Thread.run",
          "source": "Unknown Source"
        }
      ],
      "number": 1,
      "commentIndex": 0,
      "bugId": "72653",
      "date": "2004-08-26T02:44:20+02:00",
      "product": "Platform",
      "component": "Runtime",
      "severity": "normal"
    }
  ],
  "groupId": "72653",
  "bugId": "72653",
  "date": "2004-08-26T02:44:20+02:00",
  "product": "Platform",
  "component": "Runtime",
  "severity": "normal"
}