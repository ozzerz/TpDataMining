{
  "comments": [
    "This bug can be reproduced using Eclipse and the JDT:\n\n1) Choose File \u003e New \u003e Package to display the new package wizard dialog\n2) Click the \"?\" icon at the lower left to open the help tray on the dialog\n3) Click the \"Cancel\" button (while the help tray is open)\n4) Dialog window remains on screen, with most of its contents blank\n\nThe problem is that an SWT exception for trying to draw an Image that has been disposed is thrown while trying to close the dialog. What happens is that the Image for the Label at the top right (the icon of a package) is disposed as a result of disposing of the Wizard, then the tray is closed. Closing the tray causes the SWT to want to refresh the dialog window, which results in the attempt to draw the already disposed Image.\n\nI implemented a workaround in my own Wizard subclass that overrides dispose() and closes the TrayDialog of its container before calling super.dispose() so that the tray is closed before the Image is disposed.",
    "TrayDialog should not be disposing an image that is in use so that code needs to be fixed.  Since I don\u0027t have a Mac handy right this instant, I can\u0027t see who is drawing the image.  If GC.drawImage() is doing it, then it\u0027s not an SWT issue.  If Tree or Table or some other component is drawing it (perhaps using GC.drawImage(), then we *may* consider adding a dispose check.",
    "here is the stack trace:\norg.eclipse.swt.SWTException: Graphic is disposed\nat org.eclipse.swt.SWT.error(SWT.java:3374)\nat org.eclipse.swt.SWT.error(SWT.java:3297)\nat org.eclipse.swt.SWT.error(SWT.java:3268)\nat org.eclipse.swt.graphics.Image.getBounds(Image.java:610)\nat org.eclipse.swt.widgets.Label.drawWidget(Label.java:188)\nat org.eclipse.swt.widgets.Widget.kEventControlDraw(Widget.java:1001)\nat org.eclipse.swt.widgets.Widget.controlProc(Widget.java:352)\nat org.eclipse.swt.widgets.Display.controlProc(Display.java:838)\nat org.eclipse.swt.internal.carbon.OS.SetWindowBounds(Native Method)\nat org.eclipse.swt.widgets.Shell.setBounds(Shell.java:1312)\nat org.eclipse.swt.widgets.Control.setSize(Control.java:2949)\nat org.eclipse.help.ui.internal.views.HelpTray$5.handleEvent(HelpTray.java:210)\nat org.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:66)\nat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1496)\nat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1520)\nat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1501)\nat org.eclipse.swt.widgets.Shell.kEventWindowBoundsChanged(Shell.java:928)\nat org.eclipse.swt.widgets.Widget.windowProc(Widget.java:2037)\nat org.eclipse.swt.widgets.Display.windowProc(Display.java:4032)\nat org.eclipse.swt.internal.carbon.OS.SetWindowBounds(Native Method)\nat org.eclipse.swt.widgets.Shell.setBounds(Shell.java:1312)\nat org.eclipse.swt.widgets.Control.setBounds(Control.java:2475)\nat org.eclipse.jface.dialogs.TrayDialog.closeTray(TrayDialog.java:129)\nat org.eclipse.jface.dialogs.TrayDialog.close(TrayDialog.java:141)\nat org.eclipse.jface.wizard.WizardDialog.hardClose(WizardDialog.java:735)\nat org.eclipse.jface.wizard.WizardDialog.close(WizardDialog.java:407)\nat org.eclipse.jface.wizard.WizardDialog.cancelPressed(WizardDialog.java:395)\nat org.eclipse.jface.wizard.WizardDialog$1.widgetSelected(WizardDialog.java:277)\nat org.eclipse.swt.widgets.TypedListener.handleEvent(TypedListener.java:90)\nat org.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:66)\nat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1496)\nat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1520)\nat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1505)\nat org.eclipse.swt.widgets.Widget.notifyListeners(Widget.java:1279)\nat org.eclipse.swt.widgets.Display.runDeferredEvents(Display.java:3312)\nat org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:2941)\nat org.eclipse.jface.window.Window.runEventLoop(Window.java:820)\nat org.eclipse.jface.window.Window.open(Window.java:796)\nat org.eclipse.jdt.ui.actions.AbstractOpenWizardAction.run(AbstractOpenWizardAction.java:83)\nat org.eclipse.jdt.internal.ui.wizards.OpenPackageWizardToolbarAction.run(OpenPackageWizardToolbarAction.java:45)\nat org.eclipse.ui.internal.PluginAction.runWithEvent(PluginAction.java:254)\nat org.eclipse.ui.internal.WWinPluginAction.runWithEvent(WWinPluginAction.java:229)\nat org.eclipse.jface.action.ActionContributionItem.handleWidgetSelection(ActionContributionItem.java:539)\nat org.eclipse.jface.action.ActionContributionItem.access$2(ActionContributionItem.java:488)\nat org.eclipse.jface.action.ActionContributionItem$6.handleEvent(ActionContributionItem.java:441)\nat org.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:66)\nat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1496)\nat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1520)\nat org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1505)\nat org.eclipse.swt.widgets.Widget.notifyListeners(Widget.java:1279)\nat org.eclipse.swt.widgets.Display.runDeferredEvents(Display.java:3312)\nat org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:2941)\nat org.eclipse.ui.internal.Workbench.runEventLoop(Workbench.java:1914)\nat org.eclipse.ui.internal.Workbench.runUI(Workbench.java:1878)\nat org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:419)\nat org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:149)\nat org.eclipse.ui.internal.ide.IDEApplication.run(IDEApplication.java:95)\nat org.eclipse.core.internal.runtime.PlatformActivator$1.run(PlatformActivator.java:78)\nat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(EclipseAppLauncher.java:92)\nat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(EclipseAppLauncher.java:68)\nat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:400)\nat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:177)\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\nat java.lang.reflect.Method.invoke(Method.java:324)\nat org.eclipse.core.launcher.Main.invokeFramework(Main.java:336)\nat org.eclipse.core.launcher.Main.basicRun(Main.java:280)\nat org.eclipse.core.launcher.Main.run(Main.java:977)\nat org.eclipse.core.launcher.Main.main(Main.java:952)",
    "Created an attachment (id\u003d49098)\npatch\n\npatch to TitleAreaDialog",
    "Susan, the problem is that the titleImageLabel\u0027s image is disposed before the shell (and with it the label) is disposed.  Can you have a look at the patch?  It solves the issue on the Mac, but I\u0027m not sure if I found the best solution for this.",
    "SSQ, even though strictly speaking this is invalid, we should probably just add the isDisposed() test.",
    "The patch makes the problem go away, since disposing the title area label will keep SWT from doing anything further with the label and its image.  But I don\u0027t really like it.  The real problem is that someone has disposed this image before the wizard was closed.  I\u0027ll crawl through the JDT code and figure out where this is happening.",
    "oh, I see..the dialog page is the culprit...I\u0027ll fix this",
    "marking for 3.3",
    "fix for M7",
    "This is one of those \"framework-itis\" bugs.\nWizardDialogs set the title bar image to be the image of the current page.\n\nThe problem is the disposal/close sequence that happens between the wizards, pages, and the containing wizard dialog.\n\nWizardDialog.hardClose() disposes all created wizards.\nWizard.dispose() disposes all the pages\nWizardPage.dispose() disposes its image (in the inherited code from DialogPage.dispose()), not knowing the image may still be used in the TitleAreaDialog title bar.\n\nThen...WizardDialog.hardClose() calls super.close() \nTrayDialog.close() closes the tray if it\u0027s open.  This is done by disposing of the tray widgets one by one, which may generate paints on some platforms.  Which will generate a paint for the title area image label, whose image was set to the current page\u0027s image, who has already disposed its image.\n\nThe best way to fix would be to handle it in WizardDialog.hardClose() but there\u0027s nothing that can really be done there.  The title image could be set to null, but the TitleAreaDialog won\u0027t reset the label\u0027s image if null is the parameter.  So Boris\u0027 original patch which simply hides the timing problem by disposing the title area image during the close() sequence is looking better and better. \n\nI\u0027ve modified the patch to be a bit less brittle, in that it *hides* the title area image rather than disposing it, so that future code changes in TitleAreaDialog which may manipulate the widget during the close sequence won\u0027t trip over a prematurely disposed widget.  ",
    "Created an attachment (id\u003d63299)\npatch that hides the title area image label\n\nBoris - can you please try this patch on a Mac and see if the problem is fixed (and that the problem still exists before the patch)?  ",
    "Kim - when you have a chance, can you verify that\n(a) the problem described still exists on a Mac\n(b) this patch fixes it\n\nMy Mac is pretty broken/out of date right now, so the proposed fix is theoretical...",
    "Created an attachment (id\u003d64340)\nreplacement patch\n\nthe previous patch caused an error in the destroyed dialog leak tests.  This patch fixes the problem.",
    "Sorry for taking so long to get to this Susan - my email has been acting up in the worst way.  \n\nI can\u0027t reproduce this even without the patch applied.  ",
    "thanks, Kim.  No sense fixing a bug that no longer occurs.  The dispose flow likely changed since 3.2...for example the animated message area has since been removed.  In theory this problem could still occur if the title image got a paint during the close sequence.\n\nMarking INVALID and if this reappears, we can revisit the patch.",
    "marking verified (there was no fix)",
    "Changing OS from Mac OS to Mac OS X as per bug 185991"
  ],
  "commentCreationDates": [
    "2006-08-25T00:21:39+02:00",
    "2006-08-29T04:08:02+02:00",
    "2006-08-30T22:27:26+02:00",
    "2006-08-30T22:44:18+02:00",
    "2006-08-30T22:47:02+02:00",
    "2006-08-30T22:52:26+02:00",
    "2006-08-30T23:03:11+02:00",
    "2006-08-30T23:15:20+02:00",
    "2006-09-04T21:00:10+02:00",
    "2007-04-04T20:39:28+02:00",
    "2007-04-10T01:37:03+02:00",
    "2007-04-10T01:42:07+02:00",
    "2007-04-12T20:28:30+02:00",
    "2007-04-19T21:09:40+02:00",
    "2007-04-19T21:19:06+02:00",
    "2007-04-19T21:57:22+02:00",
    "2007-05-01T17:59:43+02:00",
    "2007-07-29T15:20:51+02:00"
  ],
  "traces": [
    {
      "exceptionType": "org.eclipse.swt.SWTException",
      "message": "Graphic is disposed",
      "elements": [
        {
          "method": "org.eclipse.swt.SWT.error",
          "source": "SWT.java:3374"
        },
        {
          "method": "org.eclipse.swt.SWT.error",
          "source": "SWT.java:3297"
        },
        {
          "method": "org.eclipse.swt.SWT.error",
          "source": "SWT.java:3268"
        },
        {
          "method": "org.eclipse.swt.graphics.Image.getBounds",
          "source": "Image.java:610"
        },
        {
          "method": "org.eclipse.swt.widgets.Label.drawWidget",
          "source": "Label.java:188"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.kEventControlDraw",
          "source": "Widget.java:1001"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.controlProc",
          "source": "Widget.java:352"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.controlProc",
          "source": "Display.java:838"
        },
        {
          "method": "org.eclipse.swt.internal.carbon.OS.SetWindowBounds",
          "source": "Native Method"
        },
        {
          "method": "org.eclipse.swt.widgets.Shell.setBounds",
          "source": "Shell.java:1312"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.setSize",
          "source": "Control.java:2949"
        },
        {
          "method": "org.eclipse.help.ui.internal.views.HelpTray$5.handleEvent",
          "source": "HelpTray.java:210"
        },
        {
          "method": "org.eclipse.swt.widgets.EventTable.sendEvent",
          "source": "EventTable.java:66"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:1496"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:1520"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:1501"
        },
        {
          "method": "org.eclipse.swt.widgets.Shell.kEventWindowBoundsChanged",
          "source": "Shell.java:928"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.windowProc",
          "source": "Widget.java:2037"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.windowProc",
          "source": "Display.java:4032"
        },
        {
          "method": "org.eclipse.swt.internal.carbon.OS.SetWindowBounds",
          "source": "Native Method"
        },
        {
          "method": "org.eclipse.swt.widgets.Shell.setBounds",
          "source": "Shell.java:1312"
        },
        {
          "method": "org.eclipse.swt.widgets.Control.setBounds",
          "source": "Control.java:2475"
        },
        {
          "method": "org.eclipse.jface.dialogs.TrayDialog.closeTray",
          "source": "TrayDialog.java:129"
        },
        {
          "method": "org.eclipse.jface.dialogs.TrayDialog.close",
          "source": "TrayDialog.java:141"
        },
        {
          "method": "org.eclipse.jface.wizard.WizardDialog.hardClose",
          "source": "WizardDialog.java:735"
        },
        {
          "method": "org.eclipse.jface.wizard.WizardDialog.close",
          "source": "WizardDialog.java:407"
        },
        {
          "method": "org.eclipse.jface.wizard.WizardDialog.cancelPressed",
          "source": "WizardDialog.java:395"
        },
        {
          "method": "org.eclipse.jface.wizard.WizardDialog$1.widgetSelected",
          "source": "WizardDialog.java:277"
        },
        {
          "method": "org.eclipse.swt.widgets.TypedListener.handleEvent",
          "source": "TypedListener.java:90"
        },
        {
          "method": "org.eclipse.swt.widgets.EventTable.sendEvent",
          "source": "EventTable.java:66"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:1496"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:1520"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:1505"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.notifyListeners",
          "source": "Widget.java:1279"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.runDeferredEvents",
          "source": "Display.java:3312"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.readAndDispatch",
          "source": "Display.java:2941"
        },
        {
          "method": "org.eclipse.jface.window.Window.runEventLoop",
          "source": "Window.java:820"
        },
        {
          "method": "org.eclipse.jface.window.Window.open",
          "source": "Window.java:796"
        },
        {
          "method": "org.eclipse.jdt.ui.actions.AbstractOpenWizardAction.run",
          "source": "AbstractOpenWizardAction.java:83"
        },
        {
          "method": "org.eclipse.jdt.internal.ui.wizards.OpenPackageWizardToolbarAction.run",
          "source": "OpenPackageWizardToolbarAction.java:45"
        },
        {
          "method": "org.eclipse.ui.internal.PluginAction.runWithEvent",
          "source": "PluginAction.java:254"
        },
        {
          "method": "org.eclipse.ui.internal.WWinPluginAction.runWithEvent",
          "source": "WWinPluginAction.java:229"
        },
        {
          "method": "org.eclipse.jface.action.ActionContributionItem.handleWidgetSelection",
          "source": "ActionContributionItem.java:539"
        },
        {
          "method": "org.eclipse.jface.action.ActionContributionItem.access$2",
          "source": "ActionContributionItem.java:488"
        },
        {
          "method": "org.eclipse.jface.action.ActionContributionItem$6.handleEvent",
          "source": "ActionContributionItem.java:441"
        },
        {
          "method": "org.eclipse.swt.widgets.EventTable.sendEvent",
          "source": "EventTable.java:66"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:1496"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:1520"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.sendEvent",
          "source": "Widget.java:1505"
        },
        {
          "method": "org.eclipse.swt.widgets.Widget.notifyListeners",
          "source": "Widget.java:1279"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.runDeferredEvents",
          "source": "Display.java:3312"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.readAndDispatch",
          "source": "Display.java:2941"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runEventLoop",
          "source": "Workbench.java:1914"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runUI",
          "source": "Workbench.java:1878"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.createAndRunWorkbench",
          "source": "Workbench.java:419"
        },
        {
          "method": "org.eclipse.ui.PlatformUI.createAndRunWorkbench",
          "source": "PlatformUI.java:149"
        },
        {
          "method": "org.eclipse.ui.internal.ide.IDEApplication.run",
          "source": "IDEApplication.java:95"
        },
        {
          "method": "org.eclipse.core.internal.runtime.PlatformActivator$1.run",
          "source": "PlatformActivator.java:78"
        },
        {
          "method": "org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication",
          "source": "EclipseAppLauncher.java:92"
        },
        {
          "method": "org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start",
          "source": "EclipseAppLauncher.java:68"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:400"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:177"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "NativeMethodAccessorImpl.java:39"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "DelegatingMethodAccessorImpl.java:25"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Method.java:324"
        },
        {
          "method": "org.eclipse.core.launcher.Main.invokeFramework",
          "source": "Main.java:336"
        },
        {
          "method": "org.eclipse.core.launcher.Main.basicRun",
          "source": "Main.java:280"
        },
        {
          "method": "org.eclipse.core.launcher.Main.run",
          "source": "Main.java:977"
        },
        {
          "method": "org.eclipse.core.launcher.Main.main",
          "source": "Main.java:952"
        }
      ],
      "number": 0,
      "commentIndex": 2,
      "bugId": "155130",
      "date": "2006-08-30T22:27:26+02:00",
      "product": "Platform",
      "component": "UI",
      "severity": "normal"
    }
  ],
  "groupId": "155130",
  "bugId": "155130",
  "date": "2006-08-25T00:21:39+02:00",
  "product": "Platform",
  "component": "UI",
  "severity": "normal"
}