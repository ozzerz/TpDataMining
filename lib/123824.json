{
  "comments": [
    "I\u0027m building a pretty big open source project, O.K., it\u0027s Mono. I am finding on full builds, the build Console locks up once in a while. I have to kill eclipse to get it working again. The command lines are pretty long so there is a lot of text that gets output.",
    "After initial investigation, it appears to happen while handing the *second* overflow condition where we remove the top so many characters of the document. It also appears that the StyledText widget isn\u0027t aware of the removal and shows that the top line is greater than maxLines. I also saw that there were a couple of asyncExecs in the call chain. I wonder if we are getting smoked by threading issues.",
    "So the use case is that our build console uses Document. We add text output from the build command to the end of the document. As we pass a maximum number of lines, we remove text from the top of the document to keep at the maximum.\n\nThe problem I am seeing is that the StyleText widget has a topIndex which holds the line number of the line visible at the top of the widget. When we do our reduction, the topIndex is not updated and continues to point past the end of the document and eventually causes a BadLocationException.\n\nI\u0027m not sure if this is the abstract document failing to update the scroll location of the widget or something else. We did not have this problem in the Eclispe 3.1.1 with the same CDT code.",
    "Please provide more information, see also:\nhttp://dev.eclipse.org/viewcvs/index.cgi/%7Echeckout%7E/platform-text-home/development/bug-incomplete.htm",
    "How much more information do you need?\n\nEclipse 3.2M4, CDT HEAD, Do a build with lots of build output, BadLocationException thrown although this seems to be more of a side affect that the StyledText.topIndex is past the end of the Document.\n\nWe\u0027re in plugin org.eclipse.cdt.core on /cvsroot/tools/org.eclipse.cdt-core. In class BuildConsolePartitioner, we use Document.replace to add text at the end of our document and we use Document.replace with an empty string to remove text from the top of the document in method appendToDocument and checkOverflow respectively.",
    "We also move the selection to the end of the document every time it changes in our BuildConsoleViewer.revealEndOfDocument() using StyledText.setCaretOffset and StyledText.showSelection().",
    "Is the BuildConsoleViewer a TextViewer?\n\nNote that directly manipulating the StyledText widget instead of going through the TextViewer can cause problems. In addition, make sure you do not modify the document outside the UI thread.\n\n\u003eHow much more information do you need?\nWhat about a thread dump when you have the lock? Stacktraces with the exceptions, build id etc. (see link I posted in comment 3).\n",
    "Created an attachment (id\u003d33144)\nWorksplace syhowing the problem.\n\n",
    "Thanks, sorry for sounding grumpy. I spent the whole day in the debugger yesterday investigating this problem which will make most people grumpy :)\n\nYes BuildConsoleViewer is a TextViewer. It plugins into the ConsoleView.\n\nI have a attached a workspace that easily reproduces the problem. Simply make a change to the dummy file in the Test project and do a build. The build command is set to do a \u0027cmd /c type .project\u0027 and the maxLines for the CDT build console is set to 10.\n\nThis again is Eclispe 3.2 and you can get the latest CDT build from:\nhttp://cdt.eclipse.org/builds/3.1.0/I.I200601170100/index.html\n\nPick an SDK for your platform of choice. Of course if it isn\u0027t Windows, you\u0027ll need to change the build command to be \u0027cat .project\u0027.\n\nHope this helps.",
    "Oh, yeah, and the Console view has to be visible.",
    "Can you confirm it works if you simply replace 3.2M4 with 3.1.1? If so, could you do a quick test using latest I-build (I20060117-0800 or the one from last week)? There were several changes in StyledText and then bug fixes after M4.",
    "I tried I20060113-1200, since today\u0027s isn\u0027t available for download yet, and, yes, the problem is still there. CDT HEAD no longer works against 3.1.1, but we have made no changes in the Build Console since CDT 3.0 which does work with Eclipse 3.1.1 and we do not see the problem there.\n\nAnd yes, my debug session did show that the StyledText widget is very different than it was in 3.1.1, which was my \u0027Ah-ha\u0027 moment that this wasn\u0027t a CDT issue (they guys who were at the Ottawa committers meeting will get that one :).",
    "Actually our Build Console is in the org.eclipse.cdt.ui plugin, not the core plugin.",
    "(In reply to comment #6)\n\u003e What about a thread dump when you have the lock? Stacktraces with the\n\u003e exceptions, build id etc. (see link I posted in comment 3).\n\u003e \nHere is the backtrace;\n\nError 2006-01-17 12:03:58.78 Failed to execute runnable (java.lang.IllegalArgumentException: Argument not valid)\norg.eclipse.swt.SWTException: Failed to execute runnable (java.lang.IllegalArgumentException: Argument not valid)\n\tat org.eclipse.swt.SWT.error(SWT.java:3283)\n\tat org.eclipse.swt.SWT.error(SWT.java:3206)\n\tat org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:126)\n\tat org.eclipse.swt.widgets.Display.runAsyncMessages(Display.java:3262)\n\tat org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:2908)\n\tat org.eclipse.ui.internal.Workbench.runEventLoop(Workbench.java:1762)\n\tat org.eclipse.ui.internal.Workbench.runUI(Workbench.java:1726)\n\tat org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:397)\n\tat org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:143)\n\tat org.eclipse.ui.internal.ide.IDEApplication.run(IDEApplication.java:106)\n\tat org.eclipse.core.internal.runtime.PlatformActivator$1.run(PlatformActivator.java:109)\n\tat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(EclipseAppLauncher.java:92)\n\tat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(EclipseAppLauncher.java:68)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:379)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:177)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:585)\n\tat org.eclipse.core.launcher.Main.invokeFramework(Main.java:338)\n\tat org.eclipse.core.launcher.Main.basicRun(Main.java:282)\n\tat org.eclipse.core.launcher.Main.run(Main.java:977)\n\tat org.eclipse.core.launcher.Main.main(Main.java:952)\nCaused by: java.lang.IllegalArgumentException: Argument not valid\n\tat org.eclipse.swt.SWT.error(SWT.java:3267)\n\tat org.eclipse.swt.SWT.error(SWT.java:3206)\n\tat org.eclipse.swt.SWT.error(SWT.java:3177)\n\tat org.eclipse.jface.text.DefaultDocumentAdapter.getLine(DefaultDocumentAdapter.java:172)\n\tat org.eclipse.swt.custom.StyledTextRenderer.getTextLayout(StyledTextRenderer.java:643)\n\tat org.eclipse.swt.custom.StyledTextRenderer.getTextLayout(StyledTextRenderer.java:607)\n\tat org.eclipse.swt.custom.StyledTextRenderer.calculate(StyledTextRenderer.java:197)\n\tat org.eclipse.swt.custom.StyledTextRenderer.getLineHeight(StyledTextRenderer.java:473)\n\tat org.eclipse.swt.custom.StyledText.getLinePixel(StyledText.java:3620)\n\tat org.eclipse.swt.custom.StyledText.handleTextChanging(StyledText.java:5346)\n\tat org.eclipse.swt.custom.StyledText$6.textChanging(StyledText.java:4790)\n\tat org.eclipse.jface.text.DefaultDocumentAdapter.fireTextChanging(DefaultDocumentAdapter.java:382)\n\tat org.eclipse.jface.text.DefaultDocumentAdapter.documentAboutToBeChanged(DefaultDocumentAdapter.java:299)\n\tat org.eclipse.jface.text.AbstractDocument.fireDocumentAboutToBeChanged(AbstractDocument.java:613)\n\tat org.eclipse.jface.text.AbstractDocument.replace(AbstractDocument.java:1103)\n\tat org.eclipse.jface.text.AbstractDocument.replace(AbstractDocument.java:1119)\n\tat org.eclipse.cdt.internal.ui.buildconsole.BuildConsolePartitioner$1.run(BuildConsolePartitioner.java:159)\n\tat org.eclipse.swt.widgets.RunnableLock.run(RunnableLock.java:35)\n\tat org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:123)\n\t... 20 more\n\n\n",
    "Needs to be investigated.",
    "Just marking this as critical since this is severly impacting the CDT.",
    "OK, I found out why it worked in 3.1 and not in 3.2 but first an IMPORTANT NOTE about your implementation (Darin, this is also of interest for you):\n\nDirectly modifying the widget is on your own risk and you have to make sure it works together with the viewer: for example you use \u0027LineStyleListener\u0027 which is not allowed to be used when StyledText.*StyleRange*(...) methods are used - but that\u0027s exactly what the Text- and SourceViewer use i.e. you have to make sure not to use Platform Text features like presentation reconciler, hyperlink support, annotation painter, text presentation listener, etc. (basically everything that changes the presentation of the text).\n\n\nNow to this bug: the reason is the new mixed line height support in SWT. Your code calls StyledText.setWordWrap(true) which sets the widget into variable line height mode. I think the mixed-line code in StyledText.getLinePixel(...) is wrong and causes the failure (it looks like topIndex is wrong). When I remove the call to setWordWrap(true) it works like a charm.\n\nResetting priority and milestone and moving to SWT.\n\n*** internal note to SWT: summarized steps to reproduce: ***\n1. download CDT 3.0.2 and add it to your install\n2. start your dev workspace\n3. make sure CDT along with its prereqs is part of your launch config\n4. start target using the attached workspace\n5. type a character in to the editor (dummy) and save\n6. Project \u003e Build Project\n\u003d\u003d\u003e error\n",
    "The following snippet reproduces the IAE with a similar stacktrace:\n- put o.e.equinox.common, o.e.jface, o.e.jface.text, o.e.swt \u0026 win32 fragment and o.e.text on build path\n- run snippet\n- press delete\n-\u003e IAE\n\nimport org.eclipse.swt.SWT;\nimport org.eclipse.swt.layout.FillLayout;\nimport org.eclipse.swt.widgets.Display;\nimport org.eclipse.swt.widgets.Shell;\n\nimport org.eclipse.jface.text.Document;\nimport org.eclipse.jface.text.TextViewer;\n\npublic class Snippet123824 {\n\n\tpublic static void main(String[] args) {\n\t\tDisplay display \u003d new Display();\n\t\tShell shell \u003d new Shell(display);\n\t\tshell.setLayout(new FillLayout());\n\t\tTextViewer viewer\u003d new TextViewer(shell, SWT.V_SCROLL | SWT.WRAP);\n\t\tshell.pack();\n\t\tshell.open();\n\t\t\n\t\tviewer.setDocument(new Document(\"a\\na\\n\\n\"));\n\t\tviewer.setSelectedRange(0, 4);\n\t\tviewer.revealRange(4, 0);\n\n\t\twhile (!shell.isDisposed()) {\n\t\t\tif (!display.readAndDispatch())\n\t\t\t\tdisplay.sleep();\n\t\t}\n\t\tdisplay.dispose();\n\t}\n}\n",
    "I think I\u0027ve fixed this problem back in March 17th. The stacktrace is very similar to Bug 128750 and Bug 122379.\n\nDoes it work on Eclipse 3.2 M6 ?",
    "Yes, it\u0027s fixed. Thanks!",
    "The posted snippet also works with M6. Thanks."
  ],
  "commentCreationDates": [
    "2006-01-13T20:39:30+01:00",
    "2006-01-16T17:14:39+01:00",
    "2006-01-16T20:24:27+01:00",
    "2006-01-17T07:57:52+01:00",
    "2006-01-17T14:02:54+01:00",
    "2006-01-17T14:10:01+01:00",
    "2006-01-17T14:24:18+01:00",
    "2006-01-17T15:07:45+01:00",
    "2006-01-17T15:13:48+01:00",
    "2006-01-17T15:17:59+01:00",
    "2006-01-17T15:19:04+01:00",
    "2006-01-17T15:33:53+01:00",
    "2006-01-17T15:50:57+01:00",
    "2006-01-17T17:04:34+01:00",
    "2006-02-01T16:18:32+01:00",
    "2006-02-01T16:26:07+01:00",
    "2006-02-28T11:08:46+01:00",
    "2006-03-20T11:38:23+01:00",
    "2006-04-04T19:36:42+02:00",
    "2006-04-04T19:55:06+02:00",
    "2006-04-05T09:33:36+02:00"
  ],
  "traces": [
    {
      "exceptionType": "java.lang.IllegalArgumentException",
      "message": "Argument not valid)",
      "elements": [
        {
          "method": "org.eclipse.swt.SWT.error",
          "source": "SWT.java:3283"
        },
        {
          "method": "org.eclipse.swt.SWT.error",
          "source": "SWT.java:3206"
        },
        {
          "method": "org.eclipse.swt.widgets.Synchronizer.runAsyncMessages",
          "source": "Synchronizer.java:126"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.runAsyncMessages",
          "source": "Display.java:3262"
        },
        {
          "method": "org.eclipse.swt.widgets.Display.readAndDispatch",
          "source": "Display.java:2908"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runEventLoop",
          "source": "Workbench.java:1762"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.runUI",
          "source": "Workbench.java:1726"
        },
        {
          "method": "org.eclipse.ui.internal.Workbench.createAndRunWorkbench",
          "source": "Workbench.java:397"
        },
        {
          "method": "org.eclipse.ui.PlatformUI.createAndRunWorkbench",
          "source": "PlatformUI.java:143"
        },
        {
          "method": "org.eclipse.ui.internal.ide.IDEApplication.run",
          "source": "IDEApplication.java:106"
        },
        {
          "method": "org.eclipse.core.internal.runtime.PlatformActivator$1.run",
          "source": "PlatformActivator.java:109"
        },
        {
          "method": "org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication",
          "source": "EclipseAppLauncher.java:92"
        },
        {
          "method": "org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start",
          "source": "EclipseAppLauncher.java:68"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:379"
        },
        {
          "method": "org.eclipse.core.runtime.adaptor.EclipseStarter.run",
          "source": "EclipseStarter.java:177"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke0",
          "source": "Native Method"
        },
        {
          "method": "sun.reflect.NativeMethodAccessorImpl.invoke",
          "source": "NativeMethodAccessorImpl.java:39"
        },
        {
          "method": "sun.reflect.DelegatingMethodAccessorImpl.invoke",
          "source": "DelegatingMethodAccessorImpl.java:25"
        },
        {
          "method": "java.lang.reflect.Method.invoke",
          "source": "Method.java:585"
        },
        {
          "method": "org.eclipse.core.launcher.Main.invokeFramework",
          "source": "Main.java:338"
        },
        {
          "method": "org.eclipse.core.launcher.Main.basicRun",
          "source": "Main.java:282"
        },
        {
          "method": "org.eclipse.core.launcher.Main.run",
          "source": "Main.java:977"
        },
        {
          "method": "org.eclipse.core.launcher.Main.main",
          "source": "Main.java:952"
        }
      ],
      "causedBy": {
        "exceptionType": "java.lang.IllegalArgumentException",
        "message": "Argument not valid",
        "elements": [
          {
            "method": "org.eclipse.swt.SWT.error",
            "source": "SWT.java:3267"
          },
          {
            "method": "org.eclipse.swt.SWT.error",
            "source": "SWT.java:3206"
          },
          {
            "method": "org.eclipse.swt.SWT.error",
            "source": "SWT.java:3177"
          },
          {
            "method": "org.eclipse.jface.text.DefaultDocumentAdapter.getLine",
            "source": "DefaultDocumentAdapter.java:172"
          },
          {
            "method": "org.eclipse.swt.custom.StyledTextRenderer.getTextLayout",
            "source": "StyledTextRenderer.java:643"
          },
          {
            "method": "org.eclipse.swt.custom.StyledTextRenderer.getTextLayout",
            "source": "StyledTextRenderer.java:607"
          },
          {
            "method": "org.eclipse.swt.custom.StyledTextRenderer.calculate",
            "source": "StyledTextRenderer.java:197"
          },
          {
            "method": "org.eclipse.swt.custom.StyledTextRenderer.getLineHeight",
            "source": "StyledTextRenderer.java:473"
          },
          {
            "method": "org.eclipse.swt.custom.StyledText.getLinePixel",
            "source": "StyledText.java:3620"
          },
          {
            "method": "org.eclipse.swt.custom.StyledText.handleTextChanging",
            "source": "StyledText.java:5346"
          },
          {
            "method": "org.eclipse.swt.custom.StyledText$6.textChanging",
            "source": "StyledText.java:4790"
          },
          {
            "method": "org.eclipse.jface.text.DefaultDocumentAdapter.fireTextChanging",
            "source": "DefaultDocumentAdapter.java:382"
          },
          {
            "method": "org.eclipse.jface.text.DefaultDocumentAdapter.documentAboutToBeChanged",
            "source": "DefaultDocumentAdapter.java:299"
          },
          {
            "method": "org.eclipse.jface.text.AbstractDocument.fireDocumentAboutToBeChanged",
            "source": "AbstractDocument.java:613"
          },
          {
            "method": "org.eclipse.jface.text.AbstractDocument.replace",
            "source": "AbstractDocument.java:1103"
          },
          {
            "method": "org.eclipse.jface.text.AbstractDocument.replace",
            "source": "AbstractDocument.java:1119"
          },
          {
            "method": "org.eclipse.cdt.internal.ui.buildconsole.BuildConsolePartitioner$1.run",
            "source": "BuildConsolePartitioner.java:159"
          },
          {
            "method": "org.eclipse.swt.widgets.RunnableLock.run",
            "source": "RunnableLock.java:35"
          },
          {
            "method": "org.eclipse.swt.widgets.Synchronizer.runAsyncMessages",
            "source": "Synchronizer.java:123"
          }
        ],
        "number": 0,
        "commentIndex": 0
      },
      "number": 0,
      "commentIndex": 13,
      "bugId": "123824",
      "date": "2006-01-17T17:04:34+01:00",
      "product": "Platform",
      "component": "SWT",
      "severity": "critical"
    }
  ],
  "groupId": "123824",
  "bugId": "123824",
  "date": "2006-01-13T20:39:30+01:00",
  "product": "Platform",
  "component": "SWT",
  "severity": "critical"
}