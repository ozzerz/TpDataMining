{
  "comments": [
    "In WTP 2.0, \n\n1. Create a dynamic Web project \"wp\" in an EAR \"wpEAR\". \n2. Delete \"wpEAR\" but DO NOT delete it\u0027s content.\n\nProgrammatically, create a IFacetedProject called \"wpEAR\", then when I tried to modify the faceted project to install the jst.ear v1.4 facet, I got the exception:\n\nUnable to add the follwing facets to project wpEAR: EAR.\n    org.eclipse.core.runtime.CoreException: Failed while installing EAR 1.4.\n    at\norg.eclipse.wst.common.project.facet.core.internal.FacetedProject.callDelegate(FacetedProject.java:1257)\n    at\norg.eclipse.wst.common.project.facet.core.internal.FacetedProject.modifyInternal(FacetedProject.java:369)\n    at\norg.eclipse.wst.common.project.facet.core.internal.FacetedProject.access$2(FacetedProject.java:264)\n    at\norg.eclipse.wst.common.project.facet.core.internal.FacetedProject$1.run(FacetedProject.java:249)\n    at org.eclipse.core.internal.resources.Workspace.run(Workspace.java:1737)\n    at\norg.eclipse.wst.common.project.facet.core.internal.FacetedProject.modify(FacetedProject.java:259)\n    at\norg.eclipse.jst.ws.internal.consumption.common.FacetUtils$1.run(FacetUtils.java:744)\n    at\norg.eclipse.jface.operation.ModalContext$ModalContextThread.run(ModalContext.java:113)\n    org.eclipse.core.runtime.CoreException[0]: java.lang.NullPointerException\n    at\norg.eclipse.wst.common.componentcore.internal.StructureEdit.createWorkbenchModule(StructureEdit.java:514)\n    at\norg.eclipse.wst.common.componentcore.internal.resources.VirtualComponent.create(VirtualComponent.java:248)\n    at\norg.eclipse.jst.j2ee.project.facet.EarFacetInstallDelegate.execute(EarFacetInstallDelegate.java:52)\n    at\norg.eclipse.wst.common.project.facet.core.internal.FacetedProject.callDelegate(FacetedProject.java:1218)\n    at\norg.eclipse.wst.common.project.facet.core.internal.FacetedProject.modifyInternal(FacetedProject.java:369)\n    at\norg.eclipse.wst.common.project.facet.core.internal.FacetedProject.access$2(FacetedProject.java:264)\n    at\norg.eclipse.wst.common.project.facet.core.internal.FacetedProject$1.run(FacetedProject.java:249)\n    at org.eclipse.core.internal.resources.Workspace.run(Workspace.java:1737)\n    at\norg.eclipse.wst.common.project.facet.core.internal.FacetedProject.modify(FacetedProject.java:259)\n    at\norg.eclipse.jst.ws.internal.consumption.common.FacetUtils$1.run(FacetUtils.java:744)\n    at\norg.eclipse.jface.operation.ModalContext$ModalContextThread.run(ModalContext.java:113)\n\nIs this the expected behaviour?  If so, what check should be done to see if the facet could be added (before actually trying to add it)?",
    "Which create method are you using?",
    "IFacetedProject fProject \u003d ProjectFacetsManager.create(projectName, null, shellMonitor);\nfinal Set actions \u003d getInstallActions(projectFacetVersions);  // jst.EAR 1.4\nfproject.modify(actions, shellMonitor);",
    "I see. The impl of that method opens the project like so:\n\nproject.open( IResource.BACKGROUND_REFRESH, submon( monitor, 1 ) );\n\nIt looks like the background refresh is not quite right in this context and it would be better to do a foreground refresh. I will take a look at that for 2.0.1.",
    "So what would be the expected behaviour when you do have it fix?  Would the facetedProject.modify() be able to add the EAR facet to this project (that had been deleted but the content is still there) or would it be still returning some sort of error that I\u0027ll have to handle?",
    "That depends on what\u0027s in the project. If the project had jst.ear installed before, then modify will fail. If the project had another module facet installed (such as jst.web), then the modify will also fail. Both of the failures will say that jst.ear cannot be installed, instead of the current failures where it tries to install jst.ear and fails.\n\nThe biggest difference is that after the fix, you will be able to add logic after the create that can check which facets are installed on the project and whether installing jst.ear is allowed.",
    "Hi Konstantin,\n\nWould it be possible have this problem fixed in WTP 1.5.5?  We need to handle this problem in WTP 1.5.5 where the Web services wizard is currently failing to add jst.ear to a project when that project had been deleted but the content is still there.  We would like to be able to check which facets are installed on the project and whether installing jst.ear is allowed.  Thanks!\n",
    "Hi Konstantin,\n\nI would like to clarify the expected behaviour of this scenario once you\u0027ve made the fix.  You indicated that if the project had jst.ear or another module facet (such as jst.web) installed before, then modify will fail. I don\u0027t know the detail of the code that cause the modify to fail in this case.  However, I do noticed that if I delete a dynamic Web project without deleting it\u0027s content, then if I tried to add the jst.web and jst.java facet to the same project, it would be successful.  I would like to find out the reason why there would be a difference in behaviour when adding jst.web to a project that already has the facet and when adding jst.ear to a project that already has the facet.  Would it be possible to let the user add jst.ear to a project that already has the facet (e.g. have the facet install code figure out that what it\u0027s being requested to add is already there and just return)?  Or do I still need to explicitely check which facets are installed on the project and\nwhether installing jst.ear is allowed before attempting to add the jst.ear facet?\n",
    "The api is designed to prevent attempts to re-install the same facet rather than treating the operation as a no-op. Due to a bug in the refresh logic, the internals are not noticing that some facets are already present and are allowing facet install logic to run. At that point, whether facet install fails or not is facet-specific. \n\nHow critical is it to port this fix to 1.5.5? This seems to be a pretty corner case...",
    "Fix released into 2.0.1 and 3.0 code streams. Also added a unit test to cover this scenario. Let me know if it\u0027s critical to back-port this to 1.5.5.",
    "It\u0027s OK.  I\u0027ve implemented a workaround to bypass this problem in WTP 1.5.5.  So fixing it in WTP 2.0.1 and HEAD is fine.\n\nIs there a specific API I should call to check if the jst.EAR facet could be added to the faceted project?",
    "Verified and closing."
  ],
  "commentCreationDates": [
    "2007-06-29T21:33:29+02:00",
    "2007-06-29T21:37:36+02:00",
    "2007-06-29T21:45:29+02:00",
    "2007-06-29T21:50:07+02:00",
    "2007-06-29T21:52:50+02:00",
    "2007-06-29T21:58:11+02:00",
    "2007-07-19T17:20:33+02:00",
    "2007-07-20T14:10:32+02:00",
    "2007-07-24T01:03:35+02:00",
    "2007-07-24T01:55:56+02:00",
    "2007-07-25T19:50:10+02:00",
    "2007-09-11T18:08:26+02:00"
  ],
  "traces": [
    {
      "exceptionType": "org.eclipse.core.runtime.CoreException",
      "message": "Failed while installing EAR 1.4.",
      "elements": [
        {
          "method": "org.eclipse.wst.common.project.facet.core.internal.FacetedProject.callDelegate",
          "source": "FacetedProject.java:1257"
        },
        {
          "method": "org.eclipse.wst.common.project.facet.core.internal.FacetedProject.modifyInternal",
          "source": "FacetedProject.java:369"
        },
        {
          "method": "org.eclipse.wst.common.project.facet.core.internal.FacetedProject.access$2",
          "source": "FacetedProject.java:264"
        },
        {
          "method": "org.eclipse.wst.common.project.facet.core.internal.FacetedProject$1.run",
          "source": "FacetedProject.java:249"
        },
        {
          "method": "org.eclipse.core.internal.resources.Workspace.run",
          "source": "Workspace.java:1737"
        },
        {
          "method": "org.eclipse.wst.common.project.facet.core.internal.FacetedProject.modify",
          "source": "FacetedProject.java:259"
        },
        {
          "method": "org.eclipse.jst.ws.internal.consumption.common.FacetUtils$1.run",
          "source": "FacetUtils.java:744"
        },
        {
          "method": "org.eclipse.jface.operation.ModalContext$ModalContextThread.run",
          "source": "ModalContext.java:113"
        }
      ],
      "number": 0,
      "commentIndex": 0,
      "bugId": "194961",
      "date": "2007-06-29T21:33:29+02:00",
      "product": "Web Tools",
      "component": "wst.common",
      "severity": "normal"
    },
    {
      "exceptionType": "java.lang.NullPointerException",
      "elements": [
        {
          "method": "org.eclipse.wst.common.componentcore.internal.StructureEdit.createWorkbenchModule",
          "source": "StructureEdit.java:514"
        },
        {
          "method": "org.eclipse.wst.common.componentcore.internal.resources.VirtualComponent.create",
          "source": "VirtualComponent.java:248"
        },
        {
          "method": "org.eclipse.jst.j2ee.project.facet.EarFacetInstallDelegate.execute",
          "source": "EarFacetInstallDelegate.java:52"
        },
        {
          "method": "org.eclipse.wst.common.project.facet.core.internal.FacetedProject.callDelegate",
          "source": "FacetedProject.java:1218"
        },
        {
          "method": "org.eclipse.wst.common.project.facet.core.internal.FacetedProject.modifyInternal",
          "source": "FacetedProject.java:369"
        },
        {
          "method": "org.eclipse.wst.common.project.facet.core.internal.FacetedProject.access$2",
          "source": "FacetedProject.java:264"
        },
        {
          "method": "org.eclipse.wst.common.project.facet.core.internal.FacetedProject$1.run",
          "source": "FacetedProject.java:249"
        },
        {
          "method": "org.eclipse.core.internal.resources.Workspace.run",
          "source": "Workspace.java:1737"
        },
        {
          "method": "org.eclipse.wst.common.project.facet.core.internal.FacetedProject.modify",
          "source": "FacetedProject.java:259"
        },
        {
          "method": "org.eclipse.jst.ws.internal.consumption.common.FacetUtils$1.run",
          "source": "FacetUtils.java:744"
        },
        {
          "method": "org.eclipse.jface.operation.ModalContext$ModalContextThread.run",
          "source": "ModalContext.java:113"
        }
      ],
      "number": 1,
      "commentIndex": 0,
      "bugId": "194961",
      "date": "2007-06-29T21:33:29+02:00",
      "product": "Web Tools",
      "component": "wst.common",
      "severity": "normal"
    }
  ],
  "groupId": "194961",
  "bugId": "194961",
  "date": "2007-06-29T21:33:29+02:00",
  "product": "Web Tools",
  "component": "wst.common",
  "severity": "normal"
}